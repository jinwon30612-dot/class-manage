<!DOCTYPE html>
<html lang="ko">
<head>
        <!-- Safari ë° êµ¬ë²„ì „ ë¸Œë¼ìš°ì € í˜¸í™˜ì„± í´ë¦¬í•„ -->
        <script src="https://cdn.jsdelivr.net/npm/es6-promise/dist/es6-promise.auto.min.js"></script>
        <script src="https://cdn.jsdelivr.net/npm/whatwg-fetch@3.6.2/dist/fetch.umd.min.js"></script>
        <script>
        if (!window.crypto || !window.crypto.randomUUID) {
            window.crypto = window.crypto || {};
            window.crypto.randomUUID = function() {
                return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                    var r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                    return v.toString(16);
                });
            };
        }
        </script>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>ìœ¡ê°œì¥ë°˜ í•™ê¸‰ ìš´ì˜ ì‹œìŠ¤í…œ</title>
    <!-- Tailwind CSS CDN -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Font Awesome for icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <!-- Google Fonts for Notice Board -->
    <link href="https://fonts.googleapis.com/css2?family=Gothic+A1&family=Nanum+Gothic+Coding&family=Noto+Sans+KR:wght@400;700&display=swap" rel="stylesheet">

    <!-- Firebase SDKs -->
<script>
function toKey(value) {
    if (typeof value === 'string') return value;
    if (typeof value === 'number' || typeof value === 'boolean') return String(value);
    if (value === null) return 'null';
    if (value === undefined) return 'undefined';
    return String(value);
}
</script>
<script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";

        // XSS ë°©ì§€ìš© escape í•¨ìˆ˜ (ì „ì—­ windowì— í• ë‹¹)
        function escapeHtml(str) {
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#39;');
        }
        window.escapeHtml = escapeHtml;
        import { getAuth, signOut, onAuthStateChanged, signInAnonymously, signInWithCustomToken,
                 createUserWithEmailAndPassword, signInWithEmailAndPassword, setPersistence, browserLocalPersistence// ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì¸ì¦ì„ ìœ„í•œ í•¨ìˆ˜ ì¶”ê°€
               } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc, onSnapshot, collection, query, where, addDoc, getDocs, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Replace with your actual Firebase config from Step 1
        // If you are running this in a Canvas environment, __firebase_config will be provided.
        // Otherwise, replace the empty string with your copied firebaseConfig JSON string.
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
            apiKey: "AIzaSyAjOJxtGB6blMutVGABA2Xn7ec4Rnn9ec4", // <-- ì—¬ê¸°ì— ì‹¤ì œ API í‚¤ë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
            authDomain: "class-manage-fa3b8.firebaseapp.com", // <-- ì—¬ê¸°ì— ì‹¤ì œ Auth Domainì„ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
           projectId: "class-manage-fa3b8", // <-- ì—¬ê¸°ì— ì‹¤ì œ Project IDë¥¼ ë¶™ì—¬ë„£ìœ¼ì„¸ìš”
            storageBucket: "class-manage-fa3b8.appspot.com",
            messagingSenderId: "1004633319052",
            appId: "1:1004633319052:web:106a88dcdd4c3c40c5fda9",
            measurementId: "G-MXZDD6WDGT"
        };

        // IMPORTANT: The app ID for Firestore data partitioning.
        // If you are running this in a Canvas environment, __app_id will be provided.
        // Otherwise, you can set a default value or generate one.
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-class-management-app';

        // Firebase Service Instances
        let app;
        let auth;
        let db;
        let userId = null; // Stores the current authenticated user's ID
        let currentLoadedDataId = null; // Stores the ID of the data currently loaded into appData

        // Global timeout ID for debouncing save operations
        let saveTimeoutId = null;

        // D-Day ê¸°ëŠ¥: ì¼ì • ë°ì´í„°ì—ì„œ D-Day ì§€ì • ë° í‘œì‹œ
        function getAllFutureCalendarEvents() {
            const now = new Date();
            const calendar = window.appData && window.appData.calendar ? window.appData.calendar : {};
            let events = [];
            for (const key in calendar) {
                const arr = Array.isArray(calendar[key]) ? calendar[key] : [calendar[key]];
                arr.forEach(ev => {
                    // ë‚ ì§œ íŒŒì‹±
                    const [y, m, d] = key.split('-').map(Number);
                    const eventDate = new Date(y, m-1, d);
                    if (eventDate >= now) {
                        events.push({ ...ev, date: eventDate, key });
                    }
                });
            }
            return events;
        }

        function getDdayEventKey() {
            return window.appData && window.appData.ddayEventKey ? window.appData.ddayEventKey : null;
        }
        function setDdayEventKey(key) {
            window.appData.ddayEventKey = key;
            if (typeof debouncedSaveAppData === 'function') debouncedSaveAppData();
        }

        function updateDdayDisplay() {
            const ddayDisplay = document.getElementById('dday-display');
            const ddayKey = getDdayEventKey();
            if (!ddayKey) { ddayDisplay.style.display = 'none'; return; }
            const [y, m, d] = ddayKey.split('-').map(Number);
            const eventDate = new Date(y, m-1, d);
            const now = new Date();
            const diff = eventDate - now;
            const days = Math.ceil(diff / (1000*60*60*24));
            if (days < 0) { ddayDisplay.style.display = 'none'; return; }
            // ì¼ì • ì œëª© ê°€ì ¸ì˜¤ê¸°
            let title = '';
            const calendar = window.appData && window.appData.calendar ? window.appData.calendar : {};
            const arr = Array.isArray(calendar[ddayKey]) ? calendar[ddayKey] : [calendar[ddayKey]];
            if (arr && arr[0] && arr[0].title) title = arr[0].title;
                if (title) {
                    ddayDisplay.textContent = `${title}ê¹Œì§€\n${days === 0 ? 'ì˜¤ëŠ˜' : days + 'ì¼'} ë‚¨ìŒ`;
                } else {
                    ddayDisplay.textContent = `${y}-${String(m).padStart(2,'0')}-${String(d).padStart(2,'0')}ê¹Œì§€\n${days === 0 ? 'ì˜¤ëŠ˜' : days + 'ì¼'} ë‚¨ìŒ`;
                }
            ddayDisplay.style.display = '';
        }


        // D-Day ê´€ë¦¬ ëª¨ë‹¬ í‘œì‹œ
        function openDdayModal() {
            const modal = document.getElementById('dday-modal');
            const list = document.getElementById('dday-list');
            list.innerHTML = '';
            const events = getAllFutureCalendarEvents().sort((a,b)=>a.date-b.date);
            const ddayKey = getDdayEventKey();
            if (events.length === 0) {
                list.innerHTML = '<div class="text-gray-500">ë“±ë¡ëœ ë¯¸ë˜ ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</div>';
            } else {
                events.forEach(ev => {
                    const isDday = ev.key === ddayKey;
                    const btn = document.createElement('button');
                    btn.className = `w-full text-left px-3 py-2 rounded border flex items-center justify-between ${isDday ? 'bg-yellow-100 border-yellow-400 font-bold' : 'bg-gray-100 border-gray-300'}`;
                    btn.innerHTML = `<span>${ev.date.getFullYear()}-${String(ev.date.getMonth()+1).padStart(2,'0')}-${String(ev.date.getDate()).padStart(2,'0')} : ${ev.title || '(ì œëª©ì—†ìŒ)'}</span>` +
                        `<span class="text-xs ml-2">${isDday ? 'D-DAY ì§€ì •ë¨' : 'D-DAYë¡œ ì§€ì •'}</span>`;
                    btn.onclick = () => {
                        setDdayEventKey(isDday ? null : ev.key);
                        updateDdayDisplay();
                        openDdayModal();
                    };
                    list.appendChild(btn);
                });
            }
            modal.style.display = 'flex';
        }
        function closeDdayModal() {
            document.getElementById('dday-modal').style.display = 'none';
        }

        // D-Day ê´€ë¦¬ ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°
    // ìë¦¬ë°°ì¹˜ ê´€ë ¨ ì½”ë“œ ì „ì²´ ì‚­ì œë¨

        // ì¼ì • ì¶”ê°€/ìˆ˜ì •/ì‚­ì œ ì‹œ D-Day í‘œì‹œ ê°±ì‹ 
        window.updateDdayDisplay = updateDdayDisplay;

        // Initialize Firebase and set up authentication listener
async function setupFirebaseAuthAndFirestore() {
    try {
    app = initializeApp(firebaseConfig);
    auth = getAuth(app);
    window.auth = auth; // window.authë¡œ í• ë‹¹í•˜ì—¬ ê¸€ë¡œë²Œ ì ‘ê·¼ ê°€ëŠ¥í•˜ê²Œ

        // ğŸ”¹ ë¡œê·¸ì¸ ìœ ì§€ ì„¤ì • ê°•í™”
        await setPersistence(auth, browserLocalPersistence);

        db = getFirestore(app);

        // ğŸ”¹ ê°œì„ ëœ ì´ˆê¸° ë¡œê·¸ì¸ ë¡œì§
        if (typeof __initial_auth_token !== 'undefined') {
            await signInWithCustomToken(auth, __initial_auth_token);
            console.log("Signed in with custom token.");
        } else {
            // âœ… ê¸°ì¡´ ì„¸ì…˜ í™•ì¸ë§Œ í•˜ê³  ê°•ì œ ìµëª… ë¡œê·¸ì¸ ì œê±°
            console.log("Checking for existing authentication session...");
        }

        // ğŸ”¹ ì¸ì¦ ìƒíƒœ ë³€ê²½ ë¦¬ìŠ¤ë„ˆ (ê°œì„ ë¨)
        onAuthStateChanged(auth, async (user) => {
            if (user) {
                userId = user.uid;
                currentLoadedDataId = userId;
                console.log("User is signed in:", userId);

                // ì‚¬ìš©ì ì •ë³´ í‘œì‹œ ê°œì„ 
                let authStatusText = `ë¡œê·¸ì¸ë¨: ${userId.substring(0, 8)}...`;
                if (user.email) {
                    authStatusText = `ë¡œê·¸ì¸ë¨: ${user.email}`;
                } else if (user.isAnonymous) {
                    authStatusText = `ìµëª… ì‚¬ìš©ì: ${userId.substring(0, 8)}...`;
                }
                
                document.getElementById('auth-status-settings').textContent = authStatusText;

                // í—¤ë” ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ í‘œì‹œ
                const headerLogoutBtn = document.getElementById('logout-btn');
                if (headerLogoutBtn) {
                    headerLogoutBtn.classList.remove('hidden');
                }

                // ì‚¬ìš©ì ID í‘œì‹œ
                document.getElementById('current-auth-id-display-settings').textContent = `í˜„ì¬ ì¸ì¦ ID: ${userId}`;
                document.getElementById('current-auth-id-display-settings').classList.remove('hidden');
                document.getElementById('loaded-data-id-display-settings').textContent = `ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ID: ${currentLoadedDataId}`;
                document.getElementById('loaded-data-id-display-settings').classList.remove('hidden');

                // ë°ì´í„° ë¡œë“œ ë° UI ì´ˆê¸°í™”ëŠ” loadDataFromFirestore ë‚´ë¶€ì—ì„œ ì²˜ë¦¬
                await loadDataFromFirestore(userId);
                
                // âœ… ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ë©”ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                if (appData.currentSection === 'authSection') {
                    showSection('assignmentCheck', true);
                }
                
            } else {
                // ğŸ”¹ ë¡œê·¸ì•„ì›ƒ ìƒíƒœ ì²˜ë¦¬ ê°œì„ 
                userId = null;
                currentLoadedDataId = null;
                console.log("No user is signed in.");
                
                document.getElementById('auth-status-settings').textContent = 'ë¡œê·¸ì¸ í•„ìš”';

                const headerLogoutBtn = document.getElementById('logout-btn');
                if (headerLogoutBtn) {
                    headerLogoutBtn.classList.add('hidden');
                }

                document.getElementById('current-auth-id-display-settings').classList.add('hidden');
                document.getElementById('loaded-data-id-display-settings').classList.add('hidden');

                // ê¸°ë³¸ ë°ì´í„°ë¡œ ì´ˆê¸°í™”
                appData = {
                    settings: {
                        headerTitle: 'ìœ¡ê°œì¥ë°˜ í•™ê¸‰ ìš´ì˜ ì‹œìŠ¤í…œ',
                        footerText: 'Â© 2025 ìœ¡ê°œì¥ë°˜',
                        lunchTimer: { startTime: '12:20', endTime: '13:10' },
                        currentTheme: 'default'
                    },
                    students: [],
                    assignments: [],
                    dailyAssignments: {},
                    assignmentHistory: {},
                    notice: { content: '', fontFamily: 'Inter', fontSize: 30, lastSavedDate: '' },
                    memos: [],
                    lottery: { studentHistory: [], numberHistory: [], pickedStudents: [], pickedNumbers: [] },
                    evaluations: [],
                    attendance: {},
                    currentAttendanceMonth: '',
                    noClassDays: {},
                    currentSection: 'authSection'
                };
                
                renderAllUI();
                showSection('authSection', true); // ë¡œê·¸ì¸ í™”ë©´ìœ¼ë¡œ ì´ë™
                showCustomAlert('ì•ˆì „í•œ ë°ì´í„° ì €ì¥ì„ ìœ„í•´ ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ë¡œ ë¡œê·¸ì¸í•´ì£¼ì„¸ìš”.');
            }
        });

    } catch (error) {
        console.error("Error initializing Firebase or signing in:", error);
        showCustomAlert("Firebase ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.");
    }
}

        // Firebase Logout
        async function signOutUser() {
            try {
                await signOut(auth);
                console.log("User signed out.");
                // onAuthStateChanged listener will handle UI updates and data clearing
            } catch (error) {
                console.error("Error during sign out:", error);
                showCustomAlert("ë¡œê·¸ì•„ì›ƒ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤: " + error.message);
            }
        }

        // Firebase Email/Password Sign Up
async function signUpWithEmailPassword() {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (!email || !password) {
        showCustomAlert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }
    if (password.length < 6) {
        showCustomAlert("ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.");
        return;
    }

    try {
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        signupBtn.disabled = true;
        signupBtn.textContent = "ê°€ì… ì¤‘...";
        
        const userCredential = await createUserWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        console.log("íšŒì›ê°€ì… ì„±ê³µ:", user.uid);
        
        showCustomAlert("íšŒì›ê°€ì… ë° ë¡œê·¸ì¸ ì„±ê³µ!");
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        emailInput.value = '';
        passwordInput.value = '';
        
    } catch (error) {
        console.error("íšŒì›ê°€ì… ì‹¤íŒ¨:", error);
        let errorMessage = "íšŒì›ê°€ì…ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        
        switch(error.code) {
            case 'auth/email-already-in-use':
                errorMessage = "ì´ë¯¸ ì‚¬ìš© ì¤‘ì¸ ì´ë©”ì¼ ì£¼ì†Œì…ë‹ˆë‹¤.";
                break;
            case 'auth/invalid-email':
                errorMessage = "ìœ íš¨í•˜ì§€ ì•Šì€ ì´ë©”ì¼ ì£¼ì†Œ í˜•ì‹ì…ë‹ˆë‹¤.";
                break;
            case 'auth/weak-password':
                errorMessage = "ë¹„ë°€ë²ˆí˜¸ëŠ” 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.";
                break;
            case 'auth/network-request-failed':
                errorMessage = "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
                break;
        }
        showCustomAlert(errorMessage);
    } finally {
        // ë¡œë”© ìƒíƒœ í•´ì œ
        signupBtn.disabled = false;
        signupBtn.textContent = "íšŒì›ê°€ì…";
    }
}

        // Firebase Email/Password Sign In
async function signInWithEmailPassword() {
    const email = emailInput.value.trim();
    const password = passwordInput.value.trim();

    if (!email || !password) {
        showCustomAlert("ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.");
        return;
    }

    try {
        // ë¡œë”© ìƒíƒœ í‘œì‹œ
        signinBtn.disabled = true;
        signinBtn.textContent = "ë¡œê·¸ì¸ ì¤‘...";
        
        const userCredential = await signInWithEmailAndPassword(auth, email, password);
        const user = userCredential.user;
        console.log("ë¡œê·¸ì¸ ì„±ê³µ:", user.uid);
        
        // ğŸ”¹ ë¡œê·¸ì¸ ì„±ê³µ ì‹œ ìë™ìœ¼ë¡œ ë©”ì¸ í™”ë©´ ì´ë™
        showCustomAlert("ë¡œê·¸ì¸ ì„±ê³µ!");
        
        // ì…ë ¥ í•„ë“œ ì´ˆê¸°í™”
        emailInput.value = '';
        passwordInput.value = '';
        
    } catch (error) {
        console.error("ë¡œê·¸ì¸ ì‹¤íŒ¨:", error);
        let errorMessage = "ë¡œê·¸ì¸ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.";
        
        switch(error.code) {
            case 'auth/invalid-email':
            case 'auth/user-not-found':
                errorMessage = "ë“±ë¡ë˜ì§€ ì•Šì€ ì´ë©”ì¼ì´ê±°ë‚˜ ì˜ëª»ëœ ì´ë©”ì¼ í˜•ì‹ì…ë‹ˆë‹¤.";
                break;
            case 'auth/wrong-password':
            case 'auth/invalid-credential':
                errorMessage = "ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.";
                break;
            case 'auth/too-many-requests':
                errorMessage = "ë¡œê·¸ì¸ ì‹œë„ íšŸìˆ˜ê°€ ë„ˆë¬´ ë§ìŠµë‹ˆë‹¤. ì ì‹œ í›„ ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.";
                break;
            case 'auth/network-request-failed':
                errorMessage = "ë„¤íŠ¸ì›Œí¬ ì—°ê²°ì„ í™•ì¸í•´ì£¼ì„¸ìš”.";
                break;
        }
        showCustomAlert(errorMessage);
    } finally {
        // ë¡œë”© ìƒíƒœ í•´ì œ
        signinBtn.disabled = false;
        signinBtn.textContent = "ë¡œê·¸ì¸";
    }
}

        // Debounced function to save appData to Firestore
        function debouncedSaveAppData() {
            clearTimeout(saveTimeoutId);
            saveTimeoutId = setTimeout(async () => {
                await saveDataToFirestore();
            }, 500); // Save after 500ms of inactivity
        }

        // Save data to Firestore (always saves to the current<ly au>thenticated userId)
        async function saveDataToFirestore() {
            if (!userId) {
                console.warn("No authenticated user ID available to save data to Firestore. Data will only be saved locally.");
                saveDataToLocalStorageBackup(); // Fallback to local storage
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/appData/current`); // Use authenticated userId
                await setDoc(docRef, appData);
                console.log("Data saved to Firestore successfully for user:", userId);
                saveDataToLocalStorageBackup(); // Also save to local storage as a backup/cache
            } catch (e) {
                console.error("Error saving data to Firestore:", e);
                showCustomAlert("í´ë¼ìš°ë“œ ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
            }
        }

        // Load data from Firestore (can load from a specific targetUserId)
        async function loadDataFromFirestore(targetUserId = userId) { // Default to authenticated userId
            if (!targetUserId) {
                console.warn("No target user ID available to load data from Firestore. Loading from local storage.");
                loadDataFromLocalStorageBackup();
                return;
            }

            const docRef = doc(db, `artifacts/${appId}/users/${targetUserId}/appData/current`);
            try {
                const docSnap = await getDoc(docRef);

                if (docSnap.exists()) {
                    const cloudData = docSnap.data();
                    // Merge loaded data with default appData to handle new properties gracefully
                    appData = { ...appData, ...cloudData };
                    // ì¼ì •(calendar) ë§ˆì´ê·¸ë ˆì´ì…˜: ê° ë‚ ì§œë³„ ê°’ì´ ë°°ì—´ì´ ì•„ë‹ˆë©´ ë°°ì—´ë¡œ ë³€í™˜ (ê¸°ì¡´ calendarì™€ ë³‘í•©)
                    if (cloudData.calendar && typeof cloudData.calendar === 'object') {
                        appData.calendar = appData.calendar || {};
                        for (const key in cloudData.calendar) {
                            const val = cloudData.calendar[key];
                            appData.calendar[key] = Array.isArray(val) ? val : [val];
                        }
                    }
                    currentLoadedDataId = targetUserId; // Update the loaded data ID display
                    document.getElementById('loaded-data-id-display-settings').textContent = `ë¶ˆëŸ¬ì˜¨ ë°ì´í„° ID: ${currentLoadedDataId}`;
                    console.log("Data loaded from Firestore for user:", targetUserId);
                    saveDataToLocalStorageBackup(); // Update local storage with cloud data
                    // window.appDataì™€ calendarë¥¼ ëª…ì‹œì ìœ¼ë¡œ ë™ê¸°í™”
                    window.appData = appData;
                    window.appData.calendar = appData.calendar;
                    // ë°ì´í„° ë™ê¸°í™” í›„ UI ë Œë”ë§
                    if (typeof initializeUIAndData === 'function') initializeUIAndData();
                } else {
                    console.log("No data found in Firestore for user:", targetUserId);
                    // If no cloud data, check local storage for existing data (migration scenario)
                    const localData = localStorage.getItem('classManagementAppData');
                    if (localData) {
                        const parsedLocalData = JSON.parse(localData);
                        // Confirm migration
                        const confirmMigrate = await showCustomAlert('ì´ì „ì— ì €ì¥ëœ ë¡œì»¬ ë°ì´í„°ê°€ ìˆìŠµë‹ˆë‹¤. í´ë¼ìš°ë“œì— ì—…ë¡œë“œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? (ì·¨ì†Œ ì‹œ ë¡œì»¬ ë°ì´í„°ëŠ” ìœ ì§€ë©ë‹ˆë‹¤)', true);
                        if (confirmMigrate) {
                            appData = { ...appData, ...parsedLocalData }; // Load local data into appData
                            await saveDataToFirestore(); // Save local data to Firestore (to current authenticated user)
                            showCustomAlert('ë¡œì»¬ ë°ì´í„°ê°€ í´ë¼ìš°ë“œë¡œ ì„±ê³µì ìœ¼ë¡œ ì—…ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
                        } else {
                            // User chose not to migrate, keep local data for this session
                            appData = { ...appData, ...parsedLocalData };
                            showCustomAlert('ë¡œì»¬ ë°ì´í„°ê°€ ìœ ì§€ë©ë‹ˆë‹¤. í´ë¼ìš°ë“œì—ëŠ” ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                        }
                    } else {
                        console.log("No local data found either. Using default appData.");
                    }
                }
                // renderAllUI(); // Render UI after data is loaded/migrated - moved to initializeUIAndData
            } catch (e) {
                console.error("Error loading data from Firestore:", e);
                showCustomAlert("í´ë¼ìš°ë“œ ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì¸í„°ë„· ì—°ê²°ì„ í™•ì¸í•˜ê±°ë‚˜ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.");
                loadDataFromLocalStorageBackup(); // Fallback to local storage if Firestore fails
                renderAllUI(); // Render UI with local data
            }
        }

        // Function to load data by an arbitrary anonymous ID
        async function loadDataByAnonymousId() {
            const enteredId = document.getElementById('anonymous-id-input').value.trim();
            if (!enteredId) {
                showCustomAlert('ë¶ˆëŸ¬ì˜¬ ìµëª… IDë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!userId) {
                // If not even anonymous user is logged in, sign in anonymously first
                await signInAnonymously(auth);
                // The onAuthStateChanged listener will then handle loading data for the newly signed in anonymous user.
                // We then need to re-call this function to load data for the entered ID.
                // This is a bit complex, so for simplicity, we'll assume an anonymous user is always logged in.
                showCustomAlert('ë¨¼ì € ìµëª…ìœ¼ë¡œ ë¡œê·¸ì¸ë©ë‹ˆë‹¤. ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
                return;
            }

            const confirmLoad = await showCustomAlert(`'${enteredId}' IDì˜ ë°ì´í„°ë¥¼ ë¶ˆëŸ¬ì˜¤ì‹œê² ìŠµë‹ˆê¹Œ? í˜„ì¬ ë¡œê·¸ì¸ëœ ID(${userId})ë¡œ ì €ì¥ë©ë‹ˆë‹¤.`, true);
            if (confirmLoad) {
                await loadDataFromFirestore(enteredId);
                renderAllUI(); // Re-render UI with the newly loaded data
                showCustomAlert(`'${enteredId}' IDì˜ ë°ì´í„°ë¥¼ ì„±ê³µì ìœ¼ë¡œ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤. ì €ì¥ ì‹œ í˜„ì¬ ì¸ì¦ ID(${userId})ë¡œ ì €ì¥ë©ë‹ˆë‹¤.`);
            }
        }


        // Make these functions globally accessible for the main script
        window.signOutUser = signOutUser;
        window.saveDataToFirestore = saveDataToFirestore; // Expose for other parts of the app
        window.loadDataFromFirestore = loadDataFromFirestore; // Expose for other parts of the app
        window.setupFirebaseAuthAndFirestore = setupFirebaseAuthAndFirestore; // Expose to global scope
        window.loadDataByAnonymousId = loadDataByAnonymousId; // Expose new function

        window.signUpWithEmailPassword = signUpWithEmailPassword;
        window.signInWithEmailPassword = signInWithEmailPassword;
        window.debouncedSaveAppData = debouncedSaveAppData;

        // ë¡œê·¸ì¸/íšŒì›ê°€ì… ë²„íŠ¼ ì´ë²¤íŠ¸ ì—°ê²°ì„ DOMContentLoadedì—ì„œ window ë²”ìœ„ í•¨ìˆ˜ë¡œ ì§ì ‘ ì—°ê²°
        document.addEventListener('DOMContentLoaded', () => {
            const signupBtn = document.getElementById('signup-btn');
            const signinBtn = document.getElementById('signin-btn');
            if (signupBtn) signupBtn.addEventListener('click', window.signUpWithEmailPassword);
            if (signinBtn) signinBtn.addEventListener('click', window.signInWithEmailPassword);
        });


        // Original saveDataToLocalStorage renamed to saveDataToLocalStorageBackup
        function saveDataToLocalStorageBackup() {
            try {
                localStorage.setItem('classManagementAppData', JSON.stringify(appData));
                console.log('Data saved to Local Storage (backup).');
            } catch (e) {
                console.error('Error saving data to Local Storage (backup):', e);
                showCustomAlert('ë¡œì»¬ ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì €ì¥ ê³µê°„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        };

        // Original loadDataFromLocalStorage renamed to loadDataFromLocalStorageBackup
        function loadDataFromLocalStorageBackup() {
            try {
                const storedData = localStorage.getItem('classManagementAppData');
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    // Merge loaded data with default appData to handle new properties gracefully
                    appData = { ...appData, ...parsedData };
                    console.log('Data loaded from Local Storage (fallback).');
                } else {
                    console.log('No data found in Local Storage (fallback). Using default appData.');
                }
            } catch (e) {
                console.error('Error loading data from Local Storage (fallback):', e);
                showCustomAlert('ë¡œì»¬ ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì €ì¥ ê³µê°„ì„ í™•ì¸í•˜ê±°ë‚˜ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        };
        document.addEventListener('keydown', (e) => {
            // ì—¬ëŸ¬ ëª¨ë‹¬ì´ ë™ì‹œì— ì—´ë ¤ ìˆì„ ìˆ˜ ìˆìœ¼ë¯€ë¡œ, ê°€ì¥ ë§ˆì§€ë§‰(ìœ„ì— ë³´ì´ëŠ”) ëª¨ë‹¬ì„ ì°¾ìŒ
            const modals = Array.from(document.querySelectorAll('.modal[style*="display: flex"]'));
            const activeModal = modals.length > 0 ? modals[modals.length - 1] : null;
            // customModalOverlayë„ ëª¨ë‹¬ë¡œ ê°„ì£¼
            const customModalOverlay = document.getElementById('customModalOverlay');
            const isCustomModalOpen = customModalOverlay && !customModalOverlay.classList.contains('hidden');

            if (activeModal || isCustomModalOpen) {
                // Esc í‚¤ë¡œ ëª¨ë‹¬ ë‹«ê¸°
                if (e.key === 'Escape') {
                    if (isCustomModalOpen) {
                        const cancelBtn = document.getElementById('modalCancelBtn');
                        if (cancelBtn && !cancelBtn.classList.contains('hidden')) {
                            cancelBtn.click();
                        }
                    } else if (activeModal) {
                        const confirmCancelBtn = activeModal.querySelector('#custom-alert-cancel-btn');
                        if (confirmCancelBtn && !confirmCancelBtn.classList.contains('hidden')) {
                            confirmCancelBtn.click();
                        } else {
                            const closeButton = activeModal.querySelector('.close-button');
                            if (closeButton) {
                                closeButton.click();
                            } else {
                                if (activeModal.id === 'custom-alert-modal') {
                                    activeModal.style.display = 'none';
                                }
                            }
                        }
                    }
                }
                // Enter í‚¤ë¡œ ëª¨ë‹¬ ë‚´ í™•ì¸ ë²„íŠ¼ í´ë¦­ (ì…ë ¥ì°½ í¬ì»¤ìŠ¤ ì—¬ë¶€ì™€ ë¬´ê´€í•˜ê²Œ)
                else if (e.key === 'Enter') {
                    if (isCustomModalOpen) {
                        const confirmBtn = document.getElementById('modalConfirmBtn');
                        if (confirmBtn) {
                            confirmBtn.click();
                            e.preventDefault();
                        }
                    } else if (activeModal) {
                        let confirmButton = activeModal.querySelector('.btn-primary:not(.hidden), .btn-accent:not(.hidden), .custom-alert-ok-btn');
                        if (!confirmButton && activeModal.id === 'custom-alert-modal') {
                            confirmButton = activeModal.querySelector('button');
                        }
                        if (confirmButton) {
                            confirmButton.click();
                            e.preventDefault();
                        }
                    }
                }
            }
        });
        // Call Firebase setup when DOM is ready
        document.addEventListener('DOMContentLoaded', setupFirebaseAuthAndFirestore);
    </script>
    <style>
@media (max-width: 430px) {
  header {
    padding: 0.4rem 0.7rem !important;
  }
  #header-title-display {
    font-size: 1.05rem !important;
  }
  #header-title-edit {
    font-size: 0.95rem !important;
    width: 100px !important;
    padding: 0.2rem 0.4rem !important;
  }
  .flex.items-center.space-x-2 > * {
    font-size: 0.92rem !important;
  }
  #logout-btn {
    padding: 0.18rem 0.5rem !important;
    font-size: 0.8rem !important;
  }
}
        /* ëª¨ë°”ì¼ ë„¤ë¹„ê²Œì´ì…˜ ë°” ê°€ë¡œ ìŠ¤í¬ë¡¤ ìµœì í™” */
#main-navbar {
  position: relative;
  z-index: 20;
    background-color: var(--header-bg, #2563eb); /* í—¤ë”ì™€ ë™ì¼í•˜ê²Œ */
}
#main-navbar::-webkit-scrollbar {
  height: 6px;
}
#main-navbar {
  scrollbar-width: thin;
  scrollbar-color: #bdbdbd #f5f5f5;
}
#main-navbar .nav-button {
  min-width: 90px;
  font-size: 1rem;
  flex: 0 0 auto;
}
@media (max-width: 600px) {
  #main-navbar .nav-button {
    font-size: 0.95rem;
    padding-left: 0.7rem;
    padding-right: 0.7rem;
    min-width: 80px;
  }
  #main-navbar .flex-nowrap {
    gap: 0.5rem;
  }
}
        :root {
            --header-bg: #2563eb;
            --primary-btn-bg: #3b82f6;
            --primary-btn-hover-bg: #2563eb;
            --body-bg: #f0f4f8;
        }
        /* í…Œë§ˆë³„ ë³€ìˆ˜ ì •ì˜ */
        body.theme-light {
            --header-bg: #2563eb;
            --primary-btn-bg: #3b82f6;
            --primary-btn-hover-bg: #2563eb;
            --body-bg: #f0f4f8;
        }
        body.theme-dark {
            --header-bg: #222831;
            --primary-btn-bg: #393e46;
            --primary-btn-hover-bg: #00adb5;
            --body-bg: #18191a;
        }
        body.theme-mint {
            --header-bg: #10b981;
            --primary-btn-bg: #34d399;
            --primary-btn-hover-bg: #059669;
            --body-bg: #e0f7fa;
        }
        body.theme-pink {
            --header-bg: #ec4899;
            --primary-btn-bg: #f472b6;
            --primary-btn-hover-bg: #be185d;
            --body-bg: #fff0f6;
        }
        body.theme-yellow {
            --header-bg: #f59e0b;
            --primary-btn-bg: #fbbf24;
            --primary-btn-hover-bg: #d97706;
            --body-bg: #fffbe6;
        }
.checkbox-large { transform: scale(1.35); cursor: pointer; }
        /* ===== ë‹¬ë ¥ ìŠ¤íƒ€ì¼ ê°œì„  ===== */
.calendar-controls {
  display: flex;
  gap: 8px;
  align-items: center;
  justify-content: space-between;
  margin-bottom: 16px;
}
.calendar-controls button {
  transition: all 0.2s ease-in-out;
}
.calendar-controls button:hover {
  transform: translateY(-1px);
  box-shadow: 0 2px 6px rgba(0,0,0,0.15);
}

.calendar-table {
  width: 100%;
  border-collapse: collapse;
  table-layout: fixed;
}
.calendar-table th {
  background-color: #f9fafb;
  padding: 0.75rem;
  text-align: center;
  font-weight: 600;
  border-bottom: 2px solid #e5e7eb;
}
.calendar-table td {
  border: 1px solid #e5e7eb;
  vertical-align: top;
  height: 90px;
  padding: 6px;
  cursor: pointer;
  position: relative;
}
.calendar-table td:hover {
  background-color: #f9fafb;
}

.calendar-day {
  display: flex;
  flex-direction: column;
  height: 100%;
}
.date-num {
  font-weight: 700;
  margin-bottom: 4px;
}
.has-event {
  border-left: 4px solid #60a5fa; /* íŒŒìŠ¤í…” ë¸”ë£¨ ì»¬ëŸ¬ë°” */
  background-color: #eff6ff;
  border-radius: 6px;
  padding: 2px 4px;
}
.small-event {
  display: block;
  background: hsl(218, 37%, 71%) !important; /* ì§„í•œ íŒŒë€ìƒ‰ìœ¼ë¡œ ì‹œì¸ì„± ê°•í™” */
  color: #fff;
  font-size: 0.75rem;
  padding: 2px 6px;
  border-radius: 6px;
  margin-top: 4px;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 100%;
}
.small-event.done {
  background: #2a58a8 !important; /* ì™„ë£Œëœ ì¼ì •ì€ íšŒìƒ‰ */
  text-decoration: line-through;
}

/* ì£¼ë§ ìƒ‰ìƒ */
.calendar-table th:nth-child(1), .calendar-table td:nth-child(1) .date-num {
  color: #ef4444; /* ì¼ìš”ì¼ ë¹¨ê°„ìƒ‰ */
}
.calendar-table th:nth-child(7), .calendar-table td:nth-child(7) .date-num {
  color: #3b82f6; /* í† ìš”ì¼ íŒŒë€ìƒ‰ */
}

/* ì˜¤ëŠ˜ ë‚ ì§œ ê°•ì¡° */
.today .date-num {
  background-color: #f59e0b;
  color: white;
  border-radius: 50%;
  width: 28px;
  height: 28px;
  text-align: center;
  line-height: 28px;
  margin: 0 auto 4px auto;
}
/* ëª¨ë‹¬ ìŠ¤íƒ€ì¼ (ì´ì „ì— ì¶”ê°€í•œ ëª¨ë‹¬ HTML/CSSì™€ í•¨ê»˜ ì‚¬ìš©) */
.modal-content {
    background-color: var(--modal-bg);
    color: var(--modal-text);
    transition: background-color 0.3s ease, color 0.3s ease;
}
.modal-overlay { /* ëª¨ë‹¬ ì˜¤ë²„ë ˆì´ëŠ” ì£¼ë¡œ íˆ¬ëª…ë„ë§Œ ì¡°ì ˆ */
    background-color: rgba(0, 0, 0, 0.5);
    transition: background-color 0.3s ease;
}

        /* ëª¨ë‹¬ ë””ìì¸ */
.modal-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0, 0, 0, 0.6); /* ë°˜íˆ¬ëª… ë°°ê²½ */
    display: flex;
    justify-content: center;
    align-items: center;
    z-index: 1000; /* ë‹¤ë¥¸ ìš”ì†Œë“¤ ìœ„ì— í‘œì‹œ */
    animation: fadeIn 0.3s ease-out; /* ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
}

.modal-overlay.hidden {
    display: none; /* ê¸°ë³¸ì ìœ¼ë¡œ ìˆ¨ê¹€ */
}

.modal-content {
    background-color: white;
    padding: 30px;
    border-radius: 10px;
    box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
    max-width: 400px;
    width: 50%;
    text-align: center;
    animation: slideIn 0.3s ease-out; /* ë“±ì¥ ì• ë‹ˆë©”ì´ì…˜ */
}

#modalMessage {
    font-size: 1.4em;
    margin-bottom: 20px;
    color: #333;
}

.modal-actions {
    display: flex;
    justify-content: center;
    gap: 15px;
}

.modal-button {
    padding: 10px 25px;
    border: none;
    border-radius: 5px;
    cursor: pointer;
    font-weight: bold;
    transition: background-color 0.2s;
}

/* í™•ì¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ (ê°•ì¡°ìƒ‰ ì‚¬ìš©) */
.modal-button.confirm {
    background-color: var(--btn-accent-bg, #4CAF50); /* ê¸°ë³¸ê°’ ë˜ëŠ” ì»¤ìŠ¤í…€ ë³€ìˆ˜ */
    color: white;
}

.modal-button.confirm:hover {
    background-color: var(--btn-accent-hover, #45a049);
}

/* ì·¨ì†Œ ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
.modal-button.cancel {
    background-color: #ccc;
    color: #333;
}

.modal-button.cancel:hover {
    background-color: #bbb;
}

/* ì• ë‹ˆë©”ì´ì…˜ í‚¤í”„ë ˆì„ */
@keyframes fadeIn {
    from { opacity: 0; }
    to { opacity: 1; }
}

@keyframes slideIn {
    from { transform: translateY(-50px); opacity: 0; }
    to { transform: translateY(0); opacity: 1; }
}
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--body-bg, #f0f4f8);
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            flex-grow: 1;
            position: relative;
            min-height: 600px;
        }
        @media (max-width: 768px) {
            .container {
                max-width: 100vw;
                padding: 0.5rem;
                min-height: 400px;
            }
            .section {
                padding: 0.5rem !important;
                border-radius: 0.5rem !important;
            }
            header, footer {
                padding: 0.5rem !important;
                border-radius: 0 !important;
            }
            nav {
                overflow-x: auto !important;
                flex-wrap: nowrap !important;
                -webkit-overflow-scrolling: touch;
            }
            .nav-button, .nav-button-themed {
                padding: 0.35rem 0.5rem !important;
                font-size: 0.85rem !important;
                min-width: 80px;
                white-space: nowrap;
            }
            .table-container, .evaluation-table-container, .attendance-table-container {
                max-width: 100vw !important;
                overflow-x: auto !important;
            }
            .modal-content {
                width: 95vw !important;
                min-width: unset !important;
                padding: 1rem !important;
            }
            #dday-display {
                font-size: 1rem !important;
                padding: 0.3rem 0.7rem !important;
            }
        }
        /* Section transition styles */
        .section {
            display: none;
            opacity: 0;
            transform: translateX(20px);
            transition: opacity 0.4s ease-out, transform 0.4s ease-out;
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            padding: 1.5rem;
            box-sizing: border-box;
            background-color: white;
            border-radius: 1rem;
            overflow-y: auto;
        }
        .section.active {
            display: block;
            opacity: 1;
            transform: translateX(0);
        }

        .header-title-edit, .footer-text-edit {
            display: none;
        }
        .header-title-edit.active, .footer-text-edit.active {
            display: inline-block;
        }
        .header-title-display, .footer-text-display {
            display: inline-block;
        }
        .header-title-display.editing, .footer-text-display.editing {
            display: none;
        }
        /* Custom scrollbar for fixed header table */
        .table-container {
            max-height: calc(100vh - 250px);
            overflow-y: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .table-container table {
            width: 100%;
            border-collapse: separate;
            border-spacing: 0;
        }
        .table-container thead th {
            position: sticky;
            top: 0;
            background-color: var(--table-header-bg, #e2e8f0);
            z-index: 10;
            padding: 0.75rem 1rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary, #4a5568);
            border-bottom: 2px solid var(--border, #cbd5e0);
        }
        .table-container tbody td {
            padding: 0.75rem 1rem;
            text-align: center;
            border-bottom: 1px solid var(--border-light, #edf2f7);
        }
        .table-container tbody tr:last-child td {
            border-bottom: none;
        }
        .table-container tbody tr:nth-child(odd) {
            background-color: var(--table-row-odd-bg, #ffffff);
        }
        .table-container tbody tr:nth-child(even) {
            background-color: var(--table-row-even-bg, #f7fafc);
        }
        .modal {
            display: none;
            position: fixed;
            z-index: 100;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0,0,0,0.4);
            justify-content: center;
            align-items: center;
        }
        .modal-content {
            background-color: var(--modal-bg, #fefefe);
            padding: 2rem;
            border-radius: 1rem;
            box-shadow: 0 5px 15px rgba(0,0,0,0.3);
            max-width: 90%;
            max-height: 90%;
            overflow-y: auto;
            position: relative;
        }
        /* Specific max-width for custom alert modal to ensure message fits */
        #custom-alert-modal .modal-content {
            max-width: 400px;
        }
        .close-button {
            position: absolute;
            top: 1rem;
            right: 1rem;
            font-size: 1.5rem;
            cursor: pointer;
            color: #aaa;
        }
        .close-button:hover {
            color: #333;
        }

        /* Timer specific styles */
        #timer-display, #manual-timer-display {
            font-size: 8rem;
            font-weight: bold;
            color: var(--timer-color, #3b82f6);
            transition: color 0.3s ease-in-out;
            text-shadow: 2px 2px 4px rgba(0,0,0,0.2);
            /* Ensure text itself is centered within its flex container */
            display: flex;
            align-items: center;
            justify-content: center;
            width: 100%; /* Take full width of parent */
            height: 100%; /* Take full height of parent */
        }
        #timer-display.blink, #manual-timer-display.blink {
            animation: blink-animation 1s infinite alternate;
        }
        #timer-display.scale, #manual-timer-display.scale {
            animation: scale-animation 1s infinite alternate;
        }
        @keyframes blink-animation {
            from { opacity: 1; }
            to { opacity: 0.5; }
        }
        @keyframes scale-animation {
            from { transform: scale(1); }
            to { transform: scale(1.1); }
        }

        /* Lottery specific styles */
.btn-red {
    background-color: var(--red-btn-bg, #ef4444); /* Tailwind red-500 */
    color: var(--btn-text-color, #ffffff); /* í°ìƒ‰ í…ìŠ¤íŠ¸ */
    /* ì•„ë˜ëŠ” ë‹¤ë¥¸ ê¸°ë³¸ ë²„íŠ¼ ìŠ¤íƒ€ì¼ì— ì •ì˜ë˜ì–´ ìˆì„ ìˆ˜ ìˆëŠ” ê³µí†µ ì†ì„±ë“¤ */
    padding: 0.5rem 1rem; /* px-4 py-2ì™€ ìœ ì‚¬ */
    border-radius: 0.5rem; /* rounded-lgì™€ ìœ ì‚¬ */
    transition-property: background-color, border-color, color, fill, stroke, opacity, box-shadow, transform;
    transition-duration: 200ms;
    transition-timing-function: cubic-bezier(0.4, 0, 0.2, 1); /* transition-colors duration-200ê³¼ ìœ ì‚¬ */
    border: none;
    cursor: pointer;
    display: inline-flex;
    align-items: center;
    justify-content: center;
    font-weight: 600; /* font-semiboldì™€ ìœ ì‚¬ */
    white-space: nowrap; /* í…ìŠ¤íŠ¸ ì¤„ë°”ê¿ˆ ë°©ì§€ */
}

.btn-red:hover {
    background-color: var(--red-btn-hover-bg, #dc2626); /* Tailwind red-600 */
}

.btn-red:active {
    background-color: var(--red-btn-active-bg, #b91c1c); /* Tailwind red-700 */
}

        #lottery-result-display {
            font-size: 4rem;
            font-weight: bold;
            color: var(--lottery-result-color, #10b981);
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
            min-height: 5rem;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
            overflow: hidden;
        }
        .confetti {
            position: fixed;
            width: 10px;
            height: 10px;
            background-color: #f06;
            opacity: 0;
            animation: confetti-fall 2s forwards;
            border-radius: 50%;
            z-index: 9999;
        }
        @keyframes confetti-fall {
            0% { transform: translate(0, 0) rotate(0deg); opacity: 1; }
            100% { transform: translate(var(--x), var(--y)) rotate(720deg); opacity: 0; }
        }
        .shuffle-animation {
            animation: shuffle 0.5s infinite alternate;
        }
        @keyframes shuffle {
            0% { transform: translateY(0); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0); }
        }

        /* Notice Board specific styles */
        #notice-content {
            background-color: #2c3e50; /* Hardcoded dark background */
            color: #ecf0f1; /* Hardcoded light text color */
            /* Removed: height: 200px; */
            overflow-y: hidden; /* Hide scrollbar initially, JS will manage */
            border-radius: 0.75rem;
            padding: 1.5rem;
            line-height: 1.5;
            /* Removed: resize: vertical; */
            /* Removed: min-height: 400px; */
        }
        /* Custom font selection */
        .font-gothic { font-family: 'Gothic A1', sans-serif; }
        .font-nanum { font-family: 'Nanum Gothic Coding', monospace; }
        .font-noto { font-family: 'Noto Sans KR', sans-serif; }

        /* Progress bar styling */
        .progress-bar-container {
            width: 100%;
            background-color: var(--progress-bg, #e0e7ff);
            border-radius: 0.5rem;
            overflow: hidden;
            height: 0.75rem;
        }
        .progress-bar-fill {
            height: 100%;
            background-color: var(--progress-fill, #6366f1);
            border-radius: 0.5rem;
            transition: width 0.3s ease-in-out;
        }
        .progress-text {
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--progress-text, #4338ca);
            margin-left: 0.5rem;
        }

        /* Evaluation Table Specific Styles */
        .evaluation-table-container {
            max-height: calc(100vh - 300px);
            overflow: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .evaluation-table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 80px
        }
        .evaluation-table-container thead th {
            position: sticky;
            top: 0;
            background-color: var(--table-header-bg, #e2e8f0);
            z-index: 20;
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary, #4a5568);
            border: 1px solid var(--border, #cbd5e0);
        }
/* ì²« ë²ˆì§¸ ì—´ (ê³¼ëª©ëª…) ê³ ì • */
.evaluation-table-container th:first-child(1),
.evaluation-table-container td:first-child(1) {
    position: sticky;
    left: 0;
    min-width: 80px;
    background-color: var(--table-header-bg, #e2e8f0); /* í—¤ë” ë°°ê²½ìƒ‰ê³¼ ë™ì¼í•˜ê²Œ ì„¤ì • */
    z-index: 15; /* ë‹¤ë¥¸ ê³ ì • í—¤ë”ë³´ë‹¤ ë†’ì€ z-indexë¡œ ì„¤ì • */
}
/* ê³ ì •ëœ ì²« ë²ˆì§¸ ì—´ í—¤ë”ì˜ ë°°ê²½ìƒ‰ */
.evaluation-table-container thead th:nth-child(1) {
    background-color: var(--table-header-bg, #e2e8f0);
    z-index: 31; /* ê³ ì •ëœ ëª¨ë“  í—¤ë” ì¤‘ ê°€ì¥ ë†’ê²Œ (ê²¹ì¹˜ëŠ” ì½”ë„ˆ ë¶€ë¶„ ì²˜ë¦¬) */
}
/* ë‘ ë²ˆì§¸ ì—´ (ê³¼ëª©ëª…) ê³ ì • */
.evaluation-table-container th:nth-child(2),
.evaluation-table-container td:nth-child(2) {
    position: sticky;
    left: 80px; /* ì²« ë²ˆì§¸ ì—´ì˜ ë„ˆë¹„ë§Œí¼ ì˜†ìœ¼ë¡œ ì´ë™ (ì˜ˆì‹œ ê°’, ì‹¤ì œ ë„ˆë¹„ì— ë§ì¶°ì•¼ í•¨) */
    background-color: var(--table-row-odd-bg, #ffffff); /* tbodyì˜ ë°°ê²½ìƒ‰ê³¼ ì¼ì¹˜ì‹œí‚¤ê±°ë‚˜ ë³„ë„ ìƒ‰ìƒ ì§€ì • */
    min-width: 120px;
    z-index: 14; /* ì²« ë²ˆì§¸ ì—´ë³´ë‹¤ ë‚®ê²Œ ì„¤ì • */
}

    /* ê³ ì •ëœ ë‘ ë²ˆì§¸ ì—´ í—¤ë”ì˜ ë°°ê²½ìƒ‰ */
    .evaluation-table-container thead th:nth-child(2) {
        background-color: var(--table-header-bg, #e2e8f0);
        z-index: 30; /* ê³ ì •ëœ í—¤ë”ì™€ ë™ë“±í•˜ê²Œ ë˜ëŠ” ì•½ê°„ ë‚®ê²Œ */
    }

    /* 3. ì„¸ ë²ˆì§¸ ì—´ (ì˜ˆ: ë‹¨ì›í‰ê°€ëª…) ê³ ì • */
    .evaluation-table-container th:nth-child(3),
    .evaluation-table-container td:nth-child(3) {
        position: sticky;
        left: calc(80px + 120px); /* (ì²« ë²ˆì§¸ ì—´ ë„ˆë¹„ + ë‘ ë²ˆì§¸ ì—´ ë„ˆë¹„) */
        min-width: 150px; /* ë‹¨ì›í‰ê°€ëª…ì˜ ì˜ˆìƒ ë„ˆë¹„ */
        background-color: var(--table-row-odd-bg, #ffffff); /* tbodyì˜ ë°°ê²½ìƒ‰ê³¼ ì¼ì¹˜ ë˜ëŠ” ëª…ì‹œì  ìƒ‰ìƒ */
        z-index: 13; /* ì´ì „ ê³ ì • ì—´ë“¤ë³´ë‹¤ ë‚®ê²Œ */
    }
    /* ê³ ì •ëœ ì„¸ ë²ˆì§¸ ì—´ í—¤ë”ì˜ ë°°ê²½ìƒ‰ */
    .evaluation-table-container thead th:nth-child(3) {
        background-color: var(--table-header-bg, #e2e8f0);
        z-index: 30;
    }

        /* ì¼ë°˜ td ìŠ¤íƒ€ì¼ (ë‚˜ë¨¸ì§€ ìŠ¤í¬ë¡¤ë˜ëŠ” ì…€ë“¤) */
    .evaluation-table-container tbody td {
        padding: 0.5rem;
        text-align: center;
        border: 1px solid var(--border-light, #edf2f7);
        vertical-align: middle;
        min-width: 100px; /* ë‚˜ë¨¸ì§€ ì…€ë“¤ì˜ ê¸°ë³¸ ìµœì†Œ ë„ˆë¹„ */
    }

        /* Adjusted sizes for evaluation inputs */
        .evaluation-input-group {
            display: flex;
            flex-direction: column; /* Stack them vertically */
            align-items: center;
            gap: 0.25rem; /* Small gap between select and input */
        }
        .evaluation-grade-select {
            width: 50px;
            padding: 0.25rem;
            border-radius: 0.375rem;
            border: 1px solid var(--input-border, #d1d5db);
            font-size: 0.875rem;
            text-align: center;
        }
        .evaluation-score-input {
            width: 70px;
            padding: 0.25rem;
            border-radius: 0.375rem;
            border: 1px solid var(--input-border, #d1d5db);
            font-size: 0.875rem;
            text-align: center;
        }

        /* Attendance Table Specific Styles */
        .attendance-table-container {
            max-height: calc(100vh - 300px);
            overflow: auto;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
        }
        .attendance-table-container table {
            width: 100%;
            border-collapse: collapse;
            min-width: 800px;
        }
        .attendance-table-container thead th {
            position: sticky;
            top: 0;
            background-color: var(--table-header-bg, #e2e8f0);
            z-index: 20;
            padding: 0.75rem 0.5rem;
            text-align: center;
            font-size: 0.875rem;
            font-weight: 600;
            color: var(--text-secondary, #4a5568);
            border: 1px solid var(--border, #cbd5e0);
        }

        /* Add this to fix the student name column */
.attendance-table-container th:first-child, /* For the "í•™ìƒëª…" header in thead */
.attendance-table-container tbody td:first-child { /* For student names in tbody */
    position: sticky;
    left: 0;
    background-color: var(--table-row-odd-bg, #ffffff); /* Ensure background is solid to prevent content bleed-through */
    z-index: 15; /* Higher than regular tbody cells, but lower than top header */
    min-width: 120px; /* Adjust as needed */
}

/* Ensure the top-left corner (í•™ìƒëª… in thead) has the highest z-index when both are sticky */
.attendance-table-container thead th:first-child {
    z-index: 30; /* Higher than both sticky row and sticky column */
    background-color: var(--table-header-bg, #e2e8f0); /* Match header background */
}
        .attendance-table-container tbody td {
            padding: 0.5rem;
            text-align: center;
            border: 1px solid var(--border-light, #edf2f7);
            vertical-align: middle;
            min-width: 70px;
        }
        .attendance-table-container tbody tr:nth-child(odd) {
            background-color: var(--table-row-odd-bg, #ffffff);
        }
        .attendance-table-container tbody tr:nth-child(even) {
            background-color: var(--table-row-even-bg, #f7fafc);
        }
        .attendance-status-select, .attendance-detail-select {
            min-width: 65px;
            padding: 0.1rem;
            border-radius: 0.375rem;
            border: 1px solid var(--input-border, #d1d5db);
            font-size: 0.75rem;
            text-align: center;
            box-sizing: border-box;
        }
        .attendance-detail-select {
            margin-top: 2px;
        }

        /* Number/Student Lottery Card Styles */
        .lottery-card-container {
            display: flex;
            flex-wrap: wrap;
            gap: 1rem;
            justify-content: center;
            align-items: center;
            margin-top: 1rem;
            min-height: 5rem;
            max-width: 700px;
            margin-left: auto;
            margin-right: auto;
        }
        .lottery-card {
            background-color: var(--lottery-card-bg, #6366f1);
            color: white;
            font-weight: bold;
            width: 100px;
            height: 80px;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 0.75rem;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s ease-in-out;
            padding: 0.5rem;
            font-size: 1.25rem;
            line-height: 1.2;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        .lottery-card:hover {
            transform: translateY(-5px);
        }

        /* Dynamic button colors */
        .btn-primary { background-color: var(--primary-btn-bg, #3b82f6); }
        .btn-primary:hover { background-color: var(--primary-btn-hover-bg, #2563eb); }
        .btn-secondary { background-color: var(--secondary-btn-bg, #8b5cf6); }
        .btn-secondary:hover { background-color: var(--secondary-btn-hover-bg, #7c3aed); }
        .btn-accent { background-color: var(--accent-btn-bg, #10b981); }
        .btn-accent:hover { background-color: var(--accent-btn-hover-bg, #059669); }
        .btn-warning { background-color: var(--warning-btn-bg, #f59e0b); }
        .btn-warning:hover { background-color: var(--warning-btn-hover-bg, #d97706); }
        .btn-danger { background-color: var(--danger-btn-bg, #ef4444); }
        .btn-danger:hover { background-color: var(--danger-btn-hover-bg, #dc2626); }
        .btn-info { background-color: var(--info-btn-bg, #6366f1); }
        .btn-info:hover { background-color: var(--info-btn-hover-bg, #4f46e5); }
        .btn-teal { background-color: var(--teal-btn-bg, #14b8a6); }
        .btn-teal:hover { background-color: var(--teal-btn-hover-bg, #0d9488); }
        .btn-orange { background-color: var(--orange-btn-bg, #f97316); }
        .btn-orange:hover { background-color: var(--orange-btn-hover-bg, #ea580c); }

        /* Nav button specific styling */
        .nav-button-themed {
            background-color: transparent; /* Make background transparent to blend with header */
            color: white; /* Ensure text is visible */
            transition: background-color 0.2s ease-in-out;
        }
        .nav-button-themed.active {
            background-color: var(--nav-button-active-bg);
            border-radius: 0.5rem; /* Add rounded corners for active state */
        }
        .nav-button-themed:hover {
            background-color: var(--nav-button-hover-bg);
            border-radius: 0.5rem; /* Add rounded corners on hover */
        }
        /* ì—¬ê¸°ì— ì•Œë¦¼ì¥ ì „ì²´í™”ë©´ ëª¨ë“œ CSS ì½”ë“œë¥¼ ì¶”ê°€í•˜ì‹œë©´ ë©ë‹ˆë‹¤. */
        #noticeBoard.fullscreen-active {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            z-index: 1000;
            background-color: var(--page-bg, #f0f2f5);
            padding: 20px;
            overflow-y: auto;
            box-sizing: border-box;
        }

        #noticeBoard.fullscreen-active #notice-board-content {
            height: calc(100% - 100px);
            max-height: unset;
            overflow-y: auto;
        }
        /* ===== ë‹¬ë ¥ ê´€ë ¨ ìŠ¤íƒ€ì¼ ===== */
.calendar-table { width:100%; border-collapse:collapse; }
.calendar-table th, .calendar-table td { border:1px solid #e5e7eb; padding:0.75rem; text-align:left; vertical-align:top; height:100px; }
.calendar-day { cursor:pointer; height:100%; display:flex; flex-direction:column; }
.calendar-day .date-num { font-weight:700; margin-bottom:0.25rem; }
.has-event { background: linear-gradient(90deg,#fef3c7,#d1fae5); border-radius:6px; padding:4px; }
.calendar-controls { display:flex; gap:8px; align-items:center; justify-content:space-between; margin-bottom:12px; }
.small-event { display:block; background:#e5e7eb; padding:2px 6px; border-radius:6px; margin-top:4px; font-size:0.8rem; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
    </style>

<!-- D-Day ê´€ë¦¬ ëª¨ë‹¬ (í—¤ë” ìœ„ì— ìœ„ì¹˜) -->
<div id="dday-modal" class="fixed inset-0 bg-black bg-opacity-40 flex items-center justify-center z-50 hidden">
    <div class="bg-white rounded-xl shadow-xl p-6 w-full max-w-md">
        <h2 class="text-2xl font-bold mb-4">D-DAY ê´€ë¦¬</h2>
        <div id="dday-list" class="space-y-2 max-h-60 overflow-y-auto mb-4"></div>
        <div class="flex justify-end space-x-2">
            <button id="close-dday-modal" class="px-4 py-2 rounded bg-gray-300 hover:bg-gray-400">ë‹«ê¸°</button>
        </div>
    </div>
</div>

    <!-- Header -->
    <header class="text-white p-4 shadow-md flex justify-between items-center" style="background-color: var(--header-bg, #2563eb);">
        <div class="flex items-center flex-shrink-0">
            <h1 id="header-title-display" class="text-3xl font-bold mr-2 whitespace-nowrap">ìœ¡ê°œì¥ë°˜ í•™ê¸‰ ìš´ì˜ ì‹œìŠ¤í…œ</h1>
            <input type="text" id="header-title-edit" class="header-title-edit p-1 rounded text-gray-800 text-xl" style="width: 200px;">
            <button id="edit-header-title" class="ml-2 text-white hover:text-blue-200">
                <i class="fas fa-pencil-alt"></i>
            </button>
        </div>

        <!-- ì‹œê°„ í‘œì‹œì™€ ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ì„ ê°ì‹¸ëŠ” ì»¨í…Œì´ë„ˆ -->
<div class="flex items-center space-x-2">
    <div class="flex flex-col items-end text-lg font-semibold flex-shrink-0">
        <span id="current-date-display"></span>
        <span id="current-time-display"></span>
    </div>
            <span id="dday-display" class="font-bold px-3 py-1 rounded-lg text-lg mx-2 whitespace-pre-line text-center" style="min-width:90px;display:none;background-color:var(--header-bg,#2563eb);color:#fff;"></span>
    <button id="logout-btn" class="bg-red-500 hover:bg-red-600 text-white font-bold py-1 px-2 rounded-lg shadow-md transition-colors duration-200 text-sm">
        <i class="fas fa-sign-out-alt mr-1"></i> ë¡œê·¸ì•„ì›ƒ
    </button>
</div>
    </header>

    <!-- Navigation Bar (í—¤ë” ì•„ë˜, ê°€ë¡œ ìŠ¤í¬ë¡¤) -->
<nav id="main-navbar" class="w-full overflow-x-auto shadow-sm border-b border-gray-200 rounded-b-xl" style="background-color: var(--header-bg, #2563eb);">
    <div class="flex flex-nowrap space-x-2 px-2 py-2 min-w-max" style="-webkit-overflow-scrolling:touch;">
    <button class="nav-button nav-button-themed px-4 py-2 rounded-lg transition-colors duration-200 whitespace-nowrap" data-section="assignmentCheck">ê³¼ì œ ì ê²€</button>
    <button class="nav-button nav-button-themed px-4 py-2 rounded-lg transition-colors duration-200 whitespace-nowrap" data-section="evaluationResults">í‰ê°€ ê²°ê³¼</button>
    <button class="nav-button nav-button-themed px-4 py-2 rounded-lg transition-colors duration-200 whitespace-nowrap" data-section="attendanceManagement">ì¶œê²° ê´€ë¦¬</button>
    <button class="nav-button nav-button-themed px-4 py-2 rounded-lg transition-colors duration-200 whitespace-nowrap" data-section="calendar">ì¼ì • ê´€ë¦¬</button>
    <button class="nav-button nav-button-themed px-4 py-2 rounded-lg transition-colors duration-200 whitespace-nowrap" data-section="timer">íƒ€ì´ë¨¸</button>
    <button class="nav-button nav-button-themed px-4 py-2 rounded-lg transition-colors duration-200 whitespace-nowrap" data-section="lottery">ë½‘ê¸°</button>
    <button class="nav-button nav-button-themed px-4 py-2 rounded-lg transition-colors duration-200 whitespace-nowrap" data-section="noticeBoard">ì•Œë¦¼ì¥</button>
    <button class="nav-button nav-button-themed px-4 py-2 rounded-lg transition-colors duration-200 whitespace-nowrap" data-section="memo">ë©”ëª¨</button>
    <button class="nav-button nav-button-themed px-4 py-2 rounded-lg transition-colors duration-200 whitespace-nowrap" data-section="settings">ì„¤ì •</button>
  </div>
</nav>

    <!-- Main Content Area -->
    <main class="container p-6 bg-white shadow-xl rounded-xl my-6 flex-grow">
        <!-- Auth Section -->
        <section id="authSection" class="section">
            <div class="flex flex-col items-center space-y-4 mb-6">
                <!-- ìµëª… ID ì„¹ì…˜ -->
                <div class="flex items-center space-x-2">
                    <input type="text" id="anonymous-id-input" placeholder="ìµëª… ID ì…ë ¥" class="p-2 border rounded-lg text-lg w-60">
                    <button id="load-anonymous-data-btn" class="btn-primary text-white px-4 py-2 rounded-lg shadow-md transition-colors duration-200">
                        <i class="fas fa-download mr-2"></i> ìµëª… IDë¡œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
                    </button>
                </div>

                <div class="border-t border-gray-200 w-full max-w-md pt-4 mt-4"></div> <!-- êµ¬ë¶„ì„  -->

                <!-- ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ì„¹ì…˜ -->
                <div class="flex flex-col space-y-3 w-full max-w-md">
                    <h3 class="text-xl font-semibold text-gray-700 text-center">ì´ë©”ì¼/ë¹„ë°€ë²ˆí˜¸ ë¡œê·¸ì¸</h3>
                    <input type="email" id="email-input" placeholder="ì´ë©”ì¼" class="p-2 border rounded-lg text-lg">
                    <input type="password" id="password-input" placeholder="ë¹„ë°€ë²ˆí˜¸" class="p-2 border rounded-lg text-lg">
                <button id="forgot-password-btn" class="text-blue-500 underline text-sm ml-2">ë¹„ë°€ë²ˆí˜¸ë¥¼ ìŠìœ¼ì…¨ë‚˜ìš”?</button>
                    <div class="flex items-center mb-2">
                        <input type="checkbox" id="keep-logged-in" class="mr-2 checkbox-large">
                        <label for="keep-logged-in" class="text-sm select-none">ë¡œê·¸ì¸ ìœ ì§€</label>
                    </div>
                    <div class="flex justify-center space-x-4">
                        <button id="signup-btn" class="btn-accent text-white px-4 py-2 rounded-lg shadow-md transition-colors duration-200">
                            <i class="fas fa-user-plus mr-2"></i> íšŒì›ê°€ì…
                        </button>
                        <button id="signin-btn" class="btn-secondary text-white px-4 py-2 rounded-lg shadow-md transition-colors duration-200">
                            <i class="fas fa-sign-in-alt mr-2"></i> ë¡œê·¸ì¸
                        </button>
                    </div>
                </div>
            </div>
        </section>

        <!-- ê³¼ì œ ì ê²€ Section -->
        <section id="assignmentCheck" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2">ê³¼ì œ ì ê²€</h2>
            <div class="flex justify-end space-x-4 mb-4">
                <button id="manage-students-btn" class="btn-secondary text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">í•™ìƒ ëª…ë‹¨ ê´€ë¦¬</button>
                <button id="manage-assignments-btn" class="btn-accent text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ê³¼ì œ ê´€ë¦¬</button>
                <button id="view-history-btn" class="btn-info text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ì´ë ¥ í™•ì¸</button>
            </div>

            <div class="table-container bg-white rounded-xl shadow-md">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="sticky top-0">
                        <tr>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider w-1/144">ë²ˆí˜¸</th>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider w-1/72">í•™ìƒëª…</th>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider w-1/12">ì§„í–‰ë„ (%)</th>
                            <!-- Assignment headers will be injected here by JS -->
                        </tr>
                    </thead>
                    <tbody id="assignment-table-body" class="divide-y divide-gray-200">
                        <!-- Student rows will be injected here by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- í‰ê°€ ê²°ê³¼ Section -->
        <section id="evaluationResults" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2">í‰ê°€ ê²°ê³¼</h2>
            <div class="flex justify-end space-x-4 mb-4">
                <button id="manage-subjects-btn" class="btn-secondary text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ê³¼ëª© ê´€ë¦¬</button>
            </div>

            <div class="evaluation-table-container bg-white rounded-xl shadow-md">
                <table class="min-w-full">
                    <thead id="evaluation-table-header">
                        <!-- Evaluation headers will be injected here by JS -->
                    </thead>
                    <tbody id="evaluation-table-body">
                        <!-- Student evaluation rows will be injected here by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- ì¶œê²° ê´€ë¦¬ Section -->
        <section id="attendanceManagement" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2">ì¶œê²° ê´€ë¦¬</h2>
            <div class="flex justify-between items-center mb-4">
                <div class="flex space-x-2">
                    <input type="month" id="attendance-month-picker" class="p-2 border rounded-lg">
                    <button id="prev-month-btn" class="btn-primary text-white px-4 py-2 rounded-lg transition-colors duration-200"><i class="fas fa-chevron-left"></i></button>
                    <button id="next-month-btn" class="btn-primary text-white px-4 py-2 rounded-lg transition-colors duration-200"><i class="fas fa-chevron-right"></i></button>
                </div>
                <div class="flex space-x-4">
                    <button id="manage-no-class-days-btn" class="btn-orange text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ìˆ˜ì—… ì—†ëŠ” ë‚  ì„¤ì •</button>
                    <button id="view-monthly-stats-btn" class="btn-info text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ì›”ë³„ í†µê³„ ë³´ê¸°</button>
                    <button id="batch-attendance-btn" class="btn-teal text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ì¼ê´„ ì¶œê²° ì…ë ¥</button>
                </div>
            </div>

            <div class="attendance-table-container bg-white rounded-xl shadow-md">
                <table class="min-w-full">
                    <thead id="attendance-table-header">
                        <!-- Attendance headers will be injected here by JS -->
                    </thead>
                    <tbody id="attendance-table-body">
                        <!-- Student attendance rows will be injected here by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <!-- íƒ€ì´ë¨¸ Section -->
        <section id="timer" class="section flex flex-col items-center min-h-[500px]">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2 w-full text-center">íƒ€ì´ë¨¸</h2>
            <div class="flex space-x-4 mb-8">
                <button id="show-lunch-timer-btn" class="btn-primary text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ì ì‹¬ ì‹œê°„ íƒ€ì´ë¨¸</button>
                <button id="show-manual-timer-btn" class="btn-warning text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ìˆ˜ë™ íƒ€ì´ë¨¸</button>
            </div>

            <div id="lunch-timer-container" class="flex flex-col items-center justify-center w-full flex-grow text-center">
                <p class="text-2xl text-gray-600 mb-4" id="lunch-timer-message">ì ì‹¬ì‹œê°„ê¹Œì§€ ë‚¨ì€ ì‹œê°„:</p>
                <div id="timer-display" class="w-full h-full flex items-center justify-center">00:00:00</div>
            </div>

            <div id="manual-timer-container" class="flex-col items-center justify-center w-full flex-grow text-center hidden">
                <div class="mb-4">
                    <input type="number" id="manual-timer-minutes" placeholder="ë¶„" class="p-3 border rounded-lg text-xl w-24 text-center mr-2">
                    <input type="number" id="manual-timer-seconds" placeholder="ì´ˆ" class="p-3 border rounded-lg text-xl w-24 text-center">
                </div>
                <button id="start-manual-timer-btn" class="btn-primary text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200 mb-4">íƒ€ì´ë¨¸ ì‹œì‘</button>
                <div id="manual-timer-display" class="w-full h-full flex items-center justify-center">00:00</div>
            </div>
        </section>

        <!-- ë½‘ê¸° Section -->
        <section id="lottery" class="section flex flex-col items-center justify-center min-h-[500px]">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2 w-full text-center">ë½‘ê¸°</h2>
            <div class="flex space-x-4 mb-8">
                <button id="show-student-lottery-btn" class="btn-primary text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">í•™ìƒ ë½‘ê¸°</button>
                <button id="show-number-lottery-btn" class="btn-secondary text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ìˆ«ì ë½‘ê¸°</button>
            </div>

            <div id="student-lottery-container" class="flex flex-col items-center w-full hidden">
                <div class="mb-4">
                    <label for="student-pick-count" class="text-lg mr-2">ë½‘ì„ í•™ìƒ ìˆ˜:</label>
                    <input type="number" id="student-pick-count" value="1" min="1" class="p-2 border rounded-lg text-lg w-20 text-center">
                </div>
                <button id="start-student-lottery-btn" class="btn-accent text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg transition-all duration-300 transform hover:scale-105">í•™ìƒ ë½‘ê¸° ì‹œì‘!</button>
                <!-- Student lottery result display now uses lottery-card-container -->
                <div id="student-lottery-result-display" class="mt-8 p-8 rounded-xl shadow-inner w-full lottery-card-container" style="background-color: var(--lottery-result-bg, #dbeafe);">
                    <span id="current-lottery-result" class="text-2xl text-gray-600"></span>
                </div>
                <div class="mt-4 flex justify-between items-center mb-4 gap-x-4">
                    <h3 class="text-xl font-semibold text-gray-700">í•™ìƒ ë½‘ê¸° ê²°ê³¼ ê¸°ë¡</h3>
                    <button id="reset-student-lottery-btn" class="btn-red text-white px-2 py-1 rounded-lg transition-colors duration-200 text-xs">
                    <i class="fas fa-redo"></i> ë½‘ê¸° ê²°ê³¼ ì´ˆê¸°í™”
                    </button>
                </div>
                <div class="w-full max-w-md bg-gray-50 p-6 rounded-xl shadow-md">
                    <ul id="lottery-history-list" class="list-disc list-inside text-gray-600 max-h-60 overflow-y-auto">
                        <!-- Lottery history will be appended here -->
                    </ul>
                </div>
            </div>
            <div id="number-lottery-container" class="flex flex-col items-center w-full hidden">
                <div class="mb-4 flex items-center space-x-2">
                    <label for="number-min" class="text-lg">ìµœì†Œ:</label>
                    <input type="number" id="number-min" value="1" class="p-2 border rounded-lg text-lg w-20 text-center">
                    <label for="number-max" class="text-lg">ìµœëŒ€:</label>
                    <input type="number" id="number-max" value="5" class="p-2 border rounded-lg text-lg w-20 text-center">
                    <label for="number-pick-count" class="text-lg">ë½‘ì„ ê°œìˆ˜:</label>
                    <input type="number" id="number-pick-count" value="5" min="1" class="p-2 border rounded-lg text-lg w-20 text-center">
                </div>
                <button id="start-number-lottery-btn" class="btn-accent text-white px-8 py-4 rounded-full text-xl font-bold shadow-lg transition-all duration-300 transform hover:scale-105">ìˆ«ì ë½‘ê¸° ì‹œì‘!</button>
                <!-- Number lottery result display now uses lottery-card-container -->
                <div id="number-lottery-result-display" class="mt-8 p-8 rounded-xl shadow-inner w-full lottery-card-container" style="background-color: var(--lottery-result-bg, #dbeafe);">
                    <!-- Number cards will be injected here -->
                </div>
                <div class="mt-4 flex justify-between items-center mb-4 gap-x-4">
                    <h3 class="text-xl font-semibold text-gray-700">ìˆ«ì ë½‘ê¸° ê²°ê³¼ ê¸°ë¡</h3>
                    <button id="reset-number-lottery-btn" class="btn-red text-white px-2 py-1 rounded-lg transition-colors duration-200 text-xs">
                    <i class="fas fa-redo"></i> ë½‘ê¸° ê²°ê³¼ ì´ˆê¸°í™”
                </button>
                </div>
                <div class="w-full max-w-md bg-gray-50 p-6 rounded-xl shadow-md">
                    <ul id="number-lottery-history-list" class="list-disc list-inside text-gray-600 max-h-60 overflow-y-auto">
                        <!-- Number lottery history will be appended here -->
                    </ul>
                </div>
            </div>
        </section>

        <!-- ì¼ì • ê´€ë¦¬ Section -->
        <section id="calendar" class="section">
    <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2">ì¼ì • ê´€ë¦¬</h2>

    <div class="calendar-controls">
        <div class="flex items-center gap-2">
            <button id="prev-month" class="btn-primary text-white px-3 py-2 rounded">&lt; ì´ì „</button>
            <button id="next-month" class="btn-primary text-white px-3 py-2 rounded">ë‹¤ìŒ &gt;</button>
        </div>
        <div class="text-lg font-semibold" id="calendar-current-month">YYYYë…„ Mì›”</div>
        <div>
            <button id="today-btn" class="btn-accent text-white px-3 py-2 rounded">ì˜¤ëŠ˜</button>
        </div>
    </div>

    <div id="calendar-container" class="bg-white rounded-xl shadow-md p-4">
        <!-- ë‹¬ë ¥ í…Œì´ë¸”ì´ ë Œë”ë§ë©ë‹ˆë‹¤ -->
    </div>

    <div class="mt-4 text-sm text-gray-600">
        ë‚ ì§œë¥¼ í´ë¦­í•˜ë©´ ì œëª©/ë‚´ìš©/ì‹œê°„ì„ ì…ë ¥í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ì €ì¥í•˜ë©´ ìë™ìœ¼ë¡œ ì„œë²„(ë˜ëŠ” ë¡œì»¬)ì— ì €ì¥ë©ë‹ˆë‹¤.
    </div>
</section>
        <!-- ì•Œë¦¼ì¥ Section -->
        <section id="noticeBoard" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2">ì•Œë¦¼ì¥</h2>
            <div class="bg-gray-200 p-6 rounded-xl shadow-md">
                <div class="flex justify-between items-center mb-4">
                    <button id="fullscreen-notice-btn" class="btn-primary text-white px-4 py-2 rounded-lg transition-colors duration-200">
                    <i class="fas fa-expand"></i> ì „ì²´í™”ë©´
                    </button>
                    <p id="notice-date" class="text-xl font-semibold text-gray-700"></p>
                    <div class="flex space-x-2">
                        <select id="notice-font-family" class="p-2 border rounded-lg">
                            <option value="Inter">ê¸°ë³¸ í°íŠ¸</option>
                            <option value="Gothic A1">ê³ ë”• A1</option>
                            <option value="Nanum Gothic Coding">ë‚˜ëˆ”ê³ ë”•ì½”ë”©</option>
                            <option value="Noto Sans KR">Noto Sans KR</option>
                        </select>
                        <input type="number" id="notice-font-size" value="30" min="10" max="100" class="p-2 border rounded-lg w-20 text-center">
                        <button id="load-prev-notice-btn" class="btn-primary text-white px-4 py-2 rounded-lg transition-colors duration-200">ì „ë‚  ì•Œë¦¼ì¥</button>
                        <button id="copy-notice-btn" class="btn-accent text-white px-4 py-2 rounded-lg transition-colors duration-200">ë‚´ìš© ë³µì‚¬</button>
                    </div>
                </div>
                <textarea id="notice-content" class="w-full p-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-blue-400 text-white" placeholder="ì•Œë¦¼ì¥ ë‚´ìš©ì„ ì‘ì„±í•´ì£¼ì„¸ìš”." rows="5"></textarea>
            </div>
        </section>

        <!-- ë©”ëª¨ Section -->
        <section id="memo" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2">ë©”ëª¨</h2>
            <div class="flex justify-end mb-4">
                <button id="add-memo-btn" class="btn-primary text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ìƒˆ ë©”ëª¨ ì¶”ê°€</button>
            </div>
            <div id="memo-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
                <!-- Memos will be injected here by JS -->
            </div>
        </section>

        <!-- ì„¤ì • Section (New) -->
        <section id="settings" class="section">
            <h2 class="text-3xl font-bold text-gray-800 mb-6 border-b-2 pb-2">ì„¤ì •</h2>
            <div class="flex justify-end mb-4">
    <button id="manage-dday-btn" class="bg-blue-100 hover:bg-blue-200 text-blue-700 font-semibold px-2 py-1 rounded text-xs border border-blue-300 ml-1">D-DAY ê´€ë¦¬</button>
</div>
            <div class="flex flex-col space-y-8">
                <!-- í…Œë§ˆ ì„¤ì • -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">í…Œë§ˆ ì„¤ì •</h3>
                    <div class="flex flex-wrap gap-4" id="theme-selection">
                        <!-- Theme options will be dynamically generated -->
                    </div>
                </div>
                <!-- ì•„ì´ë”” (New) -->
                <div class="bg-gray-100 p-4 rounded-lg shadow-inner mt-6">
                    <h3 class="text-xl font-semibold text-gray-700 mb-4">ë¡œê·¸ì¸ ë° ë°ì´í„° ì •ë³´</h3>
                    <p id="auth-status-settings" class="text-sm mt-1">ë¡œê·¸ì¸ í•„ìš”</span>
                    <p id="current-auth-id-display-settings" class="text-xs text-gray-300 mt-0.5 hidden"></span>
                    <p id="loaded-data-id-display-settings" class="text-xs text-gray-300 mt-0.5 hidden"></span>
                </div>

                <!-- ë³´ì•ˆ ì„¤ì • (New) -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">ë³´ì•ˆ ì„¤ì •</h3>
                    <div class="flex flex-col space-y-4">
                        <button id="change-evaluation-password-btn" class="btn-warning text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
                    </div>
                </div>

                <!-- íƒ€ì´ë¨¸ ì„¤ì • (New) -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">íƒ€ì´ë¨¸ ì„¤ì •</h3>
                    <div class="flex flex-col space-y-4">
                        <button id="open-lunch-timer-settings-btn" class="btn-secondary text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ì ì‹¬ ì‹œê°„ ì„¤ì •</button>
                    </div>
                </div>

                <!-- ë°ì´í„° ê´€ë¦¬ (Moved from old section) -->
                <div class="bg-gray-50 p-6 rounded-xl shadow-md">
                    <h3 class="text-2xl font-semibold text-gray-700 mb-4">ë°ì´í„° ê´€ë¦¬</h3>
                    <div class="flex flex-col space-y-4">
                        <button id="export-data-btn" class="btn-primary text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200">ëª¨ë“  ë°ì´í„° ë‚´ë³´ë‚´ê¸° (ë‹¤ìš´ë¡œë“œ)</button>
                        <div class="flex items-center space-x-4">
                            <input type="file" id="import-file-input" accept=".json" class="hidden">
                            <label for="import-file-input" class="btn-accent text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200 cursor-pointer">ë°ì´í„° ê°€ì ¸ì˜¤ê¸° (ì—…ë¡œë“œ)</label>
                            <span id="import-file-name" class="text-gray-600">ì„ íƒëœ íŒŒì¼ ì—†ìŒ</span>
                            <button id="confirm-import-btn" class="btn-danger text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200 hidden">ê°€ì ¸ì˜¤ê¸° ì‹¤í–‰</button>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <!-- Footer -->
    <footer class="bg-gray-800 text-white p-4 text-center shadow-inner rounded-t-xl mt-6">
        <div class="flex justify-center items-center">
            <p id="footer-text-display" class="text-lg mr-2">Â© 2025 ìœ¡ê°œì¥ë°˜</p>
            <input type="text" id="footer-text-edit" class="footer-text-edit p-1 rounded text-gray-800 text-sm" style="width: 200px;">
            <button id="edit-footer-text" class="ml-2 text-white hover:text-gray-400">
                <i class="fas fa-pencil-alt"></i>
            </button>
        </div>
    </footer>

    <!-- Modals -->
    <!-- Student Management Modal -->
    <div id="student-modal" class="modal">
        <div class="modal-content w-full md:w-3/4 lg:w-2/3 xl:w-1/2">
            <span class="close-button" data-modal="student-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4">í•™ìƒ ëª…ë‹¨ ê´€ë¦¬</h3>
            <div class="mb-4">
                <input type="text" id="student-input" placeholder="í•™ìƒ ì´ë¦„ ì…ë ¥ í›„ Enter" class="w-full p-3 border rounded-lg text-lg focus:ring-blue-400 focus:border-blue-400">
            </div>
            <div class="max-h-60 overflow-y-auto border rounded-lg p-3 bg-gray-50">
                <ul id="student-list" class="space-y-2">
                    <!-- Students will be listed here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Assignment Management Modal -->
    <div id="assignment-modal" class="modal">
        <div class="modal-content w-full md:w-3/4 lg:w-2/3 xl:w-1/2">
            <span class="close-button" data-modal="assignment-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4">ê³¼ì œ ê´€ë¦¬</h3>
            <div class="mb-4">
                <input type="text" id="assignment-input" placeholder="ê³¼ì œëª… ì…ë ¥ í›„ Enter" class="w-full p-3 border rounded-lg text-lg focus:ring-blue-400 focus:border-blue-400">
            </div>
            <div class="max-h-60 overflow-y-auto border rounded-lg p-3 bg-gray-50">
                <ul id="assignment-list" class="space-y-2">
                    <!-- Assignments will be listed here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Assignment History Modal -->
    <div id="history-modal" class="modal">
        <div class="modal-content w-full md:w-3/4 lg:w-2/3 xl:w-1/2">
            <span class="close-button" data-modal="history-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4">ê³¼ì œ ìˆ˜í–‰ ì´ë ¥</h3>
            <div class="mb-4">
                <input type="date" id="history-date-picker" class="p-2 border rounded-lg">
            </div>
            <div id="history-content" class="max-h-96 overflow-y-auto border rounded-lg p-4 bg-gray-50">
                <!-- History content will be loaded here -->
                <p class="text-gray-600">ë‚ ì§œë¥¼ ì„ íƒí•˜ì—¬ ì´ë ¥ì„ í™•ì¸í•˜ì„¸ìš”.</p>
            </div>
        </div>
    </div>

    <!-- Evaluation/Attendance Password Modal (Reused) -->
    <div id="evaluation-password-modal" class="modal">
        <div class="modal-content w-full max-w-sm text-center">
            <span class="close-button" data-modal="evaluation-password-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4" id="password-modal-title">ë¹„ë°€ë²ˆí˜¸ ì…ë ¥</h3>
            <input type="password" id="evaluation-password-input" placeholder="ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 border rounded-lg text-lg text-center mb-4">
            <button id="evaluation-password-submit" class="btn-primary text-white px-6 py-3 rounded-lg transition-colors duration-200">í™•ì¸</button>
        </div>
    </div>

    <!-- Change Evaluation Password Modal -->
    <div id="change-evaluation-password-modal" class="modal">
        <div class="modal-content w-full max-w-sm text-center">
            <span class="close-button" data-modal="change-evaluation-password-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</h3>
            <input type="password" id="current-evaluation-password-input" placeholder="í˜„ì¬ ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 border rounded-lg text-lg text-center mb-2">
            <input type="password" id="new-evaluation-password-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸" class="w-full p-3 border rounded-lg text-lg text-center mb-2">
            <input type="password" id="confirm-new-evaluation-password-input" placeholder="ìƒˆ ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="w-full p-3 border rounded-lg text-lg text-center mb-4">
            <button id="change-evaluation-password-submit" class="btn-primary text-white px-6 py-3 rounded-lg transition-colors duration-200">ë¹„ë°€ë²ˆí˜¸ ë³€ê²½</button>
        </div>
    </div>

    <!-- Subject Management Modal -->
    <div id="subject-modal" class="modal">
        <div class="modal-content w-full md:w-3/4 lg:w-2/3 xl:w-1/2">
            <span class="close-button" data-modal="subject-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4">ê³¼ëª© ê´€ë¦¬</h3>
            <div class="mb-4">
                <input type="text" id="subject-input" placeholder="ê³¼ëª©ëª… ì…ë ¥ í›„ Enter" class="w-full p-3 border rounded-lg text-lg focus:ring-blue-400 focus:border-blue-400">
            </div>
            <div class="max-h-60 overflow-y-auto border rounded-lg p-3 bg-gray-50">
                <ul id="subject-list" class="space-y-2">
                    <!-- Subjects will be listed here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Unit Test Management Modal -->
    <div id="unit-test-modal" class="modal">
        <div class="modal-content w-full md:w-3/4 lg:w-2/3 xl:w-1/2">
            <span class="close-button" data-modal="unit-test-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4"><span id="unit-test-subject-name"></span> ë‹¨ì›í‰ê°€ ê´€ë¦¬</h3>
            <div class="mb-4">
                <input type="text" id="unit-test-input" placeholder="ë‹¨ì›í‰ê°€ëª… ì…ë ¥ í›„ Enter" class="w-full p-3 border rounded-lg text-lg focus:ring-blue-400 focus:border-blue-400">
            </div>
            <div class="max-h-60 overflow-y-auto border rounded-lg p-3 bg-gray-50">
                <ul id="unit-test-list" class="space-y-2">
                    <!-- Unit tests will be listed here -->
                </ul>
            </div>
        </div>
    </div>

    <!-- Custom Alert/Confirm Modal -->
    <div id="custom-alert-modal" class="modal">
        <div class="modal-content w-full max-w-sm text-center">
            <p id="custom-alert-message" class="text-xl font-semibold mb-6"></p>
            <div class="flex justify-center space-x-4">
                <button id="custom-alert-ok-btn" class="btn-primary text-white px-6 py-3 rounded-lg transition-colors duration-200">í™•ì¸</button>
                <button id="custom-alert-cancel-btn" class="bg-gray-300 text-gray-800 px-6 py-3 rounded-lg hover:bg-gray-400 transition-colors duration-200 hidden">ì·¨ì†Œ</button>
            </div>
        </div>
    </div>

<!-- ì¼ì • ëª¨ë‹¬ -->
<div id="calendar-event-modal" class="modal" style="display:none; align-items:center; justify-content:center;">
  <div class="modal-content w-full max-w-md">
    <span class="close-button" onclick="document.getElementById('calendar-event-modal').style.display='none'">&times;</span>
    <h3 class="text-2xl font-bold mb-4" id="modal-date-title">ì¼ì •</h3>

    <!-- ê¸°ì¡´ ì¼ì • ëª©ë¡ -->
    <div id="event-list" class="mb-3 max-h-44 overflow-y-auto p-2 border rounded bg-gray-50"></div>

    <!-- ìƒˆ ì¼ì • ì¶”ê°€ -->
    <input type="text" id="event-title" placeholder="ì œëª©" class="w-full p-2 border rounded-lg mb-2">
    <textarea id="event-description" placeholder="ë‚´ìš©" class="w-full p-2 border rounded-lg mb-2" rows="3"></textarea>
    <input type="time" id="event-time" class="w-full p-2 border rounded-lg mb-3">

    <div class="flex justify-between gap-2">
      <button id="add-event-btn" class="btn-accent text-white px-4 py-2 rounded-lg">ì¶”ê°€</button>
      <button id="delete-all-events-btn" class="btn-danger text-white px-4 py-2 rounded-lg">ì „ì²´ ì‚­ì œ</button>
      <button id="close-event-modal-btn" class="btn-secondary text-white px-4 py-2 rounded-lg">ë‹«ê¸°</button>
    </div>
  </div>
</div>


    <!-- Monthly Attendance Statistics Modal -->
    <div id="monthly-stats-modal" class="modal">
        <div class="modal-content w-full md:w-3/4 lg:w-2/3 xl:w-1/2">
            <span class="close-button" data-modal="monthly-stats-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4">ì›”ë³„ ì¶œê²° í†µê³„ (<span id="stats-month-display"></span>)</h3>
            <div class="max-h-96 overflow-y-auto border rounded-lg p-3 bg-gray-50">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="sticky top:0">
                        <tr>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">í•™ìƒëª…</th>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">ìˆ˜ì—… ì¼ìˆ˜</th>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">ì¶œì„</th>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">ê²°ì„</th>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">ì§€ê°</th>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">ì¡°í‡´</th>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">ê²°ê³¼</th>
                        </tr>
                    </thead>
                    <tbody id="monthly-stats-table-body" class="divide-y divide-gray-200">
                        <!-- Stats rows will be injected here by JS -->
                    </tbody>
                </table>
                <p id="no-stats-message" class="text-gray-600 text-center py-4 hidden">í†µê³„ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- Student Attendance Detail Modal (New) -->
    <div id="student-attendance-detail-modal" class="modal">
        <div class="modal-content w-full md:w-3/4 lg:w-2/3 xl:w-1/2">
            <span class="close-button" data-modal="student-attendance-detail-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4"><span id="detail-student-name"></span> í•™ìƒ ì¶œê²° ë‚´ì—­ (<span id="detail-month-display"></span>)</h3>
            <div class="max-h-96 overflow-y-auto border rounded-lg p-3 bg-gray-50">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-200 sticky top:0">
                        <tr>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">ë‚ ì§œ</th>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">ìš”ì¼</th>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">ìƒíƒœ</th>
                            <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">ìƒì„¸</th>
                        </tr>
                    </thead>
                    <tbody id="student-attendance-detail-table-body" class="divide-y divide-gray-200">
                        <!-- Detail rows will be injected here by JS -->
                    </tbody>
                </table>
                <p id="no-detail-message" class="text-gray-600 text-center py-4 hidden">ìƒì„¸ ì¶œê²° ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>


    <!-- No Class Days Modal -->
    <div id="no-class-days-modal" class="modal">
        <div class="modal-content w-full md:w-1/2 lg:w-1/3">
            <span class="close-button" data-modal="no-class-days-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4">ìˆ˜ì—… ì—†ëŠ” ë‚  ì„¤ì • (<span id="no-class-month-display"></span>)</h3>
            <div class="mb-4">
                <input type="date" id="no-class-date-input" class="w-full p-3 border rounded-lg text-lg focus:ring-blue-400 focus:border-blue-400">
                <button id="add-no-class-day-btn" class="mt-3 btn-primary text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200 w-full">ìˆ˜ì—… ì—†ëŠ” ë‚  ì¶”ê°€</button>
            </div>
            <div class="max-h-60 overflow-y-auto border rounded-lg p-3 bg-gray-50">
                <ul id="no-class-days-list" class="space-y-2">
                    <!-- No class days will be listed here -->
                </ul>
                <p id="no-no-class-days-message" class="text-gray-500 text-center py-2 hidden">ë“±ë¡ëœ ìˆ˜ì—… ì—†ëŠ” ë‚ ì´ ì—†ìŠµë‹ˆë‹¤.</p>
            </div>
        </div>
    </div>

    <!-- Batch Attendance Modal -->
    <div id="batch-attendance-modal" class="modal">
        <div class="modal-content w-full md:w-3/4 lg:w-2/3 xl:w-1/2">
            <span class="close-button" data-modal="batch-attendance-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4">ì¼ê´„ ì¶œê²° ì…ë ¥</h3>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">
                <div>
                    <label for="batch-start-date" class="block text-gray-700 text-sm font-bold mb-2">ì‹œì‘ì¼:</label>
                    <input type="date" id="batch-start-date" class="w-full p-2 border rounded-lg">
                </div>
                <div>
                    <label for="batch-end-date" class="block text-gray-700 text-sm font-bold mb-2">ì¢…ë£Œì¼:</label>
                    <input type="date" id="batch-end-date" class="w-full p-2 border rounded-lg">
                </div>
            </div>
            <div class="mb-4">
                <label for="batch-attendance-status" class="block text-gray-700 text-sm font-bold mb-2">ì¶œê²° ìƒíƒœ:</label>
                <select id="batch-attendance-status" class="w-full p-2 border rounded-lg">
                    <!-- Options will be dynamically populated by JS -->
                </select>
            </div>
            <div class="mb-4" id="batch-attendance-detail-container">
                <label for="batch-attendance-detail" class="block text-gray-700 text-sm font-bold mb-2">ìƒì„¸:</label>
                <select id="batch-attendance-detail" class="w-full p-2 border rounded-lg">
                    <!-- Options will be dynamically populated by JS -->
                </select>
            </div>
            <div class="mb-4">
                <label class="block text-gray-700 text-sm font-bold mb-2">í•™ìƒ ì„ íƒ:</label>
                <div id="batch-student-selection" class="max-h-40 overflow-y-auto border rounded-lg p-3 bg-gray-50 grid grid-cols-2 gap-2">
                    <!-- Student checkboxes will be injected here -->
                </div>
            </div>
            <button id="apply-batch-attendance-btn" class="btn-primary text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200 w-full">ì ìš©</button>
        </div>
    </div>

    <!-- Lunch Timer Settings Modal (New) -->
    <div id="lunch-timer-settings-modal" class="modal">
        <div class="modal-content w-full max-w-sm text-center">
            <span class="close-button" data-modal="lunch-timer-settings-modal">&times;</span>
            <h3 class="text-2xl font-bold mb-4">ì ì‹¬ ì‹œê°„ ì„¤ì •</h3>
            <div class="mb-4 flex flex-col items-center space-y-4">
                <div class="flex items-center space-x-2">
                    <label for="modal-lunch-start-time" class="text-lg text-gray-700">ì‹œì‘ ì‹œê°„:</label>
                    <input type="time" id="modal-lunch-start-time" class="p-2 border rounded-lg text-lg">
                </div>
                <div class="flex items-center space-x-2">
                    <label for="modal-lunch-end-time" class="text-lg text-gray-700">ì¢…ë£Œ ì‹œê°„:</label>
                    <input type="time" id="modal-lunch-end-time" class="p-2 border rounded-lg text-lg">
                </div>
            </div>
            <button id="save-lunch-times-btn-modal" class="btn-primary text-white px-6 py-3 rounded-lg transition-colors duration-200">ì €ì¥</button>
        </div>
    </div>

    <script>
        // Global application state
    window.appData = {
            settings: {
                headerTitle: 'ìœ¡ê°œì¥ë°˜ í•™ê¸‰ ìš´ì˜ ì‹œìŠ¤í…œ',
                footerText: 'Â© 2025 ìœ¡ê°œì¥ë°˜',
                lunchTimer: {
                    startTime: '12:20',
                    endTime: '13:10'
                },
                currentTheme: 'default'
            },
            students: [], // [{ id: 's1', name: 'í•™ìƒ1' }]
            assignments: [], // ['êµ­ì–´', 'ìˆ˜í•™']
            dailyAssignments: {}, // { 's1': { 'êµ­ì–´': true, 'ìˆ˜í•™': false }, ... }
            assignmentHistory: {}, // { 'YYYY-MM-DD': { dailyAssignments: {}, assignments: [], noticeContent: '' } }
            notice: {
                content: '',
                fontFamily: 'Inter',
                fontSize: 30,
                lastSavedDate: '' // YYYY-MM-DD
            },
            memos: [], // [{ id: 'm1', content: 'ì²« ë©”ëª¨' }]
            lottery: {
                studentHistory: [],
                numberHistory: [],
                pickedStudents: [],
                pickedNumbers: []
            },
            evaluations: [], // [{ id: 'sub1', name: 'êµ­ì–´', units: [{ id: 'unit1', name: '1ë‹¨ì›', results: { 's1': { grade: 'ìƒ', score: 90 } } }] }]
            attendance: {}, // { 'YYYY-MM': { studentId: { 'DD': { status: 'ê²°ì„', detail: 'ì§ˆë³‘' } } } }
            currentAttendanceMonth: '', // YYYY-MM
            noClassDays: {}, // { 'YYYY-MM': ['DD', 'DD', ...] }
            currentSection: 'authSection' // Track current active section - Changed to authSection
        };

        // DOM Elements
        const headerTitleDisplay = document.getElementById('header-title-display');
        const headerTitleEdit = document.getElementById('header-title-edit');
        const editHeaderTitleBtn = document.getElementById('edit-header-title');
        const footerTextDisplay = document.getElementById('footer-text-display');
        const footerTextEdit = document.getElementById('footer-text-edit');
        const editFooterTextBtn = document.getElementById('edit-footer-text');
        const currentDateDisplay = document.getElementById('current-date-display');
        const currentTimeDisplay = document.getElementById('current-time-display');

        // New auth status and user ID display elements
        const authStatusSpan = document.getElementById('auth-status-settings');
        const currentAuthIdDisplay = document.getElementById('current-auth-id-display-settings'); // í˜„ì¬ ì¸ì¦ëœ ì‚¬ìš©ì ID
        const loadedDataIdDisplay = document.getElementById('loaded-data-id-display-settings'); // ë¶ˆëŸ¬ì˜¨ ë°ì´í„°ì˜ ID
        const anonymousIdInput = document.getElementById('anonymous-id-input');
        const loadAnonymousDataBtn = document.getElementById('load-anonymous-data-btn');

        // Email/Password Auth elements
        const emailInput = document.getElementById('email-input');
        const passwordInput = document.getElementById('password-input');
        const signupBtn = document.getElementById('signup-btn');
        const signinBtn = document.getElementById('signin-btn');


        const navButtons = document.querySelectorAll('.nav-button');
        const sections = document.querySelectorAll('.section');
        const mainContainer = document.querySelector('main.container');

        // Assignment Check elements
        const manageStudentsBtn = document.getElementById('manage-students-btn');
        const manageAssignmentsBtn = document.getElementById('manage-assignments-btn');
        const viewHistoryBtn = document.getElementById('view-history-btn');
        const assignmentTableBody = document.getElementById('assignment-table-body');

        // Modals
        const studentModal = document.getElementById('student-modal');
        const studentInput = document.getElementById('student-input');
        const studentList = document.getElementById('student-list');

        const assignmentModal = document.getElementById('assignment-modal');
        const assignmentInput = document.getElementById('assignment-input');
        const assignmentList = document.getElementById('assignment-list');

        const historyModal = document.getElementById('history-modal');
        const historyDatePicker = document.getElementById('history-date-picker');
        const historyContent = document.getElementById('history-content');

        const customAlertModal = document.getElementById('custom-alert-modal');
        const customAlertMessage = document.getElementById('custom-alert-message');
        const customAlertOkBtn = document.getElementById('custom-alert-ok-btn');
        const customAlertCancelBtn = document.getElementById('custom-alert-cancel-btn');

        const closeButtons = document.querySelectorAll('.close-button');

        // Timer elements
        const showLunchTimerBtn = document.getElementById('show-lunch-timer-btn');
        const showManualTimerBtn = document.getElementById('show-manual-timer-btn');
        const lunchTimerContainer = document.getElementById('lunch-timer-container');
        const manualTimerContainer = document.getElementById('manual-timer-container');
        const timerDisplay = document.getElementById('timer-display');
        const lunchTimerMessage = document.getElementById('lunch-timer-message');
        const manualTimerMinutes = document.getElementById('manual-timer-minutes');
        const manualTimerSeconds = document.getElementById('manual-timer-seconds');
        const startManualTimerBtn = document.getElementById('start-manual-timer-btn');
        const manualTimerDisplay = document.getElementById('manual-timer-display');
        const lunchTimerSettingsModal = document.getElementById('lunch-timer-settings-modal');
        const modalLunchStartTimeInput = document.getElementById('modal-lunch-start-time');
        const modalLunchEndTimeInput = document.getElementById('modal-lunch-end-time');
        const saveLunchTimesBtnModal = document.getElementById('save-lunch-times-btn-modal');

        let currentTimerInterval;
        let isTimerActive = false;
        let timerType = 'lunch'; // 'lunch' or 'manual'

        // Lottery elements
        const showStudentLotteryBtn = document.getElementById('show-student-lottery-btn');
        const showNumberLotteryBtn = document.getElementById('show-number-lottery-btn');
        const studentLotteryContainer = document.getElementById('student-lottery-container');
        const numberLotteryContainer = document.getElementById('number-lottery-container');
        const studentPickCountInput = document.getElementById('student-pick-count');
        const startStudentLotteryBtn = document.getElementById('start-student-lottery-btn');
        const studentLotteryResultDisplay = document.getElementById('student-lottery-result-display');
        const currentLotteryResult = document.getElementById('current-lottery-result');
        const lotteryHistoryList = document.getElementById('lottery-history-list');
        const numberMinInput = document.getElementById('number-min');
        const numberMaxInput = document.getElementById('number-max');
        const numberPickCountInput = document.getElementById('number-pick-count');
        const startNumberLotteryBtn = document.getElementById('start-number-lottery-btn');
        const numberLotteryResultDisplay = document.getElementById('number-lottery-result-display');
        const numberLotteryHistoryList = document.getElementById('number-lottery-history-list');

        // Notice Board elements
        const noticeDate = document.getElementById('notice-date');
        const noticeFontFamily = document.getElementById('notice-font-family');
        const noticeFontSize = document.getElementById('notice-font-size');
        const noticeContent = document.getElementById('notice-content');
        const loadPrevNoticeBtn = document.getElementById('load-prev-notice-btn');
        const copyNoticeBtn = document.getElementById('copy-notice-btn');

        // Memo elements
        const addMemoBtn = document.getElementById('add-memo-btn');
        const memoList = document.getElementById('memo-list');
        let memoSaveTimeout;

        // Data Management elements (now inside Settings section)
        const exportDataBtn = document.getElementById('export-data-btn');
        const importFileInput = document.getElementById('import-file-input');
        const importFileNameSpan = document.getElementById('import-file-name');
        const confirmImportBtn = document.getElementById('confirm-import-btn');

        // Evaluation elements
        const evaluationPasswordModal = document.getElementById('evaluation-password-modal');
        const passwordModalTitle = document.getElementById('password-modal-title');
        const evaluationPasswordInput = document.getElementById('evaluation-password-input');
        const evaluationPasswordSubmit = document.getElementById('evaluation-password-submit');
        const changeEvaluationPasswordBtn = document.getElementById('change-evaluation-password-btn');
        const changeEvaluationPasswordModal = document.getElementById('change-evaluation-password-modal');
        const currentEvaluationPasswordInput = document.getElementById('current-evaluation-password-input');
        const newEvaluationPasswordInput = document.getElementById('new-evaluation-password-input');
        const confirmNewEvaluationPasswordInput = document.getElementById('confirm-new-evaluation-password-input');
        const changeEvaluationPasswordSubmit = document.getElementById('change-evaluation-password-submit');
        const manageSubjectsBtn = document.getElementById('manage-subjects-btn');
        const subjectModal = document.getElementById('subject-modal');
        const subjectInput = document.getElementById('subject-input');
        const subjectList = document.getElementById('subject-list');
        const unitTestModal = document.getElementById('unit-test-modal');
        const unitTestSubjectName = document.getElementById('unit-test-subject-name');
        const unitTestInput = document.getElementById('unit-test-input');
        const unitTestList = document.getElementById('unit-test-list');
        const evaluationTableHeader = document.getElementById('evaluation-table-header');
        const evaluationTableBody = document.getElementById('evaluation-table-body');

        let currentSubjectIdForUnitTests = null;

        // Attendance elements
        const attendanceMonthPicker = document.getElementById('attendance-month-picker');
        const prevMonthBtn = document.getElementById('prev-month-btn');
        const nextMonthBtn = document.getElementById('next-month-btn');
        const attendanceTableHeader = document.getElementById('attendance-table-header');
        const attendanceTableBody = document.getElementById('attendance-table-body');
        const viewMonthlyStatsBtn = document.getElementById('view-monthly-stats-btn');
        const monthlyStatsModal = document.getElementById('monthly-stats-modal');
        const statsMonthDisplay = document.getElementById('stats-month-display');
        const monthlyStatsTableBody = document.getElementById('monthly-stats-table-body');
        const noStatsMessage = document.getElementById('no-stats-message');
        const batchAttendanceBtn = document.getElementById('batch-attendance-btn');
        const batchAttendanceModal = document.getElementById('batch-attendance-modal');
        const batchStartDateInput = document.getElementById('batch-start-date');
        const batchEndDateInput = document.getElementById('batch-end-date');
        const batchAttendanceStatusSelect = document.getElementById('batch-attendance-status');
        const batchAttendanceDetailSelect = document.getElementById('batch-attendance-detail');
        const batchAttendanceDetailContainer = document.getElementById('batch-attendance-detail-container');
        const batchStudentSelectionDiv = document.getElementById('batch-student-selection');
        const applyBatchAttendanceBtn = document.getElementById('apply-batch-attendance-btn');

        // Student Attendance Detail Modal elements
        const studentAttendanceDetailModal = document.getElementById('student-attendance-detail-modal');
        const detailStudentName = document.getElementById('detail-student-name');
        const detailMonthDisplay = document.getElementById('detail-month-display');
        const studentAttendanceDetailTableBody = document.getElementById('student-attendance-detail-table-body');
        const noDetailMessage = document.getElementById('no-detail-message');

        // No Class Days elements
        const manageNoClassDaysBtn = document.getElementById('manage-no-class-days-btn');
        const noClassDaysModal = document.getElementById('no-class-days-modal');
        const noClassMonthDisplay = document.getElementById('no-class-month-display');
        const noClassDateInput = document.getElementById('no-class-date-input');
        const addNoClassDayBtn = document.getElementById('add-no-class-day-btn');
        const noClassDaysList = document.getElementById('no-class-days-list');
        const noNoClassDaysMessage = document.getElementById('no-no-class-days-message');

        // Settings elements
        const openLunchTimerSettingsBtn = document.getElementById('open-lunch-timer-settings-btn');
        const themeSelectionDiv = document.getElementById('theme-selection');

        const ATTENDANCE_STATUSES = {
            'ì¶œì„': 'ì¶œì„',
            'ê²°ì„': 'ê²°ì„',
            'ì§€ê°': 'ì§€ê°',
            'ì¡°í‡´': 'ì¡°í‡´',
            'ê²°ê³¼': 'ê²°ê³¼'
        };
        const ATTENDANCE_DETAILS = {
            '': 'ì„ íƒ',
            'ì§ˆë³‘': 'ì§ˆë³‘',
            'ë¯¸ì¸ì •': 'ë¯¸ì¸ì •',
            'ê¸°íƒ€': 'ê¸°íƒ€',
            'ì¶œì„ì¸ì •': 'ì¶œì„ì¸ì •'
        };
        const EVALUATION_GRADES = ['', 'ìƒ', 'ì¤‘', 'í•˜'];
        // í…Œë§ˆ ì •ì˜ ê°ì²´
        const THEMES = {
            'default': {
                name: 'ê¸°ë³¸ í…Œë§ˆ',
                bodyBg: '#f0f4f8',
                headerBg: '#2563eb', // blue-600
                navButtonActiveBg: '#1d4ed8', // blue-700
                navButtonHoverBg: '#1d4ed8', // blue-700
                primaryBtnBg: '#3b82f6', // blue-500
                primaryBtnHoverBg: '#2563eb', // blue-600
                secondaryBtnBg: '#8b5cf6', // purple-500
                secondaryBtnHoverBg: '#7c3aed', // purple-600
                accentBtnBg: '#10b981', // green-500
                accentBtnHoverBg: '#059669', // green-600
                warningBtnBg: '#f59e0b', // yellow-500
                warningBtnHoverBg: '#d97706', // yellow-600
                dangerBtnBg: '#ef4444', // red-500
                dangerBtnHoverBg: '#dc2626', // red-600
                infoBtnBg: '#6366f1', // indigo-500
                infoBtnHoverBg: '#4f46e5', // indigo-600
                tealBtnBg: '#14b8a6', // teal-500
                tealBtnHoverBg: '#0d9488', // teal-600
                orangeBtnBg: '#f97316', // orange-500
                orangeBtnHoverBg: '#ea580c', // orange-600
                timerColor: '#3b82f6', // blue-500
                timerWarningColor: '#ef4444', // red-500
                lotteryCardBg: '#6366f1', // indigo-500
                lotteryResultBg: '#dbeafe', // blue-100
                tableHeaderBg: '#e2e8f0', // gray-200
                tableRowEvenBg: '#f7fafc', // gray-50
                tableRowOddBg: '#ffffff', // white
                progressBg: '#e0e7ff', // light blue
                progressFill: '#6366f1', // indigo-500
                progressText: '#4338ca', // indigo-700
                modalBg: '#fefefe',
                inputBorder: '#d1d5db',
                textPrimary: '#1f2937', // gray-800
                textSecondary: '#4a5568', // gray-700
                textLight: '#4b5563', // gray-600
                border: '#cbd5e0', // gray-300
                borderLight: '#edf2f7', // gray-200
            },
            'green-forest': {
                name: 'ì´ˆë¡ ìˆ² í…Œë§ˆ',
                bodyBg: '#dcfce7', // green-100
                headerBg: '#16a34a', // green-600
                navButtonActiveBg: '#15803d', // green-700
                navButtonHoverBg: '#15803d', // green-700
                primaryBtnBg: '#22c55e', // green-500
                primaryBtnHoverBg: '#16a34a', // green-600
                secondaryBtnBg: '#65a30d', // lime-600
                secondaryBtnHoverBg: '#4d7c0f', // lime-700
                accentBtnBg: '#0ea5e9', // sky-500
                accentBtnHoverBg: '#0284c7', // sky-600
                warningBtnBg: '#eab308', // yellow-500
                warningBtnHoverBg: '#ca8a04', // yellow-600
                dangerBtnBg: '#dc2626', // red-600
                dangerBtnHoverBg: '#b91c1c', // red-700
                infoBtnBg: '#4ade80', // green-400
                infoBtnHoverBg: '#22c55e', // green-500
                tealBtnBg: '#0d9488', // teal-600
                tealBtnHoverBg: '#0f766e', // teal-700
                orangeBtnBg: '#f97316', // orange-500
                orangeBtnHoverBg: '#ea580c', // orange-600
                timerColor: '#16a34a', // green-600
                timerWarningColor: '#dc2626', // red-600
                lotteryCardBg: '#22c55e', // green-500
                lotteryResultBg: '#dcfce7', // green-100
                tableHeaderBg: '#d1fae5', // green-200
                tableRowEvenBg: '#f0fdf4', // green-50
                tableRowOddBg: '#ffffff',
                progressBg: '#dcfce7', // green-100
                progressFill: '#16a34a', // green-600
                progressText: '#15803d', // green-700
                modalBg: '#fefefe',
                inputBorder: '#d1d5db',
                textPrimary: '#1f2937',
                textSecondary: '#4a5568',
                textLight: '#4b5563',
                border: '#cbd5e0',
                borderLight: '#edf2f7',
            },
            'purple-haze': {
                name: 'ë³´ë¼ ì•ˆê°œ í…Œë§ˆ',
                bodyBg: '#ede9fe', // purple-100
                headerBg: '#7c3aed', // purple-600
                navButtonActiveBg: '#6d28d9', // purple-700
                navButtonHoverBg: '#6d28d9', // purple-700
                primaryBtnBg: '#a855f7', // purple-500
                primaryBtnHoverBg: '#9333ea', // purple-600
                secondaryBtnBg: '#8b5cf6', // violet-500
                secondaryBtnHoverBg: '#7c3aed', // violet-600
                accentBtnBg: '#ec4899', // pink-500
                accentBtnHoverBg: '#db2777', // pink-600
                warningBtnBg: '#fbbf24', // amber-400
                warningBtnHoverBg: '#f59e0b', // amber-500
                dangerBtnBg: '#ef4444', // red-500
                dangerBtnHoverBg: '#dc2626', // red-600
                infoBtnBg: '#c084fc', // purple-400
                infoBtnHoverBg: '#a855f7', // purple-500
                tealBtnBg: '#2dd4bf', // teal-400
                tealBtnHoverBg: '#14b8a6', // teal-500
                orangeBtnBg: '#f97316', // orange-500
                orangeBtnHoverBg: '#ea580c', // orange-600
                timerColor: '#a855f7', // purple-500
                timerWarningColor: '#ef4444', // red-500
                lotteryCardBg: '#a855f7', // purple-500
                lotteryResultBg: '#f3e8ff', // purple-100
                tableHeaderBg: '#d8b4fe', // purple-300
                tableRowEvenBg: '#f3e8ff', // purple-100
                tableRowOddBg: '#ffffff',
                progressBg: '#e9d5ff', // purple-200
                progressFill: '#7c3aed', // purple-600
                progressText: '#6d28d9', // purple-700
                modalBg: '#fefefe',
                inputBorder: '#d1d5db',
                textPrimary: '#1f2937',
                textSecondary: '#4a5568',
                textLight: '#4b5563',
                border: '#cbd5e0',
                borderLight: '#edf2f7',
            },
            'sky-blue': {
                name: 'ìŠ¤ì¹´ì´ë¸”ë£¨ í…Œë§ˆ',
                bodyBg: '#e0f7fa', // ì—°í•œ í•˜ëŠ˜ìƒ‰
                headerBg: '#4fc3f7', // ë°ì€ íŒŒë‘
                navButtonActiveBg: '#039be5', // ì§„í•œ í•˜ëŠ˜ìƒ‰
                navButtonHoverBg: '#0288d1', // hover ì§„í•œ íŒŒë‘
                primaryBtnBg: '#4fc3f7',
                primaryBtnHoverBg: '#039be5',
                secondaryBtnBg: '#b3e5fc', // ì—°í•œ íŒŒë‘
                secondaryBtnHoverBg: '#4fc3f7',
                accentBtnBg: '#00bcd4', // ì²­ë¡
                accentBtnHoverBg: '#008ba3',
                warningBtnBg: '#ffd54f', // ë…¸ë‘
                warningBtnHoverBg: '#ffb300',
                dangerBtnBg: '#e57373', // ì—°í•œ ë¹¨ê°•
                dangerBtnHoverBg: '#d32f2f',
                infoBtnBg: '#4fc3f7',
                infoBtnHoverBg: '#039be5',
                tealBtnBg: '#4dd0e1',
                tealBtnHoverBg: '#00acc1',
                orangeBtnBg: '#ffb74d',
                orangeBtnHoverBg: '#ffa726',
                timerColor: '#039be5',
                timerWarningColor: '#e57373',
                lotteryCardBg: '#4fc3f7',
                lotteryResultBg: '#e0f7fa',
                tableHeaderBg: '#b3e5fc',
                tableRowEvenBg: '#e1f5fe',
                tableRowOddBg: '#ffffff',
                progressBg: '#b3e5fc',
                progressFill: '#039be5',
                progressText: '#039be5',
                modalBg: '#e1f5fe',
                inputBorder: '#4fc3f7',
                textPrimary: '#01579b',
                textSecondary: '#0277bd',
                textLight: '#4fc3f7',
                border: '#4fc3f7',
                borderLight: '#b3e5fc',
            },
            'coral-blue': {
                name: 'ì½”ë„ ë¸”ë£¨ í…Œë§ˆ',
                bodyBg: '#f9fafc', // very light blue
                headerBg: '#457b9d', // blue
                navButtonActiveBg: '#ff6f61', // coral
                navButtonHoverBg: '#ff8a65', // coral hover
                primaryBtnBg: '#ff6f61', // coral
                primaryBtnHoverBg: '#ff8a65', // coral hover
                secondaryBtnBg: '#457b9d', // blue
                secondaryBtnHoverBg: '#1d3557', // deep blue
                accentBtnBg: '#48cae4', // sky blue
                accentBtnHoverBg: '#00b4d8', // sky blue hover
                warningBtnBg: '#ffd166', // yellow
                warningBtnHoverBg: '#fcb900',
                dangerBtnBg: '#ef476f', // pink red
                dangerBtnHoverBg: '#d90429',
                infoBtnBg: '#118ab2', // blue
                infoBtnHoverBg: '#073b4c',
                tealBtnBg: '#06d6a0',
                tealBtnHoverBg: '#1b9aaa',
                orangeBtnBg: '#ffd166',
                orangeBtnHoverBg: '#fcb900',
                timerColor: '#ff6f61',
                timerWarningColor: '#ef476f',
                lotteryCardBg: '#48cae4',
                lotteryResultBg: '#f9fafc',
                tableHeaderBg: '#a8dadc',
                tableRowEvenBg: '#f1faee',
                tableRowOddBg: '#ffffff',
                progressBg: '#a8dadc',
                progressFill: '#457b9d',
                progressText: '#457b9d',
                modalBg: '#f1faee',
                inputBorder: '#457b9d',
                textPrimary: '#1d3557',
                textSecondary: '#457b9d',
                textLight: '#adb5bd',
                border: '#a8dadc',
                borderLight: '#f1faee',
            },
        };


        // --- Utility Functions ---
        function generateUniqueId() {
            return '_' + Math.random().toString(36).substr(2, 9);
        }

        // Save data to Local Storage (now primarily a backup/cache)
        function saveDataToLocalStorageBackup() {
            try {
                localStorage.setItem('classManagementAppData', JSON.stringify(appData));
                console.log('Data saved to Local Storage (backup/cache) successfully.');
            } catch (e) {
                console.error('Error saving data to Local Storage (backup/cache):', e);
                showCustomAlert('ë¡œì»¬ ë°ì´í„° ì €ì¥ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì €ì¥ ê³µê°„ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }

        // Load data from Local Storage (now primarily a fallback)
        function loadDataFromLocalStorageBackup() {
            try {
                const storedData = localStorage.getItem('classManagementAppData');
                if (storedData) {
                    const parsedData = JSON.parse(storedData);
                    // Merge loaded data with default appData to handle new properties gracefully
                    appData = { ...appData, ...parsedData };
                    console.log('Data loaded from Local Storage (fallback).');
                } else {
                    console.log('No data found in Local Storage (fallback). Using default appData.');
                }
            } catch (e) {
                console.error('Error loading data from Local Storage (fallback):', e);
                showCustomAlert('ë¡œì»¬ ë°ì´í„° ë¡œë“œì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì €ì¥ ê³µê°„ì„ í™•ì¸í•˜ê±°ë‚˜ ë‚˜ì¤‘ì— ë‹¤ì‹œ ì‹œë„í•´ì£¼ì„¸ìš”.');
            }
        }

        // Consolidated UI rendering function
        function renderAllUI() {
            applyTheme(appData.settings.currentTheme);
            updateHeaderFooter();
            renderAssignmentTable();
            renderStudentList();
            renderAssignmentList();
            updateNoticeBoard();
            renderMemos();
            renderLotteryHistory();
            renderAttendanceTable();
            renderEvaluationTable();
            populateThemeSelection();
            // ìº˜ë¦°ë” ë Œë”ë§ ì¶”ê°€
            if (typeof renderCalendar === 'function' && typeof viewYear !== 'undefined' && typeof viewMonth !== 'undefined') {
                renderCalendar(viewYear, viewMonth);
            }
            // ë³´í˜¸ ì„¹ì…˜(evaluationResults, attendanceManagement) ì§„ì… ì‹œ ì¸ì¦ ìš”êµ¬
            const protectedSections = ['evaluationResults', 'attendanceManagement'];
            if (protectedSections.includes(appData.currentSection)) {
                showSection('main'); // ë©”ì¸ ë“± ê³µê°œ ì„¹ì…˜ìœ¼ë¡œ ì´ë™
            } else {
                showSection(appData.currentSection, true);
            }
        }


// ê¸°ì¡´ showCustomAlert() í•¨ìˆ˜ì˜ ì •ì˜ë¥¼ ì°¾ì•„ì„œ ì•„ë˜ ì½”ë“œë¡œ ì™„ì „íˆ êµì²´í•©ë‹ˆë‹¤.
async function showCustomAlert(message, isConfirm = false) {
    const modalOverlay = document.getElementById('customModalOverlay');
    const modalMessage = document.getElementById('modalMessage');
    const modalConfirmBtn = document.getElementById('modalConfirmBtn');
    const modalCancelBtn = document.getElementById('modalCancelBtn');

    modalMessage.textContent = message;
    // isConfirmì´ trueì¼ ë•Œë§Œ 'ì·¨ì†Œ' ë²„íŠ¼ì„ ë³´ì´ê²Œ í•©ë‹ˆë‹¤.
    modalCancelBtn.classList.toggle('hidden', !isConfirm); 

    modalOverlay.classList.remove('hidden'); // ëª¨ë‹¬ì„ ë³´ì´ê²Œ í•¨
    setTimeout(() => { modalConfirmBtn.focus(); }, 10); // í™•ì¸ ë²„íŠ¼ì— í¬ì»¤ìŠ¤

    return new Promise(resolve => {
        const handleConfirm = () => {
            modalOverlay.classList.add('hidden'); // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
            modalConfirmBtn.removeEventListener('click', handleConfirm);
            modalCancelBtn.removeEventListener('click', handleCancel);
            document.removeEventListener('keydown', handleEnterKey, true);
            resolve(true); // 'í™•ì¸' í´ë¦­ ì‹œ true ë°˜í™˜
        };
        const handleCancel = () => {
            modalOverlay.classList.add('hidden'); // ëª¨ë‹¬ ìˆ¨ê¸°ê¸°
            modalConfirmBtn.removeEventListener('click', handleConfirm);
            modalCancelBtn.removeEventListener('click', handleCancel);
            document.removeEventListener('keydown', handleEnterKey, true);
            resolve(false); // 'ì·¨ì†Œ' í´ë¦­ ì‹œ false ë°˜í™˜
        };
        // Enter/Esc í‚¤ í•¸ë“¤ëŸ¬
        const handleEnterKey = (e) => {
            if (modalOverlay.classList.contains('hidden')) return;
            if (e.key === 'Enter') {
                e.preventDefault();
                modalConfirmBtn.click();
            } else if (e.key === 'Escape' && isConfirm && !modalCancelBtn.classList.contains('hidden')) {
                e.preventDefault();
                modalCancelBtn.click();
            }
        };
        document.addEventListener('keydown', handleEnterKey, true);
        modalConfirmBtn.addEventListener('click', handleConfirm);
        if (isConfirm) {
            modalCancelBtn.addEventListener('click', handleCancel);
        }
    });
}

        // --- Initial App Setup ---
        // This function will be called by setupFirebaseAuthAndFirestore after auth state is determined
        async function initializeUIAndData() {
            try {
                console.log('initializeUIAndData: Starting UI and data rendering.');

                applyTheme(appData.settings.currentTheme);
                console.log('initializeUIAndData: Theme applied.');
                updateHeaderFooter();
                console.log('initializeUIAndData: Header/Footer updated.');
                setupNavigation();
                console.log('initializeUIAndData: Navigation setup completed.');
                console.log('initializeUIAndData: Assignment table rendered.');
                console.log('initializeUIAndData: Student list rendered.');
                console.log('initializeUIAndData: Assignment list rendered.');
                setupHistoryDatePicker();
                console.log('initializeUIAndData: History date picker setup.');
                console.log('initializeUIAndData: Notice board updated.');
                console.log('initializeUIAndData: Memos rendered.');
                console.log('initializeUIAndData: Lottery history rendered.');
                checkAndResetDailyAssignments(); // Check for midnight reset (also handles notice history)
                console.log('initializeUIAndData: Daily assignment check completed.');
                startDailyMidnightCheck(); // Start interval for daily reset
                console.log('initializeUIAndData: Daily midnight check started.');
                startLunchTimer(); // Start lunch timer by default
                console.log('initializeUIAndData: Lunch timer started.');
                updateDateTimeDisplay(); // Initial call for date/time
                setInterval(updateDateTimeDisplay, 1000); // Update date/time every second
                console.log('initializeUIAndData: Date/Time display updated and interval set.');

                // Set current attendance month if not set
                if (!appData.currentAttendanceMonth) {
                    const today = new Date();
                    appData.currentAttendanceMonth = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
                    debouncedSaveAppData(); // Save to local storage (will trigger Firestore save if logged in)
                }
                attendanceMonthPicker.value = appData.currentAttendanceMonth;
                console.log('initializeUIAndData: Attendance table rendered.');

                // Set default values for number lottery
                numberMinInput.value = "1";
                numberMaxInput.value = "5";
                numberPickCountInput.value = "5";
                console.log('initializeUIAndData: Number lottery defaults set.');

                // Populate batch attendance dropdowns
                populateBatchAttendanceDropdowns();
                console.log('initializeUIAndData: Batch attendance dropdowns populated.');
                console.log('initializeUIAndData: Theme selection populated.');

                // Set lunch timer input values for modal
                modalLunchStartTimeInput.value = appData.settings.lunchTimer.startTime;
                modalLunchEndTimeInput.value = appData.settings.lunchTimer.endTime;
                console.log('initializeUIAndData: Lunch timer modal inputs set.');


                // Event listeners for new anonymous ID login and Logout buttons
                const loadAnonymousDataBtn = document.getElementById('load-anonymous-data-btn');
                if (loadAnonymousDataBtn) {
                    loadAnonymousDataBtn.addEventListener('click', loadDataByAnonymousId);
                }
                const headerLogoutBtn = document.getElementById('logout-btn');
                if (headerLogoutBtn) {
                    headerLogoutBtn.addEventListener('click', signOutUser);
                    console.log('initializeUIAndData: í—¤ë” ë¡œê·¸ì•„ì›ƒ ë²„íŠ¼ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì—°ê²° ì™„ë£Œ.');
                } else {
                    console.warn('initializeUIAndData: ê²½ê³ : IDê°€ "logout-btn"ì¸ í—¤ë” ìš”ì†Œë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                }

                // Event listeners for Email/Password Auth (with null check)
                const signupBtn = document.getElementById('signup-btn');
                const signinBtn = document.getElementById('signin-btn');
                const emailInput = document.getElementById('email-input');
                const passwordInput = document.getElementById('password-input');
                // ë¡œê·¸ì¸ ìœ ì§€ ì²´í¬ë°•ìŠ¤ë„ ë™ì ìœ¼ë¡œ í• ë‹¹
                const keepLoggedIn = document.getElementById('keep-logged-in');

                if (signupBtn) signupBtn.addEventListener('click', signUpWithEmailPassword);
                if (signinBtn) signinBtn.addEventListener('click', signInWithEmailPassword);

                if (emailInput && passwordInput) {
                    emailInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            passwordInput.focus();
                        }
                    });
                    passwordInput.addEventListener('keypress', (e) => {
                        if (e.key === 'Enter') {
                            if (emailInput.value && passwordInput.value) {
                                signInWithEmailPassword();
                            }
                        }
                    });
                }


                // ìº˜ë¦°ë” ë·° ê¸°ì¤€ ì—°/ì›”ì„ í•­ìƒ í˜„ì¬ ë‚ ì§œë¡œ ì¬ì„¤ì • (ë°ì´í„° ë¡œë“œ í›„ ë³´ì¥)
                const today = new Date();
                window.viewYear = today.getFullYear();
                window.viewMonth = today.getMonth(); // 0-basedë¡œ ë§ì¶¤

                // ëª¨ë“  ë™ì  UI ì½˜í…ì¸ ë¥¼ ë Œë”ë§
                renderAllUI();
                console.log('initializeUIAndData: All UI rendered via renderAllUI.');

                // Show the default section after all initial rendering, with a small delay
                setTimeout(() => {
                    showSection(appData.currentSection, true); // Use stored currentSection, skip password check for initial load
                    console.log(`initializeUIAndData: Displaying initial section: ${appData.currentSection}`);
                }, 50); // Small delay
                console.log('UI and data initialized successfully.');
            } catch (error) {
                console.error('Error during UI and data initialization:', error);
                showCustomAlert('ì•± UI ë° ë°ì´í„° ì´ˆê¸°í™” ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤. ê°œë°œì ë„êµ¬ ì½˜ì†”ì„ í™•ì¸í•´ì£¼ì„¸ìš”.');
            }
        }


        // --- Header/Footer Management ---
        function updateHeaderFooter() {
            headerTitleDisplay.textContent = appData.settings.headerTitle;
            footerTextDisplay.textContent = appData.settings.footerText;
            document.title = appData.settings.headerTitle; // Update browser tab title
        }

        editHeaderTitleBtn.addEventListener('click', async () => {
            const isEditing = headerTitleEdit.classList.contains('active');
            if (isEditing) {
                appData.settings.headerTitle = headerTitleEdit.value.trim();
                if (appData.settings.headerTitle === '') {
                    appData.settings.headerTitle = 'ìœ¡ê°œì¥ë°˜ í•™ê¸‰ ìš´ì˜ ì‹œìŠ¤í…œ'; // Default if empty
                }
                headerTitleDisplay.textContent = appData.settings.headerTitle;
                headerTitleDisplay.classList.remove('editing');
                headerTitleEdit.classList.remove('active');
                debouncedSaveAppData(); // Now calls debounced save
            } else {
                headerTitleEdit.value = appData.settings.headerTitle;
                headerTitleDisplay.classList.add('editing');
                headerTitleEdit.classList.add('active');
                headerTitleEdit.focus();
            }
            updateHeaderFooter();
        });

        headerTitleEdit.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                editHeaderTitleBtn.click(); // Trigger the save logic
            }
        });

        editFooterTextBtn.addEventListener('click', async () => {
            const isEditing = footerTextEdit.classList.contains('active');
            if (isEditing) {
                appData.settings.footerText = footerTextEdit.value.trim();
                if (appData.settings.footerText === '') {
                    appData.settings.footerText = 'Â© 2025 ìœ¡ê°œì¥ë°˜'; // Default if empty
                }
                footerTextDisplay.textContent = appData.settings.footerText;
                footerTextDisplay.classList.remove('editing');
                footerTextEdit.classList.remove('active');
                debouncedSaveAppData(); // Now calls debounced save
            } else {
                footerTextEdit.value = appData.settings.footerText;
                footerTextDisplay.classList.add('editing');
                footerTextEdit.classList.add('active');
                footerTextEdit.focus();
            }
            updateHeaderFooter();
        });

        footerTextEdit.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') {
                editFooterTextBtn.click(); // Trigger the save logic
            }
        });

        function updateDateTimeDisplay() {
            const now = new Date();
            const dateOptions = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            const formattedDate = now.toLocaleDateString('ko-KR', dateOptions);

            const hours = now.getHours();
            const minutes = now.getMinutes();
            const seconds = now.getSeconds();
            const formattedTime = `${hours}ì‹œ ${minutes}ë¶„ ${seconds}ì´ˆ`;

            // Ensure elements exist before trying to set textContent
            if (currentDateDisplay) {
                currentDateDisplay.textContent = formattedDate;
            }
            if (currentTimeDisplay) {
                currentTimeDisplay.textContent = formattedTime;
            }
        }

        // --- Navigation ---
        function showSection(sectionId, skipPasswordCheck = false) { // Add skipPasswordCheck parameter
            console.log(`showSection: Attempting to show section: ${sectionId}`);
            // Update current active section in appData
            appData.currentSection = sectionId;
            debouncedSaveAppData(); // Save the current section (now calls debounced save)

            // Special handling for password-protected sections
            if ((sectionId === 'evaluationResults' || sectionId === 'attendanceManagement') && !skipPasswordCheck) {
                passwordModalTitle.textContent = (sectionId === 'evaluationResults' ? 'í‰ê°€ ê²°ê³¼' : 'ì¶œê²° ê´€ë¦¬') + ' ë¹„ë°€ë²ˆí˜¸ ì…ë ¥';
                openModal(evaluationPasswordModal);
                evaluationPasswordInput.value = '';
                evaluationPasswordInput.focus();
                return;
            }

            sections.forEach(section => {
                if (section.id === sectionId) {
                    // Activate the target section
                    section.style.display = 'block'; // Make it visible to start transition
                    requestAnimationFrame(() => {
                        section.classList.add('active'); // This triggers the CSS transition
                    });
                } else {
                    // Deactivate other sections if they are currently active
                    if (section.classList.contains('active')) {
                        section.classList.remove('active'); // This triggers the CSS transition (fade out, slide out)
                        // Wait for the transition to complete, then set display: none
                        section.addEventListener('transitionend', function handler() {
                            section.style.display = 'none';
                            section.removeEventListener('transitionend', handler); // Clean up listener
                        }, { once: true }); // Ensures the listener fires only once
                    } else {
                        // If it's already hidden and not active, ensure display: none
                        section.style.display = 'none';
                    }
                }
            });

            navButtons.forEach(button => {
                if (button.dataset.section === sectionId) {
                    button.classList.add('active'); // Use 'active' class for themed nav buttons
                } else {
                    button.classList.remove('active');
                }
            });

            // Specific actions when section changes
            if (sectionId === 'timer') {
                // Ensure the correct timer is displayed based on current type
                if (timerType === 'lunch') {
                    showLunchTimerContainer();
                } else {
                    showManualTimerContainer();
                }
            } else if (sectionId === 'lottery') {
                // íƒ­ ì´ë™ ì‹œ pickedStudentsë¥¼ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ. ê¸°ì¡´ ê°’ ìœ ì§€
                if (!appData.lottery) {
                    appData.lottery = { studentHistory: [], numberHistory: [], pickedStudents: [], pickedNumbers: [] };
                }
                // studentLotteryResultDisplay.innerHTML = `<span id="current-lottery-result" class="text-2xl text-gray-600"></span>`;
                showStudentLotteryContainer();
                renderLotteryHistory(); // ì´ë¯¸ ë½‘íŒ í•™ìƒ ê²°ê³¼ë¥¼ í•­ìƒ ë°˜ì˜
            } else if (sectionId === 'noticeBoard') {
                updateNoticeBoard();
            } else if (sectionId === 'memo') {
                renderMemos();
            } else if (sectionId === 'attendanceManagement') {
                renderAttendanceTable();
            } else if (sectionId === 'evaluationResults') { // <-- ì´ ë¸”ë¡ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
                renderEvaluationTable(); // ì„¹ì…˜ì´ í™œì„±í™”ë  ë•Œ í˜¸ì¶œë˜ë„ë¡ ë³´ì¥
            } else if (sectionId === 'settings') { // <-- ì´ ë¸”ë¡ì„ ì¶”ê°€í•©ë‹ˆë‹¤.
                populateThemeSelection(); // ì„¤ì • ì„¹ì…˜ ì§„ì… ì‹œ í…Œë§ˆ ì„ íƒ ì˜µì…˜ ë Œë”ë§
            }
        }

        function setupNavigation() {
            console.log('setupNavigation: Setting up navigation buttons.');
            navButtons.forEach(button => {
                button.addEventListener('click', () => {
                    showSection(button.dataset.section);
                });
            });
            console.log(`setupNavigation: Found ${navButtons.length} navigation buttons.`);
        }

        // --- Modal Management ---
        function openModal(modalElement) {
            modalElement.style.display = 'flex';
        }

        function closeModal(modalElement) {
            if (modalElement) {
                modalElement.style.display = 'none';
            }
        }

        closeButtons.forEach(button => {
            button.addEventListener('click', (e) => {
                const modalId = e.target.dataset.modal;
                closeModal(document.getElementById(modalId));
            });
        });

        // Event listener for Esc key to close any open modal
        document.addEventListener('keydown', (e) => {
            if (e.key === 'Escape') {
                const openModals = document.querySelectorAll('.modal');
                openModals.forEach(modal => {
                    if (modal.style.display === 'flex') {
                        closeModal(modal);
                        // Stop propagation to prevent multiple modals from closing if stacked
                        // (though current design doesn't stack them)
                        e.stopPropagation();
                        return; // Exit after closing the first open modal
                    }
                });
            }
        });


        // --- Assignment Check Functions ---
        manageStudentsBtn.addEventListener('click', () => {
            openModal(studentModal);
            renderStudentList();
            studentInput.focus();
        });

        manageAssignmentsBtn.addEventListener('click', () => {
            openModal(assignmentModal);
            renderAssignmentList();
            assignmentInput.focus();
        });

        viewHistoryBtn.addEventListener('click', () => {
            openModal(historyModal);
            // Set date picker to today's date by default
            const today = new Date();
            historyDatePicker.value = today.toISOString().split('T')[0];
            displayAssignmentHistory(historyDatePicker.value);
        });

        historyDatePicker.addEventListener('change', (e) => {
            displayAssignmentHistory(e.target.value);
        });

        function renderStudentList() {
            studentList.innerHTML = '';
            appData.students.forEach(student => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm';
                const nameSpan = document.createElement('span');
                nameSpan.className = 'text-gray-800 text-lg';
                nameSpan.textContent = window.escapeHtml(student.name);
                const delBtn = document.createElement('button');
                delBtn.dataset.id = student.id;
                delBtn.className = 'delete-student-btn text-red-500 hover:text-red-700 transition-colors duration-200';
                delBtn.innerHTML = '<i class="fas fa-trash-alt"></i>';
                li.appendChild(nameSpan);
                li.appendChild(delBtn);
                studentList.appendChild(li);
            });
            addStudentDeleteListeners();
        }

        function addStudentDeleteListeners() {
            document.querySelectorAll('.delete-student-btn').forEach(button => {
                button.onclick = async (e) => {
                    const studentIdToDelete = e.currentTarget.dataset.id;
                    const studentName = appData.students.find(s => s.id === studentIdToDelete)?.name;
                    const confirmDelete = await showCustomAlert(`${studentName} í•™ìƒì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, true);
                    if (confirmDelete) {
                        appData.students = appData.students.filter(s => s.id !== studentIdToDelete);
                        delete appData.dailyAssignments[studentIdToDelete]; // Remove daily assignments for deleted student
                        // Also remove student from evaluations and attendance
                        appData.evaluations.forEach(subject => {
                            subject.units.forEach(unit => {
                                delete unit.results[studentIdToDelete];
                            });
                        });
                        Object.keys(appData.attendance).forEach(month => {
                            delete appData.attendance[month][studentIdToDelete];
                        });

                        debouncedSaveAppData(); // Now calls debounced save
                        renderStudentList();
                        renderAssignmentTable(); // Re-render table to reflect changes
                        renderEvaluationTable(); // Re-render evaluation table
                        renderAttendanceTable(); // Re-render attendance table
                    }
                };
            });
        }

        studentInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && studentInput.value.trim() !== '') {
                const newStudentName = studentInput.value.trim();
                const newStudentId = generateUniqueId();
                // í•™ìƒ ì •ë³´ ì¶”ê°€
                appData.students.push({ id: newStudentId, name: newStudentName });
                appData.dailyAssignments[newStudentId] = {}; // Initialize daily assignments for new student
                appData.assignments.forEach(assignName => {
                    appData.dailyAssignments[newStudentId][assignName] = false; // Default to unchecked
                });
                debouncedSaveAppData(); // Now calls debounced save
                renderStudentList();
                renderAssignmentTable();
                renderEvaluationTable(); // Update evaluation table for new student
                renderAttendanceTable(); // Update attendance table for new student
                studentInput.value = '';
            }
        });

        function renderAssignmentList() {
            assignmentList.innerHTML = '';
            appData.assignments.forEach(assignName => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm';
                li.innerHTML = `
                    <span class="text-gray-800 text-lg">${assignName}</span>
                    <button data-name="${assignName}" class="delete-assignment-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                assignmentList.appendChild(li);
            });
            addAssignmentDeleteListeners();
        }

        function addAssignmentDeleteListeners() {
            document.querySelectorAll('.delete-assignment-btn').forEach(button => {
                button.onclick = async (e) => {
                    const assignNameToDelete = e.currentTarget.dataset.name;
                    const confirmDelete = await showCustomAlert(`${assignNameToDelete} ê³¼ì œë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, true);
                    if (confirmDelete) {
                        appData.assignments = appData.assignments.filter(name => name !== assignNameToDelete);
                        // Remove this assignment from all students' daily assignments
                        Object.keys(appData.dailyAssignments).forEach(studentId => {
                            delete appData.dailyAssignments[studentId][assignNameToDelete];
                        });
                        debouncedSaveAppData(); // Now calls debounced save
                        renderAssignmentList();
                        renderAssignmentTable(); // Re-render table to reflect changes
                    }
                };
            });
        }

        assignmentInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && assignmentInput.value.trim() !== '') {
                const newAssignmentName = assignmentInput.value.trim();
                if (!appData.assignments.includes(newAssignmentName)) {
                    appData.assignments.push(newAssignmentName);
                    // Add new assignment to all existing students, default to unchecked
                    appData.students.forEach(student => {
                        if (!appData.dailyAssignments[student.id]) {
                            appData.dailyAssignments[student.id] = {};
                        }
                        appData.dailyAssignments[student.id][newAssignmentName] = false;
                    });
                    debouncedSaveAppData(); // Now calls debounced save
                    renderAssignmentList();
                    renderAssignmentTable();
                    assignmentInput.value = '';
                } else {
                    showCustomAlert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê³¼ì œëª…ì…ë‹ˆë‹¤.');
                }
            }
        });

function renderAssignmentTable() {
    const assignmentTableBody = document.getElementById('assignment-table-body');
    if (!assignmentTableBody) return;

    // í…Œì´ë¸” í—¤ë” (<th>) ë¶€ë¶„ì„ ë¨¼ì € ì •ë¦¬í•©ë‹ˆë‹¤.
    const tableHeadRow = document.querySelector('#assignmentCheck thead tr'); // thead ë‚´ë¶€ì˜ trì„ ì •í™•íˆ ì„ íƒ
    
    // 'ë²ˆí˜¸', 'í•™ìƒëª…', 'ì§„í–‰ë„ (%)' 3ê°œ ì—´ì„ ì œì™¸í•˜ê³  ê¸°ì¡´ ê³¼ì œ í—¤ë”ë“¤ì„ ëª¨ë‘ ì œê±°í•©ë‹ˆë‹¤.
    // HTMLì— 'ë²ˆí˜¸' <th>ë¥¼ ì§ì ‘ ì¶”ê°€í–ˆìœ¼ë¯€ë¡œ, ì´ì œ 3ê°œ ë¯¸ë§Œìœ¼ë¡œ ë‚¨ì„ ë•Œê¹Œì§€ ì œê±°í•©ë‹ˆë‹¤.
    while (tableHeadRow.children.length > 3) { 
        tableHeadRow.removeChild(tableHeadRow.lastChild);
    }

    // ìƒˆë¡œìš´ ê³¼ì œ í—¤ë” ì¶”ê°€
    appData.assignments.forEach(assignName => {
        const th = document.createElement('th');
        th.className = 'py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider';
    th.textContent = window.escapeHtml(assignName);
        tableHeadRow.appendChild(th);
    });

    assignmentTableBody.innerHTML = ''; // í…Œì´ë¸” ë°”ë”” ë‚´ìš©ì„ ë¹„ì›ë‹ˆë‹¤.

    if (appData.students && appData.students.length > 0) {
        // students.forEach((student, index) => { ì—¬ê¸°ì— index ë§¤ê°œë³€ìˆ˜ë¥¼ ë°›ì•„ì•¼ í•©ë‹ˆë‹¤.
        appData.students.forEach((student, index) => { 
            const tr = document.createElement('tr');
            tr.className = 'hover:bg-gray-100 transition-colors duration-150';

            // 1. ë²ˆí˜¸ ì—´ ì¶”ê°€
            const numberCell = document.createElement('td');
            numberCell.className = 'py-3 px-6 whitespace-nowrap text-center text-sm font-medium text-gray-800';
            numberCell.textContent = index + 1; // 0ë¶€í„° ì‹œì‘í•˜ëŠ” ì¸ë±ìŠ¤ë¥¼ 1ë¶€í„° ì‹œì‘í•˜ëŠ” ë²ˆí˜¸ë¡œ ë³€ê²½
            tr.appendChild(numberCell); // 'row' ëŒ€ì‹  'tr' ì‚¬ìš©

            // 2. Student Name
            const nameTd = document.createElement('td');
            nameTd.className = 'py-3 px-6 whitespace-nowrap font-medium text-gray-900';
            nameTd.textContent = window.escapeHtml(student.name);
            tr.appendChild(nameTd);

            // 3. Progress Percentage
            const progressTd = document.createElement('td');
            progressTd.className = 'py-3 px-6 whitespace-nowrap';
            const totalAssignments = appData.assignments.length;
            let completedAssignments = 0;
            if (appData.dailyAssignments && appData.dailyAssignments[student.id]) { // appData.dailyAssignments ì¡´ì¬ ì—¬ë¶€ í™•ì¸ ì¶”ê°€
                completedAssignments = Object.values(appData.dailyAssignments[student.id]).filter(status => status).length;
            }
            const progress = totalAssignments > 0 ? Math.round((completedAssignments / totalAssignments) * 100) : 0;

            progressTd.innerHTML = `
                <div class="flex items-center justify-center">
                    <div class="progress-bar-container w-24">
                        <div class="progress-bar-fill" style="width: ${progress}%;"></div>
                    </div>
                    <span class="progress-text">${progress}%</span>
                </div>
            `;
            tr.appendChild(progressTd);

            // 4. ê³¼ì œë³„ ì²´í¬ë°•ìŠ¤/ìƒíƒœ ì—´ ì¶”ê°€ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
            // appData.assignmentsê°€ ì •ì˜ë˜ì–´ ìˆê³  ë°°ì—´ì¸ì§€ í™•ì¸
            if (appData.assignments && Array.isArray(appData.assignments)) {
                appData.assignments.forEach(assignName => {
                    const assignmentCell = document.createElement('td');
                    assignmentCell.className = 'py-3 px-6 whitespace-nowrap text-center';

                    // ê° ê³¼ì œë³„ ìƒíƒœë¥¼ í‘œì‹œí•˜ëŠ” ë¡œì§ (ì˜ˆ: ì²´í¬ë°•ìŠ¤, ì•„ì´ì½˜ ë“±)
                    // ì´ ë¶€ë¶„ì€ ì‚¬ìš©ìë‹˜ì˜ ê¸°ì¡´ ê³¼ì œ ì²´í¬ ë¡œì§ì— ë”°ë¼ êµ¬í˜„ë©ë‹ˆë‹¤.
                    const isCompleted = appData.dailyAssignments && appData.dailyAssignments[student.id] && appData.dailyAssignments[student.id][assignName];
                    
                    const checkbox = document.createElement('input');
                    checkbox.type = 'checkbox';
                    checkbox.className = 'form-checkbox h-5 w-5 text-blue-600';
                    checkbox.checked = isCompleted;
                    checkbox.dataset.studentId = student.id;
                    checkbox.dataset.assignmentName = assignName;
                    
                    // ì²´í¬ë°•ìŠ¤ í´ë¦­ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (ê³¼ì œ ìƒíƒœ ì €ì¥ ë¡œì§)
                    checkbox.addEventListener('change', (event) => {
                        if (!appData.dailyAssignments) {
                            appData.dailyAssignments = {};
                        }
                        if (!appData.dailyAssignments[student.id]) {
                            appData.dailyAssignments[student.id] = {};
                        }
                        appData.dailyAssignments[student.id][assignName] = event.target.checked;
                        debouncedSaveAppData(); // ë°ì´í„° ì €ì¥
                        renderAssignmentTable(); // ì§„í–‰ë„ ê°±ì‹ ì„ ìœ„í•´ í…Œì´ë¸” ë¦¬ë Œë”ë§ (ì„ íƒ ì‚¬í•­)
                    });
                    
                    assignmentCell.appendChild(checkbox);
                    tr.appendChild(assignmentCell);
                });
            }

            assignmentTableBody.appendChild(tr);
        });
    } else {
        // í•™ìƒ ë°ì´í„°ê°€ ì—†ëŠ” ê²½ìš° ë©”ì‹œì§€ í‘œì‹œ
        const noDataRow = document.createElement('tr');
        const noDataCell = document.createElement('td');
        // 'ë²ˆí˜¸'(1) + 'í•™ìƒëª…'(1) + 'ì§„í–‰ë„'(1) + appData.assignments.length (ê³¼ì œ ê°œìˆ˜)
        const totalColCount = 3 + (appData.assignments ? appData.assignments.length : 0);
        noDataCell.colSpan = totalColCount; 
        noDataCell.className = 'py-4 text-center text-gray-500';
        noDataCell.textContent = 'í•™ìƒ ëª…ë‹¨ì´ ì—†ìŠµë‹ˆë‹¤. í•™ìƒ ëª…ë‹¨ ê´€ë¦¬ë¥¼ í†µí•´ ì¶”ê°€í•´ì£¼ì„¸ìš”.';
        noDataRow.appendChild(noDataCell);
        assignmentTableBody.appendChild(noDataRow);
    }
}

        function addAssignmentCheckboxListeners() { // This function is now for TD clicks
            document.querySelectorAll('.assignment-check-cell').forEach(cell => {
                cell.addEventListener('click', async (e) => {
                    const studentId = cell.dataset.studentId;
                    const assignmentName = cell.dataset.assignmentName;
                    const checkbox = cell.querySelector('input[type="checkbox"]');

                    if (checkbox) {
                        checkbox.checked = !checkbox.checked; // Toggle the checkbox state
                        const isChecked = checkbox.checked;

                        if (!appData.dailyAssignments[studentId]) {
                            appData.dailyAssignments[studentId] = {};
                        }
                        appData.dailyAssignments[studentId][assignmentName] = isChecked;
                        debouncedSaveAppData(); // Now calls debounced save
                        renderAssignmentTable(); // Re-render to update progress
                    }
                });
            });
        }

        function getFormattedDate(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        async function checkAndResetDailyAssignments() {
            const today = getFormattedDate();
            const lastResetDate = appData.lastAssignmentResetDate || localStorage.getItem('lastAssignmentResetDate'); // Check appData first

            if (lastResetDate !== today) {
                // Save current assignment state to history before resetting
                if (Object.keys(appData.dailyAssignments).length > 0 || appData.assignments.length > 0) {
                    appData.assignmentHistory[lastResetDate || 'initial_state'] = {
                        dailyAssignments: JSON.parse(JSON.stringify(appData.dailyAssignments)),
                        assignments: JSON.parse(JSON.stringify(appData.assignments)),
                        noticeContent: appData.notice.content
                    };
                    // Keep only last 7 days of history
                    const historyDates = Object.keys(appData.assignmentHistory).sort().reverse();
                    if (historyDates.length > 7) {
                        for (let i = 7; i < historyDates.length; i++) {
                            delete appData.assignmentHistory[historyDates[i]];
                        }
                    }
                }

                // Reset daily assignments and assignments for the new day
                appData.dailyAssignments = {};
                appData.assignments = [];
                appData.students.forEach(student => {
                    appData.dailyAssignments[student.id] = {};
                });
                appData.lastAssignmentResetDate = today; // Update in appData
                debouncedSaveAppData(); // Now calls debounced save
                localStorage.setItem('lastAssignmentResetDate', today); // Keep local for fallback/initial check
                renderAssignmentTable();
                console.log(`ê³¼ì œ ì ê²€ ë°ì´í„°ê°€ ${today}ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.`);
            }
        }

        function startDailyMidnightCheck() {
            setInterval(() => {
                const now = new Date();
                if (now.getHours() === 0 && now.getMinutes() === 0) {
                    checkAndResetDailyAssignments();
                }
            }, 60 * 1000);
        }

        function setupHistoryDatePicker() {
            const today = new Date();
            historyDatePicker.max = today.toISOString().split('T')[0];
        }

        function displayAssignmentHistory(dateString) {
            historyContent.innerHTML = '';
            const historyData = appData.assignmentHistory[dateString];

            if (!historyData) {
                historyContent.innerHTML = `<p class="text-gray-600">ì„ íƒëœ ë‚ ì§œ(${dateString})ì— ì €ì¥ëœ ì´ë ¥ì´ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            const assignmentsForDate = historyData.assignments || [];
            const dailyAssignmentsForDate = historyData.dailyAssignments || {};
            const studentsForDate = appData.students;

            if (studentsForDate.length === 0 || assignmentsForDate.length === 0) {
                historyContent.innerHTML = `<p class="text-gray-600">ì„ íƒëœ ë‚ ì§œ(${dateString})ì— í•™ìƒ ë˜ëŠ” ê³¼ì œ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>`;
                return;
            }

            const historyTable = document.createElement('table');
            historyTable.className = 'min-w-full divide-y divide-gray-200';
            historyTable.innerHTML = `
                <thead class="bg-gray-200">
                    <tr>
                        <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">í•™ìƒëª…</th>
                        <th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">ì§„í–‰ë„ (%)</th>
                        ${assignmentsForDate.map(assignName => `<th class="py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider">${assignName}</th>`).join('')}
                    </tr>
                </thead>
                <tbody class="divide-y divide-gray-200">
                </tbody>
            `;
            const historyTableBody = historyTable.querySelector('tbody');

            studentsForDate.forEach(student => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-100 transition-colors duration-150';

                const nameTd = document.createElement('td');
                nameTd.className = 'py-3 px-6 whitespace-nowrap font-medium text-gray-900';
                nameTd.textContent = student.name;
                tr.appendChild(nameTd);

                const progressTd = document.createElement('td');
                progressTd.className = 'py-3 px-6 whitespace-nowrap';
                const studentDailyData = dailyAssignmentsForDate[student.id] || {};
                const completedCount = Object.values(studentDailyData).filter(status => status).length;
                const totalCount = assignmentsForDate.length;
                const progress = totalCount > 0 ? Math.round((completedCount / totalCount) * 100) : 0;
                progressTd.innerHTML = `
                    <div class="flex items-center justify-center">
                        <div class="progress-bar-container w-24">
                            <div class="progress-bar-fill" style="width: ${progress}%;"></div>
                        </div>
                        <span class="progress-text">${progress}%</span>
                    </div>
                `;
                tr.appendChild(progressTd);

                assignmentsForDate.forEach(assignName => {
                    const assignTd = document.createElement('td');
                    assignTd.className = 'py-3 px-6 whitespace-nowrap';
                    const isChecked = studentDailyData[assignName] === true;
                    assignTd.innerHTML = `<i class="fas ${isChecked ? 'fa-check-circle text-green-500' : 'fa-times-circle text-red-500'} text-xl"></i>`;
                    tr.appendChild(assignTd);
                });
                historyTableBody.appendChild(tr);
            });
            historyContent.appendChild(historyTable);
        }

        // --- Timer Functions ---
        showLunchTimerBtn.addEventListener('click', () => {
            timerType = 'lunch';
            showLunchTimerContainer();
            startLunchTimer();
        });

        openLunchTimerSettingsBtn.addEventListener('click', () => {
            modalLunchStartTimeInput.value = appData.settings.lunchTimer.startTime;
            modalLunchEndTimeInput.value = appData.settings.lunchTimer.endTime;
            openModal(lunchTimerSettingsModal);
        });

        saveLunchTimesBtnModal.addEventListener('click', async () => {
            const newStartTime = modalLunchStartTimeInput.value;
            const newEndTime = modalLunchEndTimeInput.value;

            if (newStartTime && newEndTime) {
                appData.settings.lunchTimer.startTime = newStartTime;
                appData.settings.lunchTimer.endTime = newEndTime;
                debouncedSaveAppData(); // Now calls debounced save
                showCustomAlert('ì ì‹¬ ì‹œê°„ ì„¤ì •ì´ ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤!');
                closeModal(lunchTimerSettingsModal);
                startLunchTimer();
            } else {
                showCustomAlert('ì‹œì‘ ì‹œê°„ê³¼ ì¢…ë£Œ ì‹œê°„ì„ ëª¨ë‘ ì…ë ¥í•´ì£¼ì„¸ìš”.');
            }
        });

        showManualTimerBtn.addEventListener('click', () => {
            timerType = 'manual';
            showManualTimerContainer();
            stopTimer();
            manualTimerDisplay.textContent = '00:00';
        });

        startManualTimerBtn.addEventListener('click', () => {
            const minutes = parseInt(manualTimerMinutes.value) || 0;
            const seconds = parseInt(manualTimerSeconds.value) || 0;
            const totalSeconds = minutes * 60 + seconds;

            if (totalSeconds > 0) {
                startCountdownTimer(totalSeconds);
            } else {
                showCustomAlert('ì‹œê°„ì„ ì„¤ì •í•´ì£¼ì„¸ìš”.');
            }
        });

        function showLunchTimerContainer() {
            lunchTimerContainer.classList.remove('hidden');
            manualTimerContainer.classList.add('hidden');
        }

        function showManualTimerContainer() {
            lunchTimerContainer.classList.add('hidden');
            manualTimerContainer.classList.remove('hidden');
        }

        function stopTimer() {
            if (currentTimerInterval) {
                clearInterval(currentTimerInterval);
                currentTimerInterval = null;
            }
            isTimerActive = false;
            timerDisplay.classList.remove('blink', 'scale');
            timerDisplay.style.color = '';
            manualTimerDisplay.classList.remove('blink', 'scale');
            manualTimerDisplay.style.color = '';
        }

        function startLunchTimer() {
            stopTimer();
            isTimerActive = true;
            currentTimerInterval = setInterval(updateLunchTimer, 1000);
            updateLunchTimer();
        }

        function updateLunchTimer() {
            const now = new Date();
            const [startHour, startMinute] = appData.settings.lunchTimer.startTime.split(':').map(Number);
            const [endHour, endMinute] = appData.settings.lunchTimer.endTime.split(':').map(Number);

            const lunchStart = new Date(now.getFullYear(), now.getMonth(), now.getDate(), startHour, startMinute, 0);
            const lunchEnd = new Date(now.getFullYear(), now.getMonth(), now.getDate(), endHour, endMinute, 0);

            let timeLeft;
            let message = '';
            let targetDisplay = timerDisplay;

            if (now < lunchStart) {
                timeLeft = lunchStart.getTime() - now.getTime();
                message = 'ì ì‹¬ì‹œê°„ê¹Œì§€ ë‚¨ì€ ì‹œê°„:';
                lunchTimerMessage.textContent = message;
            } else if (now >= lunchStart && now < lunchEnd) {
                timeLeft = lunchEnd.getTime() - now.getTime();
                message = 'ì ì‹¬ì‹œê°„ ì¢…ë£Œê¹Œì§€ ë‚¨ì€ ì‹œê°„:';
                lunchTimerMessage.textContent = message;
            } else {
                timeLeft = 0;
                message = 'ì˜¤ëŠ˜ì˜ ì ì‹¬ì‹œê°„ì€ ì¢…ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
                lunchTimerMessage.textContent = message;
                stopTimer();
            }

            const totalSeconds = Math.max(0, Math.floor(timeLeft / 1000));
            updateTimerDisplay(totalSeconds, targetDisplay);

            if (totalSeconds <= 0 && isTimerActive) {
                stopTimer();
                targetDisplay.textContent = '00:00:00';
            }
        }

        function startCountdownTimer(totalSeconds) {
            stopTimer();
            isTimerActive = true;
            let remainingSeconds = totalSeconds;
            let targetDisplay = manualTimerDisplay;

            function update() {
                updateTimerDisplay(remainingSeconds, targetDisplay);
                if (remainingSeconds <= 0) {
                    stopTimer();
                    targetDisplay.textContent = '00:00';
                    showCustomAlert('íƒ€ì´ë¨¸ ì¢…ë£Œ!');
                } else {
                    remainingSeconds--;
                }
            }
            currentTimerInterval = setInterval(update, 1000);
            update();
        }

        function updateTimerDisplay(totalSeconds, displayElement) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = totalSeconds % 60;

            const formattedTime = [hours, minutes, seconds]
                .map(unit => String(unit).padStart(2, '0'))
                .join(':');

            displayElement.textContent = hours > 0 ? formattedTime : formattedTime.substring(3);

            if (totalSeconds <= 60 && totalSeconds > 0) {
                displayElement.classList.add('blink');
                displayElement.style.color = `var(--timer-warning-color, #ef4444)`;
            } else {
                displayElement.style.color = `var(--timer-color, #3b82f6)`;
                displayElement.classList.remove('blink');
            }
        }

        // --- Lottery Functions ---
        showStudentLotteryBtn.addEventListener('click', () => {
            if (!appData.lottery) {
                appData.lottery = { studentHistory: [], numberHistory: [], pickedStudents: [], pickedNumbers: [] };
            }
            // íƒ­ ì´ë™ ì‹œ pickedStudentsë¥¼ ì´ˆê¸°í™”í•˜ì§€ ì•ŠìŒ. ê¸°ì¡´ ê°’ ìœ ì§€
            showStudentLotteryContainer();
            renderLotteryHistory(); // ì´ë¯¸ ë½‘íŒ í•™ìƒ ê²°ê³¼ë¥¼ í•­ìƒ ë°˜ì˜
        });

        showNumberLotteryBtn.addEventListener('click', () => {
            if (!appData.lottery) {
                appData.lottery = { studentHistory: [], numberHistory: [], pickedStudents: [], pickedNumbers: [] };
            }
            appData.lottery.pickedNumbers = [];
            numberLotteryResultDisplay.innerHTML = '';
            showNumberLotteryContainer();
        });

        function showStudentLotteryContainer() {
            studentLotteryContainer.classList.remove('hidden');
            numberLotteryContainer.classList.add('hidden');
        }

        function showNumberLotteryContainer() {
            studentLotteryContainer.classList.add('hidden');
            numberLotteryContainer.classList.remove('hidden');
        }

        startStudentLotteryBtn.addEventListener('click', async () => {
            if (appData.students.length === 0) {
                showCustomAlert('í•™ìƒ ëª…ë‹¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. í•™ìƒì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }

            const pickCount = parseInt(studentPickCountInput.value);
            if (isNaN(pickCount) || pickCount <= 0) {
                showCustomAlert('ë½‘ì„ í•™ìƒ ìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!appData.lottery) {
                appData.lottery = { studentHistory: [], numberHistory: [], pickedStudents: [], pickedNumbers: [] };
            }
            if (!appData.lottery.pickedStudents) {
                appData.lottery.pickedStudents = [];
            }

            if (appData.lottery.pickedStudents.length === appData.students.length) {
                const resetConfirm = await showCustomAlert('ëª¨ë“  í•™ìƒì„ ë½‘ì•˜ìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', true);
                if (resetConfirm) {
                    appData.lottery.pickedStudents = [];
                } else {
                    return;
                }
            }

            const availableStudents = appData.students.filter(student => !appData.lottery.pickedStudents.includes(student.id));

            if (availableStudents.length === 0) {
                showCustomAlert('ë” ì´ìƒ ë½‘ì„ í•™ìƒì´ ì—†ìŠµë‹ˆë‹¤. ëª…ë‹¨ì„ ì´ˆê¸°í™”í•˜ê±°ë‚˜ í•™ìƒì„ ì¶”ê°€í•´ì£¼ì„¸ìš”.');
                return;
            }

            studentLotteryResultDisplay.classList.add('shuffle-animation');
            studentLotteryResultDisplay.innerHTML = '<span class="text-2xl text-gray-600">ë½‘ëŠ” ì¤‘...</span>';

            await new Promise(resolve => setTimeout(resolve, 1500));

            studentLotteryResultDisplay.classList.remove('shuffle-animation');
            studentLotteryResultDisplay.innerHTML = '';

            const pickedStudentsNames = [];
            for (let i = 0; i < pickCount; i++) {
                if (availableStudents.length === 0) break;

                const randomIndex = Math.floor(Math.random() * availableStudents.length);
                const pickedStudent = availableStudents.splice(randomIndex, 1)[0];
                appData.lottery.pickedStudents.push(pickedStudent.id);
                pickedStudentsNames.push(pickedStudent.name);

                const studentCard = document.createElement('div');
                studentCard.className = 'lottery-card';
                studentCard.textContent = pickedStudent.name;
                studentLotteryResultDisplay.appendChild(studentCard);
            }

            const resultText = pickedStudentsNames.join(', ');
            appData.lottery.studentHistory.push({
                date: new Date().toLocaleString(),
                result: resultText
            });
            debouncedSaveAppData(); // Now calls debounced save
            renderLotteryHistory();
            createConfetti();
        });

        startNumberLotteryBtn.addEventListener('click', async () => {
            const min = parseInt(numberMinInput.value);
            const max = parseInt(numberMaxInput.value);
            const pickCount = parseInt(numberPickCountInput.value);

            if (isNaN(min) || isNaN(max) || isNaN(pickCount) || min > max || pickCount <= 0 || pickCount > (max - min + 1)) {
                showCustomAlert('ìˆ«ì ë²”ìœ„ì™€ ë½‘ì„ ê°œìˆ˜ë¥¼ ì˜¬ë°”ë¥´ê²Œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
                return;
            }

            if (!appData.lottery) {
                appData.lottery = { studentHistory: [], numberHistory: [], pickedStudents: [], pickedNumbers: [] };
            }
            if (!appData.lottery.pickedNumbers) {
                appData.lottery.pickedNumbers = [];
            }

            let allNumbers = Array.from({ length: max - min + 1 }, (_, i) => min + i);
            let availableNumbers = allNumbers.filter(num => !appData.lottery.pickedNumbers.includes(num));

            if (availableNumbers.length === 0) {
                const resetConfirm = await showCustomAlert('ëª¨ë“  ìˆ«ìë¥¼ ë½‘ì•˜ìŠµë‹ˆë‹¤. ì²˜ìŒë¶€í„° ë‹¤ì‹œ ì‹œì‘í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', true);
                if (resetConfirm) {
                    appData.lottery.pickedNumbers = [];
                    availableNumbers = allNumbers;
                } else {
                    return;
                }
            }

            if (availableNumbers.length < pickCount) {
                showCustomAlert(`ë‚¨ì€ ìˆ«ìê°€ ë¶€ì¡±í•©ë‹ˆë‹¤. (${availableNumbers.length}ê°œ ë‚¨ìŒ)`);
                return;
            }

            numberLotteryResultDisplay.classList.add('shuffle-animation');
            numberLotteryResultDisplay.innerHTML = '<span class="text-2xl text-gray-600">ë½‘ëŠ” ì¤‘...</span>';

            await new Promise(resolve => setTimeout(resolve, 1500));

            numberLotteryResultDisplay.classList.remove('shuffle-animation');
            numberLotteryResultDisplay.innerHTML = '';

            const pickedNumbers = [];
            for (let i = 0; i < pickCount; i++) {
                const randomIndex = Math.floor(Math.random() * availableNumbers.length);
                const pickedNum = availableNumbers.splice(randomIndex, 1)[0];
                appData.lottery.pickedNumbers.push(pickedNum);
                pickedNumbers.push(pickedNum);

                const numCard = document.createElement('div');
                numCard.className = 'lottery-card';
                numCard.textContent = pickedNum;
                numberLotteryResultDisplay.appendChild(numCard);
            }

            const resultText = pickedNumbers.join(', ');
            appData.lottery.numberHistory.push({
                date: new Date().toLocaleString(),
                result: resultText

            });
            debouncedSaveAppData(); // Now calls debounced save
            renderLotteryHistory();
            createConfetti();
        });

        function renderLotteryHistory() {
            lotteryHistoryList.innerHTML = '';
            if (appData.lottery && appData.lottery.studentHistory) {
                appData.lottery.studentHistory.slice().reverse().forEach(entry => {
                    const li = document.createElement('li');
                    li.className = 'text-gray-700 text-sm mb-1';
                    li.textContent = `${entry.date}: ${entry.result}`;
                    lotteryHistoryList.appendChild(li);
                });
            }

            numberLotteryHistoryList.innerHTML = '';
            if (appData.lottery && appData.lottery.numberHistory) {
                appData.lottery.numberHistory.slice().reverse().forEach(entry => {
                    const li = document.createElement('li');
                    li.className = 'text-gray-700 text-sm mb-1';
                    li.textContent = `${entry.date}: ${entry.result}`;
                    numberLotteryHistoryList.appendChild(li);
                });
            }
        }

        function createConfetti() {
            const colors = ['#f06', '#0cf', '#fc0', '#6f0', '#93f'];
            for (let i = 0; i < 100; i++) {
                const confetti = document.createElement('div');
                confetti.className = 'confetti';
                confetti.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];

                confetti.style.left = `${Math.random() * window.innerWidth}px`;
                confetti.style.top = `${Math.random() * window.innerHeight}px`;

                confetti.style.setProperty('--x', `${(Math.random() - 0.5) * 800}px`);
                confetti.style.setProperty('--y', `${(Math.random() - 0.5) * 800}px`);

                document.body.appendChild(confetti);

                confetti.addEventListener('animationend', () => {
                    confetti.remove();
                });
            }
        }


        // --- Notice Board Functions ---
        function autoExpandTextarea(element) {
            element.style.height = 'auto';
            element.style.height = (element.scrollHeight) + 'px';
        }

        function updateNoticeBoard() {
            const today = new Date();
            const options = { year: 'numeric', month: 'long', day: 'numeric', weekday: 'long' };
            noticeDate.textContent = today.toLocaleDateString('ko-KR', options);

            noticeContent.value = appData.notice.content;
            noticeContent.style.fontFamily = appData.notice.fontFamily;
            noticeContent.style.fontSize = `${appData.notice.fontSize}pt`;

            noticeFontFamily.value = appData.notice.fontFamily;
            noticeFontSize.value = appData.notice.fontSize;

            autoExpandTextarea(noticeContent);
        }

        noticeFontFamily.addEventListener('change', async (e) => {
            appData.notice.fontFamily = e.target.value;
            noticeContent.style.fontFamily = appData.notice.fontFamily;
            debouncedSaveAppData(); // Now calls debounced save
        });

        noticeFontSize.addEventListener('input', async (e) => {
            const newSize = parseInt(e.target.value);
            if (!isNaN(newSize) && newSize >= 10 && newSize <= 100) {
                appData.notice.fontSize = newSize;
                noticeContent.style.fontSize = `${appData.notice.fontSize}pt`;
                debouncedSaveAppData(); // Now calls debounced save
                autoExpandTextarea(noticeContent);
            }
        });

        noticeContent.addEventListener('input', (e) => {
            clearTimeout(memoSaveTimeout);
            memoSaveTimeout = setTimeout(async () => {
                appData.notice.content = noticeContent.value;
                appData.notice.lastSavedDate = getFormattedDate();
                debouncedSaveAppData(); // Now calls debounced save
                console.log('ì•Œë¦¼ì¥ ë‚´ìš© ìë™ ì €ì¥ë¨');
            }, 1000);
            autoExpandTextarea(e.target);
        });

        loadPrevNoticeBtn.addEventListener('click', async () => {
            const today = new Date();
            const yesterday = new Date();
            yesterday.setDate(yesterday.getDate() - 1);
            const yesterdayFormatted = getFormattedDate(yesterday);

            const prevNoticeData = appData.assignmentHistory[yesterdayFormatted]?.noticeContent;
            if (prevNoticeData !== undefined) {
                noticeContent.value = prevNoticeData;
                appData.notice.content = prevNoticeData;
                appData.notice.lastSavedDate = getFormattedDate();
                debouncedSaveAppData(); // Now calls debounced save
                showCustomAlert('ì „ë‚  ì•Œë¦¼ì¥ ë‚´ìš©ì„ ë¶ˆëŸ¬ì™”ìŠµë‹ˆë‹¤.');
                autoExpandTextarea(noticeContent);
            } else {
                showCustomAlert('ì „ë‚  ì•Œë¦¼ì¥ ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.');
            }
        });

        copyNoticeBtn.addEventListener('click', () => {
            noticeContent.select();
            document.execCommand('copy');
            showCustomAlert('ì•Œë¦¼ì¥ ë‚´ìš©ì´ í´ë¦½ë³´ë“œì— ë³µì‚¬ë˜ì—ˆìŠµë‹ˆë‹¤!');
        });

        // --- Memo Functions ---
        addMemoBtn.addEventListener('click', async () => {
            const newMemo = {
                id: generateUniqueId(),
                content: '',
                createdAt: new Date().toLocaleString()
            };
            appData.memos.unshift(newMemo);
            debouncedSaveAppData(); // Now calls debounced save
            renderMemos();
        });

        function renderMemos() {
            memoList.innerHTML = '';
            if (appData.memos.length === 0) {
                memoList.innerHTML = '<p class="text-gray-500 text-center col-span-full">ë©”ëª¨ê°€ ì—†ìŠµë‹ˆë‹¤. ìƒˆ ë©”ëª¨ë¥¼ ì¶”ê°€í•´ë³´ì„¸ìš”.</p>';
                return;
            }

            appData.memos.forEach(memo => {
                const memoCard = document.createElement('div');
                memoCard.className = 'bg-white p-6 rounded-xl shadow-md border border-gray-200 flex flex-col';
                // textareaëŠ” valueë¡œ ë„£ì–´ì•¼ XSS ë°©ì§€
                const textarea = document.createElement('textarea');
                textarea.dataset.id = memo.id;
                textarea.className = 'memo-content-textarea w-full h-32 p-2 border rounded-lg mb-3 focus:outline-none focus:ring-2 focus:ring-blue-400 resize-y text-gray-800';
                textarea.value = memo.content;
                memoCard.appendChild(textarea);
                const bottomDiv = document.createElement('div');
                bottomDiv.className = 'flex justify-between items-center text-sm text-gray-500';
                const dateSpan = document.createElement('span');
                dateSpan.textContent = memo.createdAt;
                const delBtn = document.createElement('button');
                delBtn.dataset.id = memo.id;
                delBtn.className = 'delete-memo-btn text-red-500 hover:text-red-700 transition-colors duration-200';
                delBtn.innerHTML = '<i class="fas fa-trash-alt"></i> ì‚­ì œ';
                bottomDiv.appendChild(dateSpan);
                bottomDiv.appendChild(delBtn);
                memoCard.appendChild(bottomDiv);
                memoList.appendChild(memoCard);
            });
// XSS ë°©ì§€ìš© escape í•¨ìˆ˜
function escapeHtml(str) {
    return String(str)
        .replace(/&/g, '&amp;')
        .replace(/</g, '&lt;')
        .replace(/>/g, '&gt;')
        .replace(/"/g, '&quot;')
        .replace(/'/g, '&#39;');
}
            addMemoListeners();
        }

        function addMemoListeners() {
            document.querySelectorAll('.memo-content-textarea').forEach(textarea => {
                textarea.addEventListener('input', (e) => {
                    const memoId = e.target.dataset.id;
                    const memoIndex = appData.memos.findIndex(m => m.id === memoId);
                    if (memoIndex !== -1) {
                        appData.memos[memoIndex].content = e.target.value;
                        clearTimeout(memoSaveTimeout);
                        memoSaveTimeout = setTimeout(async () => {
                            debouncedSaveAppData(); // Now calls debounced save
                            console.log(`ë©”ëª¨ ${memoId} ìë™ ì €ì¥ë¨`);
                        }, 1000);
                    }
                });
            });

            document.querySelectorAll('.delete-memo-btn').forEach(button => {
                button.addEventListener('click', async (e) => {
                    const memoIdToDelete = e.target.dataset.id;
                    const confirmDelete = await showCustomAlert('ì´ ë©”ëª¨ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?', true);
                    if (confirmDelete) {
                        appData.memos = appData.memos.filter(m => m.id !== memoIdToDelete);
                        debouncedSaveAppData(); // Now calls debounced save
                        renderMemos();
                    }
                });
            });
        }

        // --- Data Management Functions (now in Settings) ---
        exportDataBtn.addEventListener('click', () => {
            try {
                const dataStr = JSON.stringify(appData, null, 2);
                const blob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `ìœ¡ê°œì¥ë°˜_í•™ê¸‰ìš´ì˜_ë°ì´í„°_${getFormattedDate()}.json`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                showCustomAlert('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ë‹¤ìš´ë¡œë“œë˜ì—ˆìŠµë‹ˆë‹¤!');
            } catch (e) {
                console.error('ë°ì´í„° ë‚´ë³´ë‚´ê¸° ì‹¤íŒ¨:', e);
                showCustomAlert('ë°ì´í„° ë‚´ë³´ë‚´ê¸°ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
            }
        });

        importFileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (file) {
                importFileNameSpan.textContent = file.name;
                confirmImportBtn.classList.remove('hidden');
            } else {
                importFileNameSpan.textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
                confirmImportBtn.classList.add('hidden');
            }
        });

        confirmImportBtn.addEventListener('click', async () => {
            const file = importFileInput.files[0];
            if (!file) {
                showCustomAlert('ê°€ì ¸ì˜¬ íŒŒì¼ì„ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                try {
                    const importedData = JSON.parse(e.target.result);
                    const confirmImport = await showCustomAlert('í˜„ì¬ ëª¨ë“  ë°ì´í„°ê°€ ê°€ì ¸ì˜¨ ë°ì´í„°ë¡œ ë®ì–´ì“°ì—¬ì§‘ë‹ˆë‹¤. ê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', true);
                    if (confirmImport) {
                        appData = importedData; // Overwrite current data
                        debouncedSaveAppData(); // Now calls debounced save
                        initializeUIAndData(); // Re-initialize app with new data
                        showCustomAlert('ë°ì´í„°ê°€ ì„±ê³µì ìœ¼ë¡œ ê°€ì ¸ì™€ì¡ŒìŠµë‹ˆë‹¤!');
                        importFileInput.value = '';
                        importFileNameSpan.textContent = 'ì„ íƒëœ íŒŒì¼ ì—†ìŒ';
                        confirmImportBtn.classList.add('hidden');
                    }
                } catch (error) {
                    console.error('ë°ì´í„° ê°€ì ¸ì˜¤ê¸° ì‹¤íŒ¨:', error);
                    showCustomAlert('íŒŒì¼ì„ ì½ê±°ë‚˜ íŒŒì‹±í•˜ëŠ” ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ì˜¬ë°”ë¥¸ JSON íŒŒì¼ì¸ì§€ í™•ì¸í•´ì£¼ì„¸ìš”.');
                }
            };
            reader.readAsText(file);
        });

        // --- Evaluation Functions ---
        evaluationPasswordSubmit.addEventListener('click', () => {
            const enteredPassword = evaluationPasswordInput.value;
            // ì‹¤ì œ ë¹„ë°€ë²ˆí˜¸ëŠ” appData.settings.evaluationPasswordì— ì €ì¥
            const REAL_PASSWORD = (appData.settings && appData.settings.evaluationPassword) ? appData.settings.evaluationPassword : '1234';
            if (enteredPassword === REAL_PASSWORD) {
                closeModal(evaluationPasswordModal);
                const targetSectionId = appData.currentSection;
                showSection(targetSectionId, true);
                if (targetSectionId === 'evaluationResults') {
                    renderEvaluationTable();
                } else if (targetSectionId === 'attendanceManagement') {
                    renderAttendanceTable();
                }
            } else {
                evaluationPasswordInput.value = '';
                evaluationPasswordInput.blur();
                showCustomAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.').then(() => {
                    // í¬ì»¤ìŠ¤ ìë™ ë³µì› ì—†ìŒ
                });
            }
        });

        evaluationPasswordInput.addEventListener('keypress', (e) => {
            // showCustomAlertê°€ ë–  ìˆëŠ” ë™ì•ˆì—ëŠ” Enterë¡œ submitì´ ì•„ì˜ˆ ë˜ì§€ ì•Šë„ë¡ ì°¨ë‹¨
            const customModalOverlay = document.getElementById('customModalOverlay');
            const isCustomModalOpen = customModalOverlay && !customModalOverlay.classList.contains('hidden');
            if (e.key === 'Enter' && !isCustomModalOpen) {
                evaluationPasswordSubmit.click();
            }
        });

        // Enter keyup ì‹œ block í•´ì œ
        evaluationPasswordInput.addEventListener('keyup', (e) => {
            if (e.key === 'Enter') {
                delete evaluationPasswordInput.dataset.blockEnter;
            }
        });

        changeEvaluationPasswordBtn.addEventListener('click', () => {
            openModal(changeEvaluationPasswordModal);
            currentEvaluationPasswordInput.value = '';
            newEvaluationPasswordInput.value = '';
            confirmNewEvaluationPasswordInput.value = '';
            currentEvaluationPasswordInput.focus();
            // ì¸ì¦ì½”ë“œ ëŒ€ì‹  íŠ¹ì • ë¬¸êµ¬ ì…ë ¥ ë°©ì‹ìœ¼ë¡œ ë³€ê²½
            if (!document.getElementById('reset-evaluation-password-btn')) {
                const resetBtn = document.createElement('button');
                resetBtn.id = 'reset-evaluation-password-btn';
                resetBtn.className = 'btn-danger text-white px-6 py-3 rounded-lg shadow-md transition-colors duration-200 mt-4';
                resetBtn.textContent = 'ë¹„ë°€ë²ˆí˜¸ 1234ë¡œ ì´ˆê¸°í™” (ì¸ì¦ í•„ìš”)';
                resetBtn.onclick = async function() {
                    const phrase = prompt("ë¹„ë°€ë²ˆí˜¸ ì´ˆê¸°í™”ë¥¼ ìœ„í•´ ì¸ì¦ ë¬¸êµ¬ë¥¼ ì…ë ¥í•˜ì„¸ìš”.");
                    if (phrase === 'boan-25') {
                        if (!appData.settings) appData.settings = {};
                        appData.settings.evaluationPassword = '1234';
                        debouncedSaveAppData();
                        showCustomAlert('ë¹„ë°€ë²ˆí˜¸ê°€ 1234ë¡œ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.');
                        closeModal(changeEvaluationPasswordModal);
                    } else {
                        showCustomAlert('ë¬¸êµ¬ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                    }
                };
                changeEvaluationPasswordModal.querySelector('.modal-content').appendChild(resetBtn);
            }
        // ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •(ì´ë©”ì¼ ë°œì†¡) ê¸°ëŠ¥
        const forgotPwBtn = document.getElementById('forgot-password-btn');
        if (forgotPwBtn) {
            forgotPwBtn.addEventListener('click', async () => {
                const emailInput = document.getElementById('email-input');
                const email = emailInput ? emailInput.value.trim() : '';
                if (!email) {
                    showCustomAlert('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì¼ì„ ë°›ì„ ì´ë©”ì¼ì„ ì…ë ¥í•˜ì„¸ìš”.');
                    return;
                }
                try {
                    const { getAuth, sendPasswordResetEmail } = await import('https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js');
                    await sendPasswordResetEmail(getAuth(), email);
                    showCustomAlert('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì¼ì´ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤. ë©”ì¼í•¨ì„ í™•ì¸í•˜ì„¸ìš”.');
                } catch (e) {
                    showCustomAlert('ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë©”ì¼ ë°œì†¡ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤. ê°€ì…ëœ ì´ë©”ì¼ì¸ì§€ í™•ì¸í•˜ì„¸ìš”.');
                }
            });
        }
        });

        changeEvaluationPasswordSubmit.addEventListener('click', async () => {
            const currentPw = currentEvaluationPasswordInput.value.trim();
            const newPw = newEvaluationPasswordInput.value.trim();
            const confirmPw = confirmNewEvaluationPasswordInput.value.trim();
            if (!newPw || newPw.length < 4) {
                showCustomAlert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ëŠ” 4ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }
            if (newPw !== confirmPw) {
                showCustomAlert('ìƒˆ ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
                return;
            }
            if (!appData.settings) appData.settings = {};
            if (!appData.settings.evaluationPassword || appData.settings.evaluationPassword === currentPw) {
                appData.settings.evaluationPassword = newPw;
                debouncedSaveAppData();
                showCustomAlert('ë¹„ë°€ë²ˆí˜¸ê°€ ì„±ê³µì ìœ¼ë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤.');
                closeModal(changeEvaluationPasswordModal);
                currentEvaluationPasswordInput.value = '';
                newEvaluationPasswordInput.value = '';
                confirmNewEvaluationPasswordInput.value = '';
            } else {
                showCustomAlert('í˜„ì¬ ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.');
            }
        });

        manageSubjectsBtn.addEventListener('click', () => {
            openModal(subjectModal);
            renderSubjectList();
            subjectInput.focus();
        });

        function renderSubjectList() {
            subjectList.innerHTML = '';
            appData.evaluations.forEach(subject => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm';
                li.innerHTML = `
                    <span class="text-gray-800 text-lg">${subject.name}</span>
                    <div class="flex space-x-2">
                        <button data-id="${subject.id}" class="manage-unit-tests-btn bg-blue-400 text-white px-3 py-1 rounded-md hover:bg-blue-500 transition-colors duration-200">ë‹¨ì›í‰ê°€ ê´€ë¦¬</button>
                        <button data-id="${subject.id}" class="delete-subject-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                            <i class="fas fa-trash-alt"></i>
                        </button>
                    </div>
                `;
                subjectList.appendChild(li);
            });
            addSubjectDeleteListeners();
            addManageUnitTestsListeners();
        }

        function addSubjectDeleteListeners() {
            document.querySelectorAll('.delete-subject-btn').forEach(button => {
                button.onclick = async (e) => {
                    const subjectIdToDelete = e.currentTarget.dataset.id;
                    const subjectName = appData.evaluations.find(s => s.id === subjectIdToDelete)?.name;
                    const confirmDelete = await showCustomAlert(`${subjectName} ê³¼ëª©ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ê³¼ëª©ì˜ ëª¨ë“  ë‹¨ì›í‰ê°€ ê²°ê³¼ë„ ì‚­ì œë©ë‹ˆë‹¤.`, true);
                    if (confirmDelete) {
                        appData.evaluations = appData.evaluations.filter(s => s.id !== subjectIdToDelete);
                        debouncedSaveAppData(); // Now calls debounced save
                        renderSubjectList();
                        renderEvaluationTable();
                    }
                };
            });
        }

        subjectInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && subjectInput.value.trim() !== '') {
                const newSubjectName = subjectInput.value.trim();
                if (!appData.evaluations.some(s => s.name === newSubjectName)) {
                    const newSubjectId = generateUniqueId();
                    appData.evaluations.push({ id: newSubjectId, name: newSubjectName, units: [] });
                    debouncedSaveAppData(); // Now calls debounced save
                    renderSubjectList();
                    renderEvaluationTable();
                    subjectInput.value = '';
                } else {
                    showCustomAlert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ê³¼ëª©ëª…ì…ë‹ˆë‹¤.');
                }
            }
        });

        function addManageUnitTestsListeners() {
            document.querySelectorAll('.manage-unit-tests-btn').forEach(button => {
                button.onclick = (e) => {
                    currentSubjectIdForUnitTests = e.currentTarget.dataset.id;
                    const subject = appData.evaluations.find(s => s.id === currentSubjectIdForUnitTests);
                    if (subject) {
                        unitTestSubjectName.textContent = subject.name;
                        openModal(unitTestModal);
                        renderUnitTestList(subject.id);
                        unitTestInput.focus();
                    }
                };
            });
        }

        function renderUnitTestList(subjectId) {
            unitTestList.innerHTML = '';
            const subject = appData.evaluations.find(s => s.id === subjectId);
            if (!subject) return;

            subject.units.forEach(unit => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm';
                li.innerHTML = `
                    <span class="text-gray-800 text-lg">${unit.name}</span>
                    <button data-subject-id="${subject.id}" data-unit-id="${unit.id}" class="delete-unit-test-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                        <i class="fas fa-trash-alt"></i>
                    </button>
                `;
                unitTestList.appendChild(li);
            });
            addUnitTestDeleteListeners();
        }

        function addUnitTestDeleteListeners() {
            document.querySelectorAll('.delete-unit-test-btn').forEach(button => {
                button.onclick = async (e) => {
                    const subjectId = e.currentTarget.dataset.subjectId;
                    const unitIdToDelete = e.currentTarget.dataset.unitId;
                    const subject = appData.evaluations.find(s => s.id === subjectId);
                    const unitName = subject?.units.find(u => u.id === unitIdToDelete)?.name;

                    const confirmDelete = await showCustomAlert(`${subject.name} - ${unitName} ë‹¨ì›í‰ê°€ë¥¼ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ë‹¨ì›í‰ê°€ì˜ ëª¨ë“  í•™ìƒ ê²°ê³¼ë„ ì‚­ì œë©ë‹ˆë‹¤.`, true);
                    if (confirmDelete && subject) {
                        subject.units = subject.units.filter(u => u.id !== unitIdToDelete);
                        debouncedSaveAppData(); // Now calls debounced save
                        renderUnitTestList(subjectId);
                        renderEvaluationTable();
                    }
                };
            });
        }

        unitTestInput.addEventListener('keypress', async (e) => {
            if (e.key === 'Enter' && unitTestInput.value.trim() !== '' && currentSubjectIdForUnitTests) {
                const newUnitTestName = unitTestInput.value.trim();
                const subject = appData.evaluations.find(s => s.id === currentSubjectIdForUnitTests);
                if (subject && !subject.units.some(u => u.name === newUnitTestName)) {
                    const newUnitId = generateUniqueId();
                    subject.units.push({ id: newUnitId, name: newUnitTestName, results: {} });
                    debouncedSaveAppData(); // Now calls debounced save
                    renderUnitTestList(currentSubjectIdForUnitTests);
                    renderEvaluationTable();
                    unitTestInput.value = '';
                } else if (subject) {
                    showCustomAlert('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ë‹¨ì›í‰ê°€ëª…ì…ë‹ˆë‹¤.');
                }
            }
        });

        function renderEvaluationTable() {
            evaluationTableHeader.innerHTML = '';
            evaluationTableBody.innerHTML = '';

            if (appData.students.length === 0) {
                evaluationTableBody.innerHTML = `<tr><td colspan="${appData.evaluations.length + 1}" class="py-4 text-gray-500">í•™ìƒ ëª…ë‹¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }
            if (appData.evaluations.length === 0) {
                evaluationTableBody.innerHTML = `<tr><td colspan="${appData.students.length + 1}" class="py-4 text-gray-500">í‰ê°€ ê³¼ëª©ì´ ì—†ìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }

            const headerRow1 = document.createElement('tr');
            const headerRow2 = document.createElement('tr');

            const studentNameTh = document.createElement('th');
            studentNameTh.rowSpan = 2;
            studentNameTh.className = 'py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider border';
            studentNameTh.textContent = 'í•™ìƒëª…';
            headerRow1.appendChild(studentNameTh);

            appData.evaluations.forEach(subject => {
                const subjectTh = document.createElement('th');
                subjectTh.colSpan = (subject.units.length > 0 ? subject.units.length : 1);
                subjectTh.className = 'py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider border';
                subjectTh.textContent = subject.name;
                headerRow1.appendChild(subjectTh);

                if (subject.units.length === 0) {
                    const emptyUnitTh = document.createElement('th');
                    emptyUnitTh.className = 'py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider border';
                    emptyUnitTh.textContent = '-';
                    headerRow2.appendChild(emptyUnitTh);
                } else {
                    subject.units.forEach(unit => {
                        const unitTh = document.createElement('th');
                        unitTh.className = 'py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider border';
                        unitTh.textContent = unit.name;
                        headerRow2.appendChild(unitTh);
                    });
                }
            });

            evaluationTableHeader.appendChild(headerRow1);
            evaluationTableHeader.appendChild(headerRow2);

            appData.students.forEach(student => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-100 transition-colors duration-150';

                const studentNameTd = document.createElement('td');
                studentNameTd.className = 'py-3 px-6 whitespace-nowrap font-medium text-gray-900 border';
                studentNameTd.textContent = student.name;
                tr.appendChild(studentNameTd);

                appData.evaluations.forEach(subject => {
                    if (subject.units.length === 0) {
                        const emptyCell = document.createElement('td');
                        emptyCell.className = 'py-3 px-6 border text-gray-400';
                        emptyCell.textContent = '-';
                        tr.appendChild(emptyCell);
                    } else {
                        subject.units.forEach(unit => {
                            const studentResult = unit.results[student.id] || { grade: '', score: '' };
                            const grade = studentResult.grade || '';
                            const score = studentResult.score || '';

                            const combinedTd = document.createElement('td');
                            combinedTd.className = 'py-3 px-6 border';
                            combinedTd.innerHTML = `
                                <div class="evaluation-input-group">
                                    <select class="evaluation-grade-select"
                                            data-student-id="${student.id}"
                                            data-subject-id="${subject.id}"
                                            data-unit-id="${unit.id}"
                                            data-type="grade">
                                        ${EVALUATION_GRADES.map(g => `<option value="${g}" ${g === grade ? 'selected' : ''}>${g}</option>`).join('')}
                                    </select>
                                    <input type="number"
                                           class="evaluation-score-input"
                                           value="${score}"
                                           placeholder="ì ìˆ˜"
                                           data-student-id="${student.id}"
                                           data-subject-id="${subject.id}"
                                           data-unit-id="${unit.id}"
                                           data-type="score">
                                </div>
                            `;
                            tr.appendChild(combinedTd);
                        });
                    }
                });
                evaluationTableBody.appendChild(tr);
            });

            addEvaluationInputListeners();
        }

        function addEvaluationInputListeners() {
            document.querySelectorAll('.evaluation-grade-select, .evaluation-score-input').forEach(input => {
                input.addEventListener('change', async (e) => {
                    const studentId = e.target.dataset.studentId;
                    const subjectId = e.target.dataset.subjectId;
                    const unitId = e.target.dataset.unitId;
                    const type = e.target.dataset.type;
                    const value = e.target.value;

                    const subject = appData.evaluations.find(s => s.id === subjectId);
                    const unit = subject?.units.find(u => u.id === unitId);

                    if (unit) {
                        if (!unit.results[studentId]) {
                            unit.results[studentId] = { grade: '', score: '' };
                        }
                        if (type === 'grade') {
                            unit.results[studentId].grade = value;
                        } else if (type === 'score') {
                            unit.results[studentId].score = value === '' ? '' : parseInt(value);
                        }
                        debouncedSaveAppData(); // Now calls debounced save
                    }
                });
            });
        }

        // --- Attendance Functions ---
        attendanceMonthPicker.addEventListener('change', async (e) => {
            appData.currentAttendanceMonth = e.target.value;
            debouncedSaveAppData(); // Now calls debounced save
            renderAttendanceTable();
        });

        prevMonthBtn.addEventListener('click', async () => {
            const [year, month] = appData.currentAttendanceMonth.split('-').map(Number);
            const date = new Date(year, month - 2, 1);
            appData.currentAttendanceMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            attendanceMonthPicker.value = appData.currentAttendanceMonth;
            debouncedSaveAppData(); // Now calls debounced save
            renderAttendanceTable();
        });

        nextMonthBtn.addEventListener('click', async () => {
            const [year, month] = appData.currentAttendanceMonth.split('-').map(Number);
            const date = new Date(year, month, 1);
            appData.currentAttendanceMonth = `${date.getFullYear()}-${String(date.getMonth() + 1).padStart(2, '0')}`;
            attendanceMonthPicker.value = appData.currentAttendanceMonth;
            debouncedSaveAppData(); // Now calls debounced save
            renderAttendanceTable();
        });

        function getDaysInMonth(year, month) {
            return new Date(year, month, 0).getDate();
        }

        function isWeekend(year, month, day) {
            const date = new Date(year, month - 1, day);
            const dayOfWeek = date.getDay();
            return dayOfWeek === 0 || dayOfWeek === 6;
        }

        function isNoClassDay(year, month, day) {
            const monthKey = `${year}-${String(month).padStart(2, '0')}`;
            const dayKey = String(day).padStart(2, '0');
            return appData.noClassDays[monthKey] && appData.noClassDays[monthKey].includes(dayKey);
        }

        function renderAttendanceTable() {
            attendanceTableHeader.innerHTML = '';
            attendanceTableBody.innerHTML = '';

            if (appData.students.length === 0) {
                attendanceTableBody.innerHTML = `<tr><td colspan="32" class="py-4 text-gray-500">í•™ìƒ ëª…ë‹¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</td></tr>`;
                return;
            }

            const [year, month] = appData.currentAttendanceMonth.split('-').map(Number);
            const daysInMonth = getDaysInMonth(year, month);

            const headerRow = document.createElement('tr');
            const studentNameTh = document.createElement('th');
            studentNameTh.className = 'py-3 px-6 text-center text-sm font-medium text-gray-700 uppercase tracking-wider border sticky left-0 z-20 bg-gray-200';
            studentNameTh.textContent = 'í•™ìƒëª…';
            headerRow.appendChild(studentNameTh);

            for (let i = 1; i <= daysInMonth; i++) {
                const dateTh = document.createElement('th');
                dateTh.className = 'py-3 px-2 text-center text-sm font-medium text-gray-700 uppercase tracking-wider border';
                dateTh.textContent = i;
                headerRow.appendChild(dateTh);
            }
            attendanceTableHeader.appendChild(headerRow);

            appData.students.forEach(student => {
                const tr = document.createElement('tr');
                const studentNameTd = document.createElement('td');
                studentNameTd.className = 'py-3 px-6 whitespace-nowrap font-medium text-gray-900 border sticky left-0 z-10 bg-white';
                studentNameTd.textContent = student.name;
                tr.appendChild(studentNameTd);

                if (!appData.attendance[appData.currentAttendanceMonth]) {
                    appData.attendance[appData.currentAttendanceMonth] = {};
                }
                if (!appData.attendance[appData.currentAttendanceMonth][student.id]) {
                    appData.attendance[appData.currentAttendanceMonth][student.id] = {};
                }

                for (let i = 1; i <= daysInMonth; i++) {
                    const day = String(i).padStart(2, '0');
                    const attendanceData = appData.attendance[appData.currentAttendanceMonth][student.id][day] || { status: 'ì¶œì„', detail: '' };

                    const attendanceTd = document.createElement('td');
                    attendanceTd.className = 'py-1 px-1 border';

                    if (isWeekend(year, month, i) || isNoClassDay(year, month, i)) {
                        attendanceTd.classList.add('bg-gray-200', 'text-gray-500', 'font-semibold');
                        attendanceTd.textContent = 'íœ´ë¬´';
                    } else {
                        attendanceTd.innerHTML = `
                            <select class="attendance-status-select"
                                    data-student-id="${student.id}"
                                    data-day="${day}"
                                    data-type="status">
                            </select>
                            <select class="attendance-detail-select ${attendanceData.status === 'ì¶œì„' ? 'hidden' : ''}"
                                    data-student-id="${student.id}"
                                    data-day="${day}"
                                    data-type="detail">
                            </select>
                        `;
                    }
                    tr.appendChild(attendanceTd);
                }
                attendanceTableBody.appendChild(tr);
            });

            addAttendanceInputListeners();
            populateAttendanceTableDropdowns();
        }

        function populateAttendanceTableDropdowns() {
            document.querySelectorAll('.attendance-status-select').forEach(select => {
                select.innerHTML = '';
                for (const statusKey in ATTENDANCE_STATUSES) {
                    const option = document.createElement('option');
                    option.value = statusKey;
                    option.textContent = ATTENDANCE_STATUSES[statusKey];
                    select.appendChild(option);
                }
                const studentId = select.dataset.studentId;
                const day = select.dataset.day;
                const attendanceData = appData.attendance[appData.currentAttendanceMonth]?.[studentId]?.[day] || { status: 'ì¶œì„', detail: '' };
                select.value = attendanceData.status;
            });

            document.querySelectorAll('.attendance-detail-select').forEach(select => {
                select.innerHTML = '';
                for (const detailKey in ATTENDANCE_DETAILS) {
                    const option = document.createElement('option');
                    option.value = detailKey;
                    option.textContent = ATTENDANCE_DETAILS[detailKey];
                    select.appendChild(option);
                }
                const studentId = select.dataset.studentId;
                const day = select.dataset.day;
                const attendanceData = appData.attendance[appData.currentAttendanceMonth]?.[studentId]?.[day] || { status: 'ì¶œì„', detail: '' };
                select.value = attendanceData.detail;
                if (attendanceData.status === 'ì¶œì„') {
                    select.classList.add('hidden');
                } else {
                    select.classList.remove('hidden');
                }
            });
        }


        function addAttendanceInputListeners() {
            document.querySelectorAll('.attendance-status-select').forEach(select => {
                select.addEventListener('change', async (e) => {
                    const studentId = e.target.dataset.studentId;
                    const day = e.target.dataset.day;
                    const newStatus = e.target.value;
                    const detailSelect = e.target.nextElementSibling;

                    if (!appData.attendance[appData.currentAttendanceMonth][studentId]) {
                        appData.attendance[appData.currentAttendanceMonth][studentId] = {};
                    }
                    if (!appData.attendance[appData.currentAttendanceMonth][studentId][day]) {
                        appData.attendance[appData.currentAttendanceMonth][studentId][day] = { status: 'ì¶œì„', detail: '' };
                    }

                    appData.attendance[appData.currentAttendanceMonth][studentId][day].status = newStatus;

                    if (newStatus === 'ì¶œì„') {
                        detailSelect.classList.add('hidden');
                        appData.attendance[appData.currentAttendanceMonth][studentId][day].detail = '';
                        detailSelect.value = '';
                    } else {
                        detailSelect.classList.remove('hidden');
                    }
                    debouncedSaveAppData(); // Now calls debounced save
                });
            });

            document.querySelectorAll('.attendance-detail-select').forEach(select => {
                select.addEventListener('change', async (e) => {
                    const studentId = e.target.dataset.studentId;
                    const day = e.target.dataset.day;
                    const newDetail = e.target.value;

                    if (!appData.attendance[appData.currentAttendanceMonth][studentId]) {
                        appData.attendance[appData.currentAttendanceMonth][studentId] = {};
                    }
                    if (!appData.attendance[appData.currentAttendanceMonth][studentId][day]) {
                        appData.attendance[appData.currentAttendanceMonth][studentId][day] = { status: 'ì¶œì„', detail: '' };
                    }
                    appData.attendance[appData.currentAttendanceMonth][studentId][day].detail = newDetail;
                    debouncedSaveAppData(); // Now calls debounced save
                });
            });
        }

        // --- Monthly Attendance Statistics Functions ---
        viewMonthlyStatsBtn.addEventListener('click', () => {
            openModal(monthlyStatsModal);
            calculateAndRenderMonthlyAttendanceStats();
        });

        function calculateAndRenderMonthlyAttendanceStats() {
            monthlyStatsTableBody.innerHTML = '';
            noStatsMessage.classList.add('hidden');

            const [year, month] = appData.currentAttendanceMonth.split('-').map(Number);
            const daysInMonth = getDaysInMonth(year, month);
            statsMonthDisplay.textContent = `${year}ë…„ ${month}ì›”`;

            if (appData.students.length === 0) {
                noStatsMessage.textContent = 'í•™ìƒ ëª…ë‹¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.';
                noStatsMessage.classList.remove('hidden');
                return;
            }

            const monthlyStats = {};
            let classDaysCount = 0;

            for (let i = 1; i <= daysInMonth; i++) {
                if (!isWeekend(year, month, i) && !isNoClassDay(year, month, i)) {
                    classDaysCount++;
                }
            }

            appData.students.forEach(student => {
                monthlyStats[student.id] = {
                    name: student.name,
                    classDays: classDaysCount,
                    ì¶œì„: 0,
                    ê²°ì„: 0,
                    ì§€ê°: 0,
                    ì¡°í‡´: 0,
                    ê²°ê³¼: 0
                };

                const studentAttendanceForMonth = appData.attendance[appData.currentAttendanceMonth]?.[student.id] || {};

                for (let i = 1; i <= daysInMonth; i++) {
                    if (!isWeekend(year, month, i) && !isNoClassDay(year, month, i)) {
                        const day = String(i).padStart(2, '0');
                        const status = studentAttendanceForMonth[day]?.status || 'ì¶œì„';

                        if (ATTENDANCE_STATUSES[status]) {
                            monthlyStats[student.id][status]++;
                        }
                    }
                }
            });

            if (Object.keys(monthlyStats).length === 0) {
                noStatsMessage.textContent = 'ì„ íƒëœ ì›”ì— ì¶œê²° ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤.';
                noStatsMessage.classList.remove('hidden');
                return;
            }

            const statsTableHeaderRow = monthlyStatsModal.querySelector('thead tr');
            statsTableHeaderRow.children[1].textContent = 'ìˆ˜ì—… ì¼ìˆ˜';

            Object.values(monthlyStats).forEach(stats => {
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-100 transition-colors duration-150';
                tr.innerHTML = `
                    <td class="py-3 px-6 whitespace-nowrap font-medium text-gray-900 border student-name-cell" data-student-id="${Object.keys(monthlyStats).find(id => monthlyStats[id].name === stats.name)}">${stats.name}</td>
                    <td class="py-3 px-6 whitespace-nowrap border">${stats.classDays}</td>
                    <td class="py-3 px-6 whitespace-nowrap border">${stats.ì¶œì„}</td>
                    <td class="py-3 px-6 whitespace-nowrap border">${stats.ê²°ì„}</td>
                    <td class="py-3 px-6 whitespace-nowrap border">${stats.ì§€ê°}</td>
                    <td class="py-3 px-6 whitespace-nowrap border">${stats.ì¡°í‡´}</td>
                    <td class="py-3 px-6 whitespace-nowrap border">${stats.ê²°ê³¼}</td>
                `;
                monthlyStatsTableBody.appendChild(tr);
            });
            addStudentNameClickListeners();
        }

        function addStudentNameClickListeners() {
            document.querySelectorAll('.student-name-cell').forEach(cell => {
                cell.style.cursor = 'pointer';
                cell.addEventListener('click', (e) => {
                    const studentId = e.currentTarget.dataset.studentId;
                    const studentName = e.currentTarget.textContent;
                    showStudentAttendanceDetail(studentId, studentName);
                });
            });
        }

        function showStudentAttendanceDetail(studentId, studentName) {
            openModal(studentAttendanceDetailModal);
            detailStudentName.textContent = studentName;
            detailMonthDisplay.textContent = appData.currentAttendanceMonth;
            studentAttendanceDetailTableBody.innerHTML = '';
            noDetailMessage.classList.add('hidden');

            const [year, month] = appData.currentAttendanceMonth.split('-').map(Number);
            const daysInMonth = getDaysInMonth(year, month);
            const studentAttendanceForMonth = appData.attendance[appData.currentAttendanceMonth]?.[studentId] || {};

            let hasDetail = false;
            for (let i = 1; i <= daysInMonth; i++) {
                const date = new Date(year, month - 1, i);
                const day = String(i).padStart(2, '0');
                const dayOfWeek = date.toLocaleDateString('ko-KR', { weekday: 'short' });
                const status = studentAttendanceForMonth[day]?.status || 'ì¶œì„';
                const detail = studentAttendanceForMonth[day]?.detail || '';

                if (isWeekend(year, month, i) || isNoClassDay(year, month, i)) {
                    continue;
                }

                if (status === 'ì¶œì„') {
                    continue;
                }

                hasDetail = true;
                const tr = document.createElement('tr');
                tr.className = 'hover:bg-gray-100 transition-colors duration-150';
                tr.innerHTML = `
                    <td class="py-3 px-6 whitespace-nowrap border">${year}ë…„ ${month}ì›” ${i}ì¼</td>
                    <td class="py-3 px-6 whitespace-nowrap border">${dayOfWeek}</td>
                    <td class="py-3 px-6 whitespace-nowrap border">${ATTENDANCE_STATUSES[status]}</td>
                    <td class="py-3 px-6 whitespace-nowrap border">${ATTENDANCE_DETAILS[detail] || '-'}</td>
                `;
                studentAttendanceDetailTableBody.appendChild(tr);
            }

            if (!hasDetail) {
                noDetailMessage.classList.remove('hidden');
            }
        }

        manageNoClassDaysBtn.addEventListener('click', () => {
            openModal(noClassDaysModal);
            const [year, month] = appData.currentAttendanceMonth.split('-');
            noClassMonthDisplay.textContent = `${year}ë…„ ${parseInt(month)}ì›”`;
            noClassDateInput.value = '';
            renderNoClassDaysList();
        });

        addNoClassDayBtn.addEventListener('click', async () => {
            const dateValue = noClassDateInput.value;
            if (!dateValue) {
                showCustomAlert('ë‚ ì§œë¥¼ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const [year, month, day] = dateValue.split('-');
            const monthKey = `${year}-${month}`;
            const dayKey = day;

            if (!appData.noClassDays[monthKey]) {
                appData.noClassDays[monthKey] = [];
            }

            if (!appData.noClassDays[monthKey].includes(dayKey)) {
                appData.noClassDays[monthKey].push(dayKey);
                appData.noClassDays[monthKey].sort();
                debouncedSaveAppData();
                renderNoClassDaysList();
                renderAttendanceTable();
                showCustomAlert(`${dateValue}ì„(ë¥¼) ìˆ˜ì—… ì—†ëŠ” ë‚ ë¡œ ì¶”ê°€í–ˆìŠµë‹ˆë‹¤.`);
            } else {
                showCustomAlert('ì´ë¯¸ ì¶”ê°€ëœ ë‚ ì§œì…ë‹ˆë‹¤.');
            }
            noClassDateInput.value = '';
        });

        function renderNoClassDaysList() {
            noClassDaysList.innerHTML = '';
            const [year, month] = appData.currentAttendanceMonth.split('-');
            const monthKey = `${year}-${month}`;
            const daysInMonth = appData.noClassDays[monthKey] || [];

            if (daysInMonth.length === 0) {
                noNoClassDaysMessage.classList.remove('hidden');
                return;
            } else {
                noNoClassDaysMessage.classList.add('hidden');
            }

            daysInMonth.forEach(day => {
                const li = document.createElement('li');
                li.className = 'flex justify-between items-center bg-white p-3 rounded-md shadow-sm';
                li.innerHTML = `
                    <span class="text-gray-800 text-lg">${year}ë…„ ${parseInt(month)}ì›” ${parseInt(day)}ì¼</span>
                    <button data-month="${monthKey}" data-day="${day}" class="delete-no-class-day-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                        <i class="fas fa-trash-alt"></i> ì‚­ì œ
                    </button>
                `;
                noClassDaysList.appendChild(li);
            });
            addNoClassDayDeleteListeners();
        }

        function addNoClassDayDeleteListeners() {
            document.querySelectorAll('.delete-no-class-day-btn').forEach(button => {
                button.onclick = async (e) => {
                    const monthKey = e.currentTarget.dataset.month;
                    const dayKeyToDelete = e.currentTarget.dataset.day;
                    const confirmDelete = await showCustomAlert(`${monthKey}ì›” ${dayKeyToDelete}ì¼ì„ ìˆ˜ì—… ì—†ëŠ” ë‚ ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, true);
                    if (confirmDelete) {
                        if (appData.noClassDays[monthKey]) {
                            appData.noClassDays[monthKey] = appData.noClassDays[monthKey].filter(d => d !== dayKeyToDelete);
                            if (appData.noClassDays[monthKey].length === 0) {
                                delete appData.noClassDays[monthKey];
                            }
                            debouncedSaveAppData();
                            renderNoClassDaysList();
                            renderAttendanceTable();
                        }
                    }
                };
            });
        }

        batchAttendanceBtn.addEventListener('click', () => {
            openModal(batchAttendanceModal);
            renderBatchStudentSelection();
            const today = new Date();
            const firstDayOfMonth = new Date(today.getFullYear(), today.getMonth(), 1);
            const lastDayOfMonth = new Date(today.getFullYear(), today.getMonth() + 1, 0);
            batchStartDateInput.value = firstDayOfMonth.toISOString().split('T')[0];
            batchEndDateInput.value = lastDayOfMonth.toISOString().split('T')[0];
            batchAttendanceStatusSelect.value = 'ì¶œì„';
            batchAttendanceDetailContainer.classList.add('hidden');
        });

        batchAttendanceStatusSelect.addEventListener('change', (e) => {
            if (e.target.value === 'ì¶œì„') {
                batchAttendanceDetailContainer.classList.add('hidden');
                batchAttendanceDetailSelect.value = '';
            } else {
                batchAttendanceDetailContainer.classList.remove('hidden');
            }
        });

        function populateBatchAttendanceDropdowns() {
            batchAttendanceStatusSelect.innerHTML = '';
            for (const statusKey in ATTENDANCE_STATUSES) {
                const option = document.createElement('option');
                option.value = statusKey;
                option.textContent = ATTENDANCE_STATUSES[statusKey];
                batchAttendanceStatusSelect.appendChild(option);
            }
            batchAttendanceStatusSelect.value = 'ì¶œì„';

            batchAttendanceDetailSelect.innerHTML = '';
            for (const detailKey in ATTENDANCE_DETAILS) {
                const option = document.createElement('option');
                option.value = detailKey;
                option.textContent = ATTENDANCE_DETAILS[detailKey];
                batchAttendanceDetailSelect.appendChild(option);
            }
            batchAttendanceDetailSelect.value = '';
            batchAttendanceDetailContainer.classList.add('hidden');
        }


        function renderBatchStudentSelection() {
            batchStudentSelectionDiv.innerHTML = '';
            if (appData.students.length === 0) {
                batchStudentSelectionDiv.innerHTML = '<p class="text-gray-500">í•™ìƒ ëª…ë‹¨ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤.</p>';
                return;
            }
            appData.students.forEach(student => {
                const div = document.createElement('div');
                div.className = 'flex items-center';
                div.innerHTML = `
                    <input type="checkbox" id="batch-student-${student.id}" value="${student.id}" class="batch-student-checkbox h-4 w-4 text-blue-600 rounded focus:ring-blue-500 mr-2">
                    <label for="batch-student-${student.id}" class="text-gray-800">${student.name}</label>
                `;
                batchStudentSelectionDiv.appendChild(div);
            });
        }

        applyBatchAttendanceBtn.addEventListener('click', async () => {
            const startDateStr = batchStartDateInput.value;
            const endDateStr = batchEndDateInput.value;
            const selectedStatus = batchAttendanceStatusSelect.value;
            const selectedDetail = batchAttendanceDetailSelect.value;

            if (!startDateStr || !endDateStr) {
                showCustomAlert('ì‹œì‘ì¼ê³¼ ì¢…ë£Œì¼ì„ ëª¨ë‘ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const startDate = new Date(startDateStr);
            const endDate = new Date(endDateStr);

            if (startDate > endDate) {
                showCustomAlert('ì‹œì‘ì¼ì€ ì¢…ë£Œì¼ë³´ë‹¤ ë¹ ë¥´ê±°ë‚˜ ê°™ì•„ì•¼ í•©ë‹ˆë‹¤.');
                return;
            }

            const selectedStudentIds = Array.from(document.querySelectorAll('.batch-student-checkbox:checked'))
                                            .map(checkbox => checkbox.value);

            if (selectedStudentIds.length === 0) {
                showCustomAlert('ì ìš©í•  í•™ìƒì„ í•œ ëª… ì´ìƒ ì„ íƒí•´ì£¼ì„¸ìš”.');
                return;
            }

            const confirmApply = await showCustomAlert('ì„ íƒí•œ ê¸°ê°„ê³¼ í•™ìƒë“¤ì—ê²Œ ì¶œê²° ë‚´ì—­ì„ ì¼ê´„ ì ìš©í•˜ì‹œê² ìŠµë‹ˆê¹Œ?', true);
            if (!confirmApply) {
                return;
            }

            let currentDate = new Date(startDate);
            while (currentDate <= endDate) {
                const year = currentDate.getFullYear();
                const month = String(currentDate.getMonth() + 1).padStart(2, '0');
                const day = String(currentDate.getDate()).padStart(2, '0');
                const monthKey = `${year}-${month}`;
                const dayKey = day;

                if (!isWeekend(year, parseInt(month), parseInt(day)) && !isNoClassDay(year, parseInt(month), parseInt(day))) {
                    selectedStudentIds.forEach(studentId => {
                        if (!appData.attendance[monthKey]) {
                            appData.attendance[monthKey] = {};
                        }
                        if (!appData.attendance[monthKey][studentId]) {
                            appData.attendance[monthKey][studentId] = {};
                        }
                        appData.attendance[monthKey][studentId][dayKey] = {
                            status: selectedStatus,
                            detail: selectedStatus === 'ì¶œì„' ? '' : selectedDetail
                        };
                    });
                }
                currentDate.setDate(currentDate.getDate() + 1);
            }

            debouncedSaveAppData();
            renderAttendanceTable();
            closeModal(batchAttendanceModal);
            showCustomAlert('ì¶œê²° ë‚´ì—­ì´ ì„±ê³µì ìœ¼ë¡œ ì¼ê´„ ì ìš©ë˜ì—ˆìŠµë‹ˆë‹¤.');
        });
        function populateThemeSelection() {
            themeSelectionDiv.innerHTML = '';
            for (const themeKey in THEMES) {
                const theme = THEMES[themeKey];
                const themeButton = document.createElement('button');
                themeButton.className = `px-6 py-3 rounded-lg shadow-md transition-colors duration-200 text-white font-semibold flex flex-col items-center justify-center`;
                themeButton.style.backgroundColor = theme.primaryBtnBg;
                themeButton.textContent = theme.name;
                themeButton.dataset.theme = themeKey;
                if (appData.settings.currentTheme === themeKey) {
                    themeButton.classList.add('ring-4', 'ring-blue-500');
                }
                themeButton.addEventListener('click', () => {
                    appData.settings.currentTheme = themeKey;
                    debouncedSaveAppData();
                    applyTheme(themeKey);
                    document.querySelectorAll('#theme-selection button').forEach(btn => {
                        btn.classList.remove('ring-4', 'ring-blue-500');
                    });
                    themeButton.classList.add('ring-4', 'ring-blue-500');
                });
                themeSelectionDiv.appendChild(themeButton);
            }
        }

        function applyTheme(themeKey) {
            const theme = THEMES[themeKey];
            if (!theme) return;

            const root = document.documentElement;
            for (const cssVar in theme) {
                if (cssVar !== 'name' && !cssVar.startsWith('noticeBoard')) {
                    const cssPropertyName = `--${cssVar.replace(/([A-Z])/g, '-$1').toLowerCase()}`;
                    root.style.setProperty(cssPropertyName, theme[cssVar]);
                }
            }

            navButtons.forEach(button => {
                if (button.dataset.section === appData.currentSection) {
                    button.classList.add('active');
                } else {
                    button.classList.remove('active');
                }
            });
        }
             // ì•Œë¦¼ì¥ ì „ì²´í™”ë©´ ê¸°ëŠ¥
            const fullscreenBtn = document.getElementById('fullscreen-notice-btn');
            const noticeBoardSection = document.getElementById('noticeBoard');
            
            if (fullscreenBtn && noticeBoardSection) {
                fullscreenBtn.addEventListener('click', () => {
                    const isFullscreen = noticeBoardSection.classList.toggle('fullscreen-active');
                    
                    if (isFullscreen) {
                        fullscreenBtn.innerHTML = '<i class="fas fa-compress"></i> í™”ë©´ ì¶•ì†Œ';
                    } else {
                        fullscreenBtn.innerHTML = '<i class="fas fa-expand"></i> ì „ì²´í™”ë©´';
                    }
                });
            }
                document.addEventListener('DOMContentLoaded', () => {
        // ----------------------- í•™ìƒ ë½‘ê¸° ê²°ê³¼ ì´ˆê¸°í™” ê¸°ëŠ¥ -----------------------
        const resetStudentLotteryBtn = document.getElementById('reset-student-lottery-btn');
        const studentLotteryHistoryList= document.getElementById('lottery-history-list'); 

        if (resetStudentLotteryBtn) {
    resetStudentLotteryBtn.addEventListener('click', async () => { // ì—¬ê¸°ì— 'async' í‚¤ì›Œë“œ ì¶”ê°€
        // ì´ ë¶€ë¶„ì„ ëª¨ë‹¬ í˜¸ì¶œë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        const resetConfirm = await showCustomAlert('ì •ë§ë¡œ í•™ìƒ ë½‘ê¸° ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', true);

        if (resetConfirm) { // ì‚¬ìš©ìê°€ ëª¨ë‹¬ì—ì„œ 'í™•ì¸'ì„ ëˆŒë €ì„ ê²½ìš°
            // appData ê²½ë¡œê°€ ì˜¬ë°”ë¥¸ì§€ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”. (ì´ì „ ëŒ€í™”ì—ì„œ ì°¾ìœ¼ì‹  ê²½ë¡œ ì‚¬ìš©)
            if (appData && appData.lottery) {
                appData.lottery.studentHistory = [];
                appData.lottery.pickedStudents = [];  
                
                if (typeof debouncedSaveAppData === 'function') {
                    debouncedSaveAppData(); 
                } else {
                    console.warn('debouncedSaveAppData í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ê°€ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }

                if (studentLotteryHistoryList) {
                    studentLotteryHistoryList.innerHTML = '<p class="text-gray-500 text-center mt-4">í•™ìƒ ë½‘ê¸° ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
                }
            } else {
                // ì´ alertë„ showCustomAlertë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                showCustomAlert('í•™ìƒ ë½‘ê¸° ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì´ˆê¸°í™”í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); 
            }
        }
    });
}

        // ----------------------- ìˆ«ì ë½‘ê¸° ê²°ê³¼ ì´ˆê¸°í™” ê¸°ëŠ¥ -----------------------
        const resetNumberLotteryBtn = document.getElementById('reset-number-lottery-btn');
        const numberLotteryHistoryList = document.getElementById('number-lottery-history-list'); 

                if (resetNumberLotteryBtn) {
    resetNumberLotteryBtn.addEventListener('click', async () => { // ì—¬ê¸°ì— 'async' í‚¤ì›Œë“œ ì¶”ê°€
        // ì´ ë¶€ë¶„ì„ ëª¨ë‹¬ í˜¸ì¶œë¡œ ë³€ê²½í•©ë‹ˆë‹¤.
        const resetConfirm = await showCustomAlert('ì •ë§ë¡œ ìˆ«ì ë½‘ê¸° ê²°ê³¼ë¥¼ ì´ˆê¸°í™”í•˜ì‹œê² ìŠµë‹ˆê¹Œ? ì´ ì‘ì—…ì€ ë˜ëŒë¦´ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', true);

        if (resetConfirm) { // ì‚¬ìš©ìê°€ ëª¨ë‹¬ì—ì„œ 'í™•ì¸'ì„ ëˆŒë €ì„ ê²½ìš°
            // appData ê²½ë¡œê°€ ì˜¬ë°”ë¥¸ì§€ ë‹¤ì‹œ í™•ì¸í•˜ì„¸ìš”. (ì´ì „ ëŒ€í™”ì—ì„œ ì°¾ìœ¼ì‹  ê²½ë¡œ ì‚¬ìš©)
            if (appData && appData.lottery) {
                appData.lottery.numberHistory = [];
                appData.lottery.pickedNumbers = [];
                
                if (typeof debouncedSaveAppData === 'function') {
                    debouncedSaveAppData(); 
                } else {
                    console.warn('debouncedSaveAppData í•¨ìˆ˜ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ë°ì´í„°ê°€ ì €ì¥ë˜ì§€ ì•Šì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.');
                }

                if (numberLotteryHistoryList) {
                    numberLotteryHistoryList.innerHTML = '<p class="text-gray-500 text-center mt-4">ìˆ«ì ë½‘ê¸° ê²°ê³¼ê°€ ì´ˆê¸°í™”ë˜ì—ˆìŠµë‹ˆë‹¤.</p>';
                }
            } else {
                // ì´ alertë„ showCustomAlertë¡œ ë³€ê²½í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
                showCustomAlert('ìˆ«ì ë½‘ê¸° ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ì´ˆê¸°í™”í•  ë‚´ìš©ì´ ì—†ìŠµë‹ˆë‹¤.'); 
            }
        }
    });
}
        // ----------------------------------------------------------------------
    }); // <--- ì´ ìƒˆë¡œìš´ DOMContentLoaded ë¸”ë¡ì˜ ë‹«ëŠ” ê´„í˜¸
    </script>
    <div id="customModalOverlay" class="modal-overlay hidden">
    <div class="modal-content">
        <p id="modalMessage"></p>
        <div class="modal-actions">
            <button id="modalConfirmBtn" class="modal-button confirm">í™•ì¸</button>
            <button id="modalCancelBtn" class="modal-button cancel hidden">ì·¨ì†Œ</button>
        </div>
    </div>
</div>
<script>
(function(){
  // ì•ˆì „í•˜ê²Œ appData.calendar ì´ˆê¸°í™”
  window.appData = window.appData || {};
  window.appData.calendar = window.appData.calendar || {};

  // ë‹¬ë ¥ ìƒíƒœ
  const now = new Date();
  let viewYear = now.getFullYear();
  let viewMonth = now.getMonth(); // 0-based

  const calendarContainer = document.getElementById('calendar-container');
  const monthLabel = document.getElementById('calendar-current-month');
  const prevBtn = document.getElementById('prev-month');
  const nextBtn = document.getElementById('next-month');
  const todayBtn = document.getElementById('today-btn');

  function pad(n){ return n < 10 ? '0'+n : ''+n; }
  function toKey(y, m, d){ // m: 1~12 expected
    return `${y}-${pad(m)}-${pad(d)}`;
  }

  function renderCalendar(year, monthZeroBased){
    if (!calendarContainer || !monthLabel) return;
        viewYear = year; viewMonth = monthZeroBased;
        const today = new Date();
        const todayKey = toKey(today.getFullYear(), today.getMonth() + 1, today.getDate());
        const firstDay = new Date(year, monthZeroBased, 1);
        const lastDay = new Date(year, monthZeroBased + 1, 0);
        const startWeek = firstDay.getDay(); // 0(ì¼)~6(í† )
        const totalDays = lastDay.getDate();

        monthLabel.textContent = `${year}ë…„ ${monthZeroBased+1}ì›”`;

        // í•­ìƒ ìµœì‹  calendar ì°¸ì¡°
        const calendar = window.appData && window.appData.calendar ? window.appData.calendar : {};

        // í…Œì´ë¸” ìƒì„±
        const tbl = document.createElement('table');
        tbl.className = 'calendar-table';
        const thead = document.createElement('thead');
        const headerRow = document.createElement('tr');
        ['ì¼','ì›”','í™”','ìˆ˜','ëª©','ê¸ˆ','í† '].forEach(h=>{
            const th=document.createElement('th'); th.textContent=h; headerRow.appendChild(th);
        });
        thead.appendChild(headerRow);
        tbl.appendChild(thead);

        const tbody = document.createElement('tbody');
    let row = document.createElement('tr');

    // ë¹ˆì¹¸
    for(let i=0;i<startWeek;i++){ row.appendChild(document.createElement('td')); }

    for(let day=1; day<=totalDays; day++){
        const dow = new Date(year, monthZeroBased, day).getDay();
        const td = document.createElement('td');

        const dayBox = document.createElement('div');
        dayBox.className = 'calendar-day';
        const dateNum = document.createElement('div');
        dateNum.className = 'date-num';
        dateNum.textContent = day;
        dayBox.appendChild(dateNum);

        const key = toKey(year, monthZeroBased+1, day);
        if (key === todayKey) {
            dayBox.classList.add('today');
        }
        // í•­ìƒ ìµœì‹  calendar ì°¸ì¡°
        const calendar = window.appData && window.appData.calendar ? window.appData.calendar : {};
        let events = calendar[key];
        // ë§ˆì´ê·¸ë ˆì´ì…˜: ê¸°ì¡´ì— ê°ì²´ë¡œ ì €ì¥ë¼ ìˆë˜ ë°ì´í„°ê°€ ìˆìœ¼ë©´ ë°°ì—´ë¡œ ë°”ê¿”ë‘¡ë‹ˆë‹¤.
        if (events && !Array.isArray(events)) {
            events = [events];
            calendar[key] = events;
        }
        events = events || [];

        if (events.length > 0) {
            dayBox.classList.add('has-event');

            const maxToShow = 3; // í•œ ì¹¸ì— ë³´ì¼ ìµœëŒ€ ì¼ì • ê°œìˆ˜
            events.slice(0, maxToShow).forEach(ev => {
                const titleSpan = document.createElement('div');
                titleSpan.className = 'small-event';
                titleSpan.textContent = ev.time ? (ev.time + ' ' + ev.title) : ev.title;
                if (ev.description) titleSpan.title = ev.description;
                // â˜… ì™„ë£Œ ìƒíƒœ ë°˜ì˜
                if (ev.done) {
                    titleSpan.classList.add('done'); // CSS .small-event.done ì€ ì´ë¯¸ íŒŒì¼ì— ì •ì˜ë˜ì–´ ìˆìŠµë‹ˆë‹¤.
                    titleSpan.textContent = 'âœ” ' + titleSpan.textContent;
                }
                dayBox.appendChild(titleSpan);
            });

            if (events.length > maxToShow) {
                const more = document.createElement('div');
                more.className = 'small-event';
                more.style.opacity = '0.85';
                more.textContent = `+${events.length - maxToShow} ë”ë³´ê¸°`;
                dayBox.appendChild(more);
            }
        }


      dayBox.addEventListener('click', ()=> openEventModalForDate(year, monthZeroBased+1, day));
      td.appendChild(dayBox);
      row.appendChild(td);

      if(dow === 6){
        tbody.appendChild(row);
        row = document.createElement('tr');
      }
    }

    // ë§ˆì§€ë§‰ ì£¼ ë¹ˆì¹¸ ì±„ìš°ê¸°
    if(row.children.length > 0){
      while(row.children.length < 7){ row.appendChild(document.createElement('td')); }
      tbody.appendChild(row);
    }

    // ë Œë”
    calendarContainer.innerHTML = '';
    tbl.appendChild(tbody);
    calendarContainer.appendChild(tbl);
  }

// ëª¨ë‹¬ ìš”ì†Œ
const modal = document.getElementById('calendar-event-modal');
const modalDateTitle = document.getElementById('modal-date-title');
const inputTitle = document.getElementById('event-title');
const inputDesc = document.getElementById('event-description');
const inputTime = document.getElementById('event-time');
const addBtn = document.getElementById('add-event-btn');
const deleteAllBtn = document.getElementById('delete-all-events-btn');
const closeModalBtn = document.getElementById('close-event-modal-btn');
const eventListEl = document.getElementById('event-list');

let activeKey = null;

function generateEventId(){
  return (typeof crypto !== 'undefined' && crypto.randomUUID) ? crypto.randomUUID() : 'evt-' + Date.now() + '-' + Math.floor(Math.random()*10000);
}
function getCalendarEvents(key){
  if (!window.appData.calendar) window.appData.calendar = {};
  const val = window.appData.calendar[key];
  if (!val) return [];
  if (Array.isArray(val)) return val;
  const newArr = [val];
  window.appData.calendar[key] = newArr;
  return newArr;
}
function setCalendarEvents(key, events){
  if (!events || events.length === 0){
    delete window.appData.calendar[key];
  } else {
    window.appData.calendar[key] = events;
  }
}
function renderEventList(){
  eventListEl.innerHTML = '';
  const events = getCalendarEvents(activeKey);
  if (events.length === 0){
    eventListEl.innerHTML = '<p class="text-gray-500 text-sm">í•´ë‹¹ ë‚ ì§œì— ì¼ì •ì´ ì—†ìŠµë‹ˆë‹¤.</p>';
    return;
  }
  events.forEach(ev => {
    const item = document.createElement('div');
    item.className = 'flex items-start justify-between mb-2 p-2 rounded bg-white shadow-sm';

    // ì²´í¬ë°•ìŠ¤ (To-do)
    const check = document.createElement('input');
    check.type = 'checkbox';
    check.checked = !!ev.done;
    check.className = 'mr-2 mt-1 checkbox-large';
    check.style.transformOrigin = 'center';
    check.style.marginRight = '8px';
    check.addEventListener('change', () => {
      ev.done = check.checked;
      setCalendarEvents(activeKey, events);
      if (typeof debouncedSaveAppData === 'function') debouncedSaveAppData();
      renderEventList();
      renderCalendar(viewYear, viewMonth);
    });

    // ì™¼ìª½: ì œëª©/ì‹œê°„/ì„¤ëª…
    const left = document.createElement('div');
    left.style.flex = '1';
    left.innerHTML = `<div class="font-semibold">${ev.time ? ev.time + ' ' : ''}${ev.title}</div>
                      <div class="text-xs text-gray-600">${ev.description ? ev.description : ''}</div>`;

    // ì™„ë£Œ í‘œì‹œ ìŠ¤íƒ€ì¼
    if (ev.done) {
      left.style.textDecoration = 'line-through';
      left.style.opacity = '0.6';
    }

    // ì œëª© í´ë¦­ ì‹œ ìˆ˜ì •
    left.addEventListener('click', () => {
      inputTitle.value = ev.title;
      inputDesc.value = ev.description || '';
      inputTime.value = ev.time || '';
      addBtn.textContent = 'ìˆ˜ì •';
      addBtn.onclick = () => {
        ev.title = inputTitle.value.trim();
        ev.description = inputDesc.value.trim();
        ev.time = inputTime.value;
        setCalendarEvents(activeKey, events);
        if (typeof debouncedSaveAppData === 'function') debouncedSaveAppData();
        renderEventList();
        renderCalendar(viewYear, viewMonth);
        if (typeof updateDdayDisplay === 'function') updateDdayDisplay();
        // ì…ë ¥ ì´ˆê¸°í™”
        inputTitle.value = '';
        inputDesc.value = '';
        inputTime.value = '';
        addBtn.textContent = 'ì¶”ê°€';
        addBtn.onclick = addCalendarEventFromModal;
      };
    });

    // ì‚­ì œ ë²„íŠ¼
    const delBtn = document.createElement('button');
    delBtn.className = 'btn-danger text-white px-2 py-1 rounded ml-2';
    delBtn.textContent = 'ì‚­ì œ';
    delBtn.addEventListener('click', () => {
      if (!confirm('ì´ ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;
      deleteCalendarEvent(activeKey, ev.id);
    });

    item.appendChild(check);
    item.appendChild(left);
    item.appendChild(delBtn);
    eventListEl.appendChild(item);
  });
}
function openEventModalForDate(y, m, d){
  activeKey = toKey(y, m, d);
  if (!window.appData.calendar) window.appData.calendar = {};
  const current = window.appData.calendar[activeKey];
  if (current && !Array.isArray(current)){
    window.appData.calendar[activeKey] = [current];
  } else if (!current){
    window.appData.calendar[activeKey] = [];
  }
  modalDateTitle.textContent = `${y}ë…„ ${m}ì›” ${d}ì¼ ì¼ì •`;
  inputTitle.value = '';
  inputDesc.value = '';
  inputTime.value = '';
  renderEventList();
  modal.style.display = 'flex';
}
function addCalendarEventFromModal(){
  const title = inputTitle.value.trim();
  if (!title){ alert('ì œëª©ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.'); return; }
  const description = inputDesc.value.trim();
  const time = inputTime.value;
  const events = getCalendarEvents(activeKey);
  events.push({ id: generateEventId(), title, description, time, done: false });
  setCalendarEvents(activeKey, events);
  if (typeof debouncedSaveAppData === 'function') debouncedSaveAppData();
  renderEventList();
  renderCalendar(viewYear, viewMonth);
  if (typeof updateDdayDisplay === 'function') updateDdayDisplay();
  inputTitle.value = '';
  inputDesc.value = '';
  inputTime.value = '';
}
function deleteCalendarEvent(key, id){
  const events = getCalendarEvents(key).filter(ev => ev.id !== id);
  setCalendarEvents(key, events);
  if (typeof debouncedSaveAppData === 'function') debouncedSaveAppData();
  renderEventList();
  renderCalendar(viewYear, viewMonth);
  if (typeof updateDdayDisplay === 'function') updateDdayDisplay();
}
deleteAllBtn.addEventListener('click', () => {
  if (!activeKey) return;
  if (!window.appData.calendar || !window.appData.calendar[activeKey]) { modal.style.display = 'none'; return; }
  if (confirm('í•´ë‹¹ ë‚ ì§œì˜ ëª¨ë“  ì¼ì •ì„ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
    delete window.appData.calendar[activeKey];
    if (typeof debouncedSaveAppData === 'function') debouncedSaveAppData();
    modal.style.display = 'none';
    renderCalendar(viewYear, viewMonth);
  }
});
addBtn.onclick = addCalendarEventFromModal;
closeModalBtn.addEventListener('click', ()=>{ modal.style.display = 'none'; });
window.addEventListener('click', (e)=>{ if(e.target === modal) modal.style.display = 'none'; });


  // ëª¨ë‹¬ ë°”ê¹¥ í´ë¦­ìœ¼ë¡œ ë‹«ê¸°
  window.addEventListener('click', (e)=>{ if(e.target === modal) modal.style.display = 'none'; });

  // prev/next/today
  prevBtn.addEventListener('click', ()=>{
    let y = viewYear; let m = viewMonth - 1;
    if(m < 0){ m = 11; y--; }
    renderCalendar(y, m);
  });
  nextBtn.addEventListener('click', ()=>{
    let y = viewYear; let m = viewMonth + 1;
    if(m > 11){ m = 0; y++; }
    renderCalendar(y, m);
  });
  todayBtn.addEventListener('click', ()=>{ const t = new Date(); renderCalendar(t.getFullYear(), t.getMonth()); });

  // ì´ˆê¸° ë Œë”
  document.addEventListener('DOMContentLoaded', ()=>{ setTimeout(()=> renderCalendar(viewYear, viewMonth), 150); });

  // ë‚´ë³´ë‚´ê¸°(ë‹¤ë¥¸ ìŠ¤í¬ë¦½íŠ¸ì—ì„œ í˜¸ì¶œí•  ê²½ìš°ìš©)
  window.renderCalendar = renderCalendar;
})();
// ì•ˆì „í•˜ê²Œ key, dayBox, evê°€ ì •ì˜ëœ ê²½ìš°ì—ë§Œ ì‹¤í–‰
try {
    const todayKey = window.toKey(new Date().getFullYear(), new Date().getMonth()+1, new Date().getDate());
    if (typeof key !== 'undefined' && typeof dayBox !== 'undefined' && key === todayKey) {
        dayBox.classList.add('today');
    }
    if (typeof ev !== 'undefined' && typeof dayBox !== 'undefined' && ev) {
        const titleSpan = document.createElement('span');
        titleSpan.className = 'small-event';
        titleSpan.textContent = ev.title && ev.title.length > 10 ? ev.title.slice(0,10)+'â€¦' : ev.title;
        dayBox.appendChild(titleSpan);
        dayBox.classList.add('has-event');
    }
} catch(e) {
    // ë¬´ì‹œ: ë Œë”ë§ ì»¨í…ìŠ¤íŠ¸ê°€ ì•„ë‹ ë•Œ ì˜¤ë¥˜ ë°©ì§€ìš©
}
</script>
</body>
</html>